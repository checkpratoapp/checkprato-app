<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CheckPrato ‚Ä¢ Elite</title>

  <meta name="theme-color" content="#0a1320"/>
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" sizes="192x192" href="./icon-192.png">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <!-- Chart.js (Evolu√ß√£o) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#07121f;
      --bg2:#0b2033;
      --card:rgba(255,255,255,.04);
      --stroke:rgba(255,255,255,.08);
      --txt:#eaf2ff;
      --muted:rgba(234,242,255,.72);
      --green:#21e6b6;
      --green2:#17caa0;
      --orange:#f6b23a;
      --shadow:0 20px 60px rgba(0,0,0,.45);
      --r:22px;
      --max:560px;

      --glass: rgba(255,255,255,.06);
      --stroke3d: rgba(255,255,255,.10);
      --shadow3d: 0 24px 70px rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    html, body{
      height:100%;
      margin:0;
      padding:0;
      background: var(--bg);
      color: var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow-x:hidden;
    }
    body{
      padding-bottom: calc(92px + env(safe-area-inset-bottom));
    }

    a{ color: var(--green); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .wrap{ max-width: var(--max); margin: 0 auto; padding: 16px 14px 24px; }

    .topbar{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:6px;
      margin-bottom: 14px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(33,230,182,.35), rgba(33,230,182,.05));
      border:1px solid rgba(33,230,182,.35);
      display:flex;align-items:center;justify-content:center;
      font-weight:1000;
      color:var(--green);
      box-shadow: var(--shadow);
      flex:0 0 auto;
      overflow:hidden;
    }
    .brand{
      display:flex;flex-direction:column;gap:2px;
      min-width: 0;
      flex: 1 1 auto;
    }
    .brand small{color:var(--muted); letter-spacing:.08em; font-weight:900}
    .brand b{font-size:18px}

    .pill{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--stroke);
      color:var(--muted);
      font-weight:800;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .pill .dot{
      width:10px;height:10px;border-radius:99px;background:var(--green);
      box-shadow: 0 0 0 6px rgba(33,230,182,.12);
    }

    .h1{
      font-size:34px;
      margin:12px 2px 14px;
      letter-spacing:.02em;
      color:var(--green);
      font-weight: 1000;
      line-height: 1.05;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .hint{ color: var(--muted); font-weight: 650; line-height: 1.35; }
    .muted{ opacity:.85; }

    .row{display:flex; gap:12px; flex-wrap:wrap}
    .col{flex:1 1 140px; min-width: 140px}

    .label{
      margin: 12px 2px 6px;
      color: rgba(234,242,255,.65);
      font-weight: 950;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-size: 12px;
    }

    input, select, textarea{
      width:100%;
      padding:14px 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      outline: none;
      font-size: 15px;
    }
    textarea{ min-height: 90px; resize: vertical; }
    input::placeholder{color: rgba(234,242,255,.35)}
    select{appearance:none}

    .btn{
      width:100%;
      padding: 16px 16px;
      border-radius: 18px;
      border: 0;
      cursor: pointer;
      font-weight: 950;
      font-size: 16px;
      letter-spacing: .02em;
      background: linear-gradient(135deg, var(--green), var(--green2));
      color:#042019;
      box-shadow: 0 18px 45px rgba(33,230,182,.18);
      margin-top: 14px;
    }
    .btnSecondary{
      width:100%;
      padding: 14px 16px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      cursor: pointer;
      font-weight: 900;
      font-size: 15px;
      background: rgba(255,255,255,.05);
      color: var(--txt);
      margin-top: 10px;
    }

    .status{
      margin-top: 10px;
      font-weight: 800;
      color: rgba(234,242,255,.86);
    }

    /* chips */
    .chips{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;}
    .chip{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-weight: 900;
      cursor: pointer;
      user-select: none;
    }
    .chip.on{
      border-color: rgba(33,230,182,.45);
      background: rgba(33,230,182,.12);
      color: var(--txt);
      box-shadow: 0 0 0 6px rgba(33,230,182,.08);
    }

    /* screens */
    .screen{ display:none; margin-top: 8px; width:100%; background: var(--bg); padding-bottom: calc(140px + env(safe-area-inset-bottom)); }
    .screen.active{ display:block; }

    /* nav */
    .nav{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: #07121f;
      border-top: 1px solid rgba(255,255,255,.08);
      z-index: 1000;
    }
    .navInner{
      max-width: var(--max);
      margin: 0 auto;
      display:flex;
      gap:10px;
      overflow-x: auto;
      padding: 6px 6px;
      scrollbar-width: none;
    }
    .navInner::-webkit-scrollbar{ display:none; }
    .navBtn{
      flex:0 0 auto;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color: rgba(234,242,255,.6);
      font-weight: 950;
      padding: 12px 14px;
      border-radius: 999px;
      cursor:pointer;
      letter-spacing:.05em;
      white-space: nowrap;
    }
    .navBtn.active{
      background: rgba(33,230,182,.12);
      border-color: rgba(33,230,182,.35);
      color: var(--green);
      box-shadow: 0 0 0 6px rgba(33,230,182,.08);
    }

    /* bot√£o topo */
    #btnTop{
      position:fixed;
      bottom:110px;
      right:18px;
      width:48px;
      height:48px;
      border-radius:50%;
      border:none;
      background:linear-gradient(135deg,#21e6b6,#17caa0);
      color:#042019;
      font-size:22px;
      font-weight:900;
      box-shadow:0 10px 25px rgba(0,0,0,.4);
      display:none;
      z-index:999;
      cursor:pointer;
    }

    /* ===== Welcome ===== */
    .welcomeHero{
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(700px 280px at 20% 10%, rgba(33,230,182,.18), transparent 60%),
        radial-gradient(600px 260px at 80% 30%, rgba(246,178,58,.14), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
      padding: 16px;
      overflow:hidden;
    }
    .wCarousel{
      position: relative;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      overflow: hidden;
      min-height: 260px;
    }
    .wSlide{ display:none; padding: 18px 16px 16px; min-height: 260px; position: relative; }
    .wSlide.active{ display:block; }
    .wBg{
      position:absolute; inset:0;
      opacity:.9;
      background:
        radial-gradient(900px 340px at 20% 20%, rgba(33,230,182,.22), transparent 60%),
        radial-gradient(800px 360px at 80% 30%, rgba(246,178,58,.16), transparent 62%),
        radial-gradient(700px 380px at 45% 110%, rgba(33,230,182,.10), transparent 62%);
      pointer-events:none;
    }
    .wTop{ position:relative; display:flex; align-items:center; justify-content:space-between; gap:10px; z-index:1; }
    .wBadge{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(234,242,255,.78);
      font-weight: 950; letter-spacing:.06em; text-transform: uppercase; font-size: 12px;
    }
    .wDots{ display:flex; gap:8px; align-items:center; }
    .wDot{
      width:10px;height:10px;border-radius:99px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      cursor:pointer;
    }
    .wDot.on{
      background: rgba(33,230,182,.40);
      border-color: rgba(33,230,182,.55);
      box-shadow: 0 0 0 6px rgba(33,230,182,.10);
    }
    .wTitle{ position:relative; z-index:1; margin-top: 14px; font-size: 26px; font-weight: 1000; line-height: 1.1; }
    .wText{ position:relative; z-index:1; margin-top: 10px; color: rgba(234,242,255,.85); font-weight: 750; line-height: 1.45; }
    .wQuote{
      position:relative; z-index:1; margin-top: 12px;
      padding: 12px 12px; border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(234,242,255,.88);
      font-weight: 850;
    }
    .wNavRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px; }
    .wMini{
      flex:1 1 160px;
      padding: 14px 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--txt);
      font-weight: 950;
      cursor:pointer;
    }

    /* ===== Prato ===== */
    .platePreview{
      width:100%;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
      overflow:hidden;
      margin-top: 12px;
    }
    .platePreview img{ width:100%; display:block; }

    .miniRow{ display:flex; gap:10px; flex-wrap:wrap }
    .miniBtn{
      flex:1 1 160px;
      padding:14px 14px;
      border-radius:18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--txt);
      font-weight: 900;
      cursor:pointer;
    }

    .scoreBox{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 14px; border-radius: 22px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
      margin-top: 12px;
    }
    .scoreBox b{ font-size: 22px; color: #ffd38a; }
    .pillSmall{
      padding: 8px 10px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(234,242,255,.85);
      font-weight: 900;
      white-space:nowrap;
      font-size: 12px;
    }

    /* ===== Dieta / cards ===== */
    .meal{
      display:flex; justify-content:space-between; gap:12px;
      padding: 16px; border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      margin-top: 12px;
    }
    .meal .title{
      font-weight: 950; color: var(--green);
      letter-spacing:.08em; text-transform: uppercase;
      font-size: 12px; margin-bottom: 6px;
    }
    .meal p{margin:0; color: rgba(234,242,255,.88); font-weight:750; line-height:1.35}
    .kcal{
      display:flex; align-items:center; justify-content:center;
      min-width: 88px;
      border-radius: 999px;
      border:1px solid rgba(33,230,182,.25);
      background: rgba(33,230,182,.08);
      color: var(--green);
      font-weight: 1000;
      padding: 10px 12px;
      text-align:center;
    }

    /* ===== Treino ===== */
    .dayCard{
      margin-top: 12px;
      padding: 14px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .dayTitle{
      display:flex; align-items:center; justify-content:space-between;
      font-weight: 1000;
      color: rgba(234,242,255,.92);
      margin-bottom: 10px;
      letter-spacing:.03em;
    }
    .exercise{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding: 12px 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      margin-top: 10px;
    }
    .ytBtn{
      border:0;
      border-radius: 999px;
      padding: 10px 12px;
      background: rgba(33,230,182,.10);
      border: 1px solid rgba(33,230,182,.25);
      color: var(--green);
      font-weight: 1000;
      cursor: pointer;
      min-width: 110px;
    }

    /* ===== Parceiros ===== */
    .partnerList{display:flex; flex-direction:column; gap:12px; margin-top:12px}
    .partnerRow{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px; border-radius:18px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
    }
    .partnerName{display:flex; flex-direction:column; gap:4px}
    .partnerName b{font-weight: 1000}

    /* ===== Modal ===== */
    .modalBack{
      display:none;
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      z-index: 2000;
      padding: 20px;
      overflow:auto;
    }
    .modal{
      max-width: 560px;
      margin: 40px auto;
      background: #0b1726;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      box-shadow: 0 25px 80px rgba(0,0,0,.55);
      padding: 16px;
    }
    .modal h3{ margin: 0 0 10px; }
    .modal .closeRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .xBtn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 900;
      cursor:pointer;
    }

    /* ===== Dashboard 3D (Progresso) ===== */
    .pro3dWrap{ perspective: 1200px; }
    .pro3dCard{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border: 1px solid var(--stroke3d);
      border-radius: 26px;
      box-shadow: var(--shadow3d);
      transform: rotateX(7deg) rotateY(-6deg);
      transform-style: preserve-3d;
      overflow:hidden;
      position: relative;
    }
    .pro3dCard:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 260px at 20% 10%, rgba(33,230,182,.18), transparent 60%),
        radial-gradient(520px 260px at 80% 30%, rgba(246,178,58,.14), transparent 60%),
        radial-gradient(700px 340px at 40% 100%, rgba(33,230,182,.10), transparent 62%);
      pointer-events:none;
    }
    .proTop{ display:flex; align-items:center; justify-content:space-between; padding:16px 16px 0; position: relative; z-index: 1; }
    .proTitle{
      font-size: 26px;
      font-weight: 1000;
      letter-spacing: .02em;
      margin: 10px 16px 12px;
      color: rgba(234,242,255,.95);
      position: relative; z-index: 1;
    }
    .proGrid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 12px;
      padding: 0 16px 16px;
      position: relative; z-index: 1;
    }
    .proPanel{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
      padding: 14px;
      transform: translateZ(18px);
    }
    .proRingBox{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap: 10px; min-height: 240px; }
    .ring{ width: 180px; height: 180px; position: relative; transform: translateZ(26px); }
    .ring svg{ width: 100%; height: 100%; transform: rotate(-90deg); filter: drop-shadow(0 20px 40px rgba(0,0,0,.55)); }
    .ringCenter{
      position:absolute; inset: 0;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      text-align:center; gap: 2px;
    }
    .ringPct{ font-size: 44px; font-weight: 1000; color: #ffd38a; text-shadow: 0 10px 30px rgba(0,0,0,.45); }
    .ringSub{ color: rgba(234,242,255,.72); font-weight: 900; }

    .proStats{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      padding: 0 16px 16px;
      position: relative; z-index: 1;
    }
    .stat3d{
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      padding: 12px;
      transform: translateZ(14px);
    }
    .stat3d .num{ font-size: 24px; font-weight: 1000; color: rgba(234,242,255,.95); }
    .stat3d .lab{
      margin-top: 2px;
      color: rgba(234,242,255,.65);
      font-weight: 850;
      font-size: 12px;
      letter-spacing:.08em;
      text-transform: uppercase;
    }
    .proHint{ padding: 0 16px 16px; color: rgba(234,242,255,.65); font-weight: 800; position: relative; z-index: 1; }

    /* ===== Evolu√ß√£o / Gamifica√ß√£o ===== */
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .pill2{
      padding: 10px 12px; border-radius: 18px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      font-weight: 900;
      color: rgba(234,242,255,.9);
    }
    .bar{
      width:100%; height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      margin-top: 8px;
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(135deg, rgba(33,230,182,.95), rgba(23,202,160,.85));
    }
    .badgeRow{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .badge{
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-weight: 900;
      color: rgba(234,242,255,.9);
      white-space:nowrap;
    }
    .badge.ok{
      border-color: rgba(33,230,182,.35);
      background: rgba(33,230,182,.10);
      color: var(--txt);
      box-shadow: 0 0 0 6px rgba(33,230,182,.06);
    }
    .chartBox{
      margin-top: 12px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
      padding: 12px;
      overflow:hidden;
    }

    @media (min-width: 900px){
      .wrap{ max-width: 900px; }
      .proGrid{ grid-template-columns: 1fr 1fr; }
      .ring{ width: 210px; height: 210px; }
      .pro3dCard{ transform: rotateX(6deg) rotateY(-4deg); }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="logo">E</div>
      <div class="brand">
        <small>ELITE TERMINAL</small>
        <b>CheckPrato ‚Ä¢ Elite</b>
      </div>
      <div class="pill"><span class="dot"></span><span id="authTxt">Modo: Local</span></div>
    </div>

    <!-- BOAS-VINDAS -->
    <section id="viewWelcome" class="screen active">
      <div class="h1">BEM-VINDO</div>

      <div class="welcomeHero">
        <div class="hint">
          Seu painel de <b>dieta</b>, <b>treino</b>, <b>prato</b> e <b>evolu√ß√£o</b>.
          Um sistema que cria consist√™ncia ‚Äî e consist√™ncia muda o jogo.
        </div>

        <div class="wCarousel" style="margin-top:12px">
          <div class="wSlide active" data-slide="0">
            <div class="wBg"></div>
            <div class="wTop">
              <div class="wBadge">üî• Consist√™ncia</div>
              <div class="wDots" id="wDots"></div>
            </div>
            <div class="wTitle">Pequenas escolhas<br>mudam tudo.</div>
            <div class="wText">Voc√™ n√£o precisa de perfei√ß√£o. Precisa de dire√ß√£o.</div>
            <div class="wQuote">‚ÄúHoje eu s√≥ preciso vencer o hoje.‚Äù</div>
          </div>

          <div class="wSlide" data-slide="1">
            <div class="wBg"></div>
            <div class="wTop">
              <div class="wBadge">ü•ó Prato</div>
              <div class="wDots"></div>
            </div>
            <div class="wTitle">Controle sem neura.</div>
            <div class="wText">Foto, registro, pontua√ß√£o e padr√£o. Fica claro o que funciona.</div>
            <div class="wQuote">‚ÄúO que √© medido, melhora.‚Äù</div>
          </div>

          <div class="wSlide" data-slide="2">
            <div class="wBg"></div>
            <div class="wTop">
              <div class="wBadge">üèÜ Evolu√ß√£o</div>
              <div class="wDots"></div>
            </div>
            <div class="wTitle">N√≠vel, streak,<br>medalhas.</div>
            <div class="wText">Voc√™ joga a favor da sua sa√∫de. Sem depender de motiva√ß√£o.</div>
            <div class="wQuote">‚ÄúDisciplina √© uma habilidade.‚Äù</div>
          </div>
        </div>

        <div class="wNavRow">
          <button class="btn" type="button" onclick="goCadastro()">Come√ßar agora</button>
          <button class="btnSecondary" type="button" onclick="goManual()">Ver manual</button>
        </div>
      </div>
    </section>

    <!-- MANUAL (fora da nav principal, acessa pelo Welcome/Perfil) -->
    <section id="viewManual" class="screen">
      <div class="h1">MANUAL</div>
      <div class="card">
        <div class="hint">
          Guia r√°pido pra usar o CheckPrato do jeito certo.
          <br><br>
          <b>Importante:</b> as sugest√µes s√£o informativas. Para condi√ß√µes espec√≠ficas, procure um profissional.
        </div>

        <div class="label">Como come√ßar</div>
        <div class="meal">
          <div>
            <div class="title">1) Cadastro</div>
            <p>Preencha objetivo, n√≠vel, restri√ß√£o e metas (prote√≠na). Isso melhora as recomenda√ß√µes.</p>
          </div>
        </div>
        <div class="meal">
          <div>
            <div class="title">2) Prato</div>
            <p>Tire foto, registre e confirme. O app cria seu padr√£o e seu score melhora com o tempo.</p>
          </div>
        </div>
        <div class="meal">
          <div>
            <div class="title">3) Evolu√ß√£o</div>
            <p>Acompanhe o gr√°fico, streak e medalhas. A const√¢ncia vira ‚Äúautom√°tica‚Äù.</p>
          </div>
        </div>

        <button class="btnSecondary" type="button" onclick="goCadastro()">Ir para Cadastro</button>
      </div>
    </section>

    <!-- CADASTRO -->
    <section id="viewCadastro" class="screen">
      <div class="h1">CADASTRO</div>

      <div class="card">
        <div class="label">Foto do perfil</div>
        <div class="row" style="align-items:center">
          <div style="width:64px;height:64px;border-radius:18px;overflow:hidden;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.2)">
            <img id="avatarImg" alt="Foto" style="width:100%;height:100%;object-fit:cover;display:none"/>
            <div id="avatarFallback" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:1000;color:rgba(234,242,255,.7)">üë§</div>
          </div>
          <div style="flex:1">
            <button class="btnSecondary" type="button" onclick="pickAvatar()">Escolher foto</button>
            <input id="avatarFile" type="file" accept="image/*" style="display:none">
            <div class="hint" style="margin-top:6px">Salvo no aparelho.</div>
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <div class="col">
            <div class="label">Nome</div>
            <input id="nome" placeholder="Ex: Seu nome" />
          </div>
          <div class="col">
            <div class="label">Email (opcional)</div>
            <input id="emailPerfil" inputmode="email" placeholder="Ex: voce@gmail.com" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="label">Peso (kg)</div>
            <input id="peso" inputmode="decimal" placeholder="Ex: 78,5" />
          </div>
          <div class="col">
            <div class="label">Altura (cm)</div>
            <input id="altura" inputmode="numeric" placeholder="Ex: 175" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="label">Objetivo</div>
            <select id="objetivo">
              <option value="">Selecione</option>
              <option>Emagrecer</option>
              <option>Ganhar massa</option>
              <option>Manter</option>
              <option>Performance</option>
            </select>
          </div>
          <div class="col">
            <div class="label">N√≠vel</div>
            <select id="nivel">
              <option value="">Selecione</option>
              <option>Iniciante</option>
              <option>Intermedi√°rio</option>
              <option>Avan√ßado</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="label">Condi√ß√£o</div>
            <select id="condicao">
              <option value="">Selecione</option>
              <option>Saud√°vel</option>
              <option>Hipertens√£o</option>
              <option>Diabetes</option>
              <option>Les√£o / Dor</option>
            </select>
          </div>
          <div class="col">
            <div class="label">Restri√ß√£o</div>
            <select id="restricao">
              <option value="">Selecione</option>
              <option>Nenhuma</option>
              <option>Lactose</option>
              <option>Gl√∫ten</option>
              <option>Vegetariano</option>
              <option>Vegano</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="label">Meta de prote√≠na (g/dia)</div>
            <input id="metaProt" inputmode="numeric" placeholder="Ex: 140" />
          </div>
          <div class="col">
            <div class="label">Meta de dias treino/semana</div>
            <input id="metaDias" inputmode="numeric" placeholder="Ex: 5" />
          </div>
        </div>

        <div class="label">Esportes (pode marcar v√°rios)</div>
        <div id="chipsEsportes" class="chips"></div>

        <div style="margin-top:10px">
          <label style="display:flex; gap:10px; align-items:center; font-weight:900; color:rgba(234,242,255,.9)">
            <input id="termo" type="checkbox" style="width:22px; height:22px"/>
            Li e aceito (conte√∫do informativo)
          </label>
        </div>

        <button class="btn" type="button" onclick="salvarCadastro()">SALVAR</button>
        <button class="btnSecondary" type="button" onclick="limparCadastro()">LIMPAR</button>

        <div id="outCadastro" class="status" style="display:none"></div>
      </div>
    </section>

    <!-- PERFIL -->
    <section id="viewPerfil" class="screen">
      <div class="h1">PERFIL</div>

      <div class="card">
        <div class="hint">Seu status e seus n√∫meros.</div>
        <div id="perfilBox" class="status" style="margin-top:12px">‚Äî</div>

        <div class="row" style="margin-top:10px">
          <div class="col">
            <button class="btnSecondary" type="button" onclick="goManual()">Abrir manual</button>
          </div>
          <div class="col">
            <button class="btnSecondary" type="button" onclick="resetAllData()">Zerar dados (local)</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PRATO -->
    <section id="viewPrato" class="screen">
      <div class="h1">PRATO</div>

      <div class="card">
        <div class="hint">
          Tire foto e registre. Voc√™ pode ajustar descri√ß√£o e macros. O app aprende com suas confirma√ß√µes (no seu aparelho).
        </div>

        <div class="miniRow" style="margin-top:12px">
          <button class="miniBtn" type="button" id="btnCamera">Tirar foto</button>
          <button class="miniBtn" type="button" id="btnGaleria">Escolher da galeria</button>
        </div>

        <input id="fileCamera" type="file" accept="image/*" capture="environment" style="display:none">
        <input id="fileGaleria" type="file" accept="image/*" style="display:none">

        <div class="platePreview" id="platePreview" style="display:none">
          <img id="plateImg" alt="Prato"/>
        </div>

        <div class="label" style="margin-top:14px">Descri√ß√£o</div>
        <textarea id="plateDesc" placeholder="Ex: arroz, feij√£o, frango e salada..."></textarea>

        <div class="row">
          <div class="col">
            <div class="label">Calorias (kcal)</div>
            <input id="plateKcal" inputmode="numeric" placeholder="Ex: 650">
          </div>
          <div class="col">
            <div class="label">Prote√≠na (g)</div>
            <input id="plateProt" inputmode="numeric" placeholder="Ex: 35">
          </div>
        </div>

        <button class="btn" type="button" onclick="analisarPrato()">Calcular score</button>

        <div id="plateOut" class="status" style="display:none"></div>

        <div class="scoreBox" id="scoreBox" style="display:none">
          <div>
            <div class="label" style="margin:0 0 6px">Score do prato</div>
            <div><b id="plateScore">0</b> <span class="muted">/ 100</span></div>
            <div class="muted" style="margin-top:6px;font-weight:800" id="plateInsight">‚Äî</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
            <div class="pillSmall" id="pillProt">Prote√≠na: 0g</div>
            <div class="pillSmall" id="pillKcal">Calorias: 0</div>
            <button class="btnSecondary" style="margin-top:0" type="button" onclick="salvarPrato()">Salvar no hist√≥rico</button>
          </div>
        </div>

        <div class="label" style="margin-top:16px">Hist√≥rico</div>
        <div class="hint" id="plateHistoryTxt">Sem registros ainda.</div>
      </div>
    </section>

    <!-- DIETA -->
    <section id="viewDieta" class="screen">
      <div class="h1">DIETA</div>

      <div class="card">
        <div class="hint">
          Sugest√µes alinhadas ao seu cadastro. Se quiser variar, toque em <b>Trocar</b>.
        </div>

        <button class="btn" type="button" onclick="gerarDieta()">GERAR</button>
        <button class="btnSecondary" type="button" onclick="refazerDieta()">TROCAR</button>

        <div id="dietaBox"></div>
      </div>
    </section>

    <!-- TREINO -->
    <section id="viewTreino" class="screen">
      <div class="h1">TREINO</div>

      <div class="card">
        <div class="hint">Treino semanal com t√©cnica no YouTube.</div>

        <div class="row" style="margin-top:10px">
          <div class="col">
            <div class="label">Tema</div>
            <select id="temaTreino"></select>
          </div>
          <div class="col">
            <div class="label">Intensidade</div>
            <select id="intTreino">
              <option>Leve</option>
              <option>Moderado</option>
              <option>Pesado</option>
            </select>
          </div>
        </div>

        <button class="btn" type="button" onclick="gerarTreino()">GERAR TREINO</button>
        <button class="btnSecondary" type="button" onclick="limparTreino()">LIMPAR</button>

        <div id="outTreino" class="status" style="display:none"></div>
        <div id="treinoSemana"></div>
      </div>
    </section>

    <!-- EVOLU√á√ÉO -->
    <section id="viewEvolucao" class="screen">
      <div class="h1">EVOLU√á√ÉO</div>

      <div class="card">
        <div class="hint">
          Score do prato + streak + n√≠vel. Voc√™ evolui com const√¢ncia ‚Äî sem depender de motiva√ß√£o.
        </div>

        <div class="grid2" style="margin-top:12px">
          <div class="pill2">
            <div class="label" style="margin:0 0 6px">Streak</div>
            <div style="font-weight:1000;font-size:22px"><span id="streakDays">0</span> dias</div>
            <div class="muted" style="margin-top:6px;font-weight:800" id="streakHint">‚Äî</div>
          </div>
          <div class="pill2">
            <div class="label" style="margin:0 0 6px">N√≠vel</div>
            <div style="font-weight:1000;font-size:22px">Lv <span id="userLevel">1</span></div>
            <div class="bar"><div id="xpBar"></div></div>
            <div class="muted" style="margin-top:6px;font-weight:800"><span id="xpNow">0</span> / <span id="xpNeed">100</span> XP</div>
          </div>
        </div>

        <div class="label" style="margin-top:14px">Medalhas</div>
        <div class="badgeRow" id="badgeRow"></div>

        <div class="label" style="margin-top:14px">Ranking semanal (estimativa)</div>
        <div class="meal">
          <div>
            <div class="title">Seu desempenho</div>
            <p id="rankTxt">‚Äî</p>
          </div>
        </div>

        <div class="label" style="margin-top:14px">Gr√°fico (score por dia)</div>
        <div class="chartBox">
          <canvas id="evoChart" height="140"></canvas>
        </div>

        <div class="miniRow" style="margin-top:12px">
          <button class="miniBtn" type="button" onclick="marcarDia()">Salvar dia</button>
          <button class="miniBtn" type="button" onclick="resetEvolucao()">Reset evolu√ß√£o</button>
        </div>
      </div>
    </section>

    <!-- PROGRESSO -->
    <section id="viewProgresso" class="screen">
      <div class="h1">PROGRESSO</div>

      <div class="pro3dWrap">
        <div class="pro3dCard">
          <div class="proTop">
            <div class="pill"><span class="dot"></span><span id="proMode">Local</span></div>
            <div class="pill"><span class="dot"></span><span id="proWeek">Semana</span></div>
          </div>

          <div class="proTitle">Meta da Semana</div>

          <div class="proGrid">
            <div class="proPanel">
              <div class="label" style="margin-top:0">Foco</div>
              <div class="hint" id="focusTxt">Consist√™ncia + prote√≠na + treino.</div>

              <div class="label" style="margin-top:12px">Prote√≠na (semana)</div>
              <div class="hint"><b id="protWeek">0</b> g acumulado</div>

              <div class="miniRow" style="margin-top:12px">
                <button class="miniBtn" type="button" onclick="addTreinoDone()">+1 dia treino</button>
                <button class="miniBtn" type="button" onclick="resetProgresso()">Reset semana</button>
              </div>
            </div>

            <div class="proPanel">
              <div class="label" style="margin-top:0">Progresso</div>

              <div class="proRingBox">
                <div class="ring">
                  <svg viewBox="0 0 120 120">
                    <circle cx="60" cy="60" r="48" stroke="rgba(255,255,255,.10)" stroke-width="10" fill="none"/>
                    <circle id="ringProg" cx="60" cy="60" r="48"
                      stroke="rgba(255,211,138,.95)" stroke-linecap="round"
                      stroke-width="10" fill="none"
                      stroke-dasharray="301.59" stroke-dashoffset="301.59"/>
                  </svg>
                  <div class="ringCenter">
                    <div class="ringPct" id="proPct">0%</div>
                    <div class="ringSub"><span id="proDone">0</span> / <span id="proGoal">7</span> dias</div>
                  </div>
                </div>

                <div class="proHint">
                  Evolua <b>1% por dia</b>. Consist√™ncia vence.
                </div>
              </div>
            </div>
          </div>

          <div class="proStats">
            <div class="stat3d">
              <div class="num" id="proKcal">0</div>
              <div class="lab">calorias</div>
              <button class="btnSecondary" type="button" onclick="addKcal()">+500</button>
            </div>
            <div class="stat3d">
              <div class="num" id="proKm">0</div>
              <div class="lab">km</div>
              <button class="btnSecondary" type="button" onclick="addKm()">+2 km</button>
            </div>
            <div class="stat3d">
              <div class="num"><span id="proDays">0</span>/<span id="proDaysGoal">7</span></div>
              <div class="lab">dias treino</div>
              <button class="btnSecondary" type="button" onclick="setGoalDaysPrompt()">Meta</button>
            </div>
          </div>

        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="label">Resumo</div>
        <div class="hint" id="proResumo">‚Äî</div>
      </div>
    </section>

    <!-- SA√öDE -->
    <section id="viewSaude" class="screen">
      <div class="h1">SA√öDE</div>

      <div class="card">
        <div class="hint">
          Conte√∫do educativo. N√£o substitui m√©dico. Em caso de sintomas ou d√∫vidas, procure um profissional.
        </div>

        <div class="meal" style="margin-top:14px">
          <div>
            <div class="title">Anabolizantes: aten√ß√£o</div>
            <p>Podem afetar cora√ß√£o, press√£o, colesterol, f√≠gado, humor e horm√¥nios. N√£o use sem acompanhamento.</p>
          </div>
        </div>

        <div class="meal">
          <div>
            <div class="title">Sinais de alerta</div>
            <p>Dor no peito, falta de ar, palpita√ß√£o, desmaio, incha√ßo, pele/olhos amarelados: pare e procure atendimento.</p>
          </div>
        </div>

        <div class="meal">
          <div>
            <div class="title">Cuidados</div>
            <p>Sono 7‚Äì9h, hidrata√ß√£o, fibras, evitar √°lcool, progress√£o no treino e descanso.</p>
          </div>
        </div>

        <button class="btnSecondary" type="button" onclick="abrirLink('https://bvsms.saude.gov.br/')">Fontes</button>
      </div>
    </section>

    <!-- PARCEIROS -->
    <section id="viewParceiros" class="screen">
      <div class="h1">PARCEIROS</div>

      <div class="card">
        <div class="hint">Sites oficiais (voc√™ troca pelos seus links depois).</div>

        <div class="partnerList">
          <div class="partnerRow">
            <div class="partnerName"><b>Growth Supplements</b><div class="muted">Whey, creatina e suplementos</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.gsuplementos.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Max Titanium</b><div class="muted">Nutri√ß√£o esportiva</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.maxtitanium.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Nike</b><div class="muted">T√™nis e roupas</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.nike.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Adidas</b><div class="muted">Performance e lifestyle</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.adidas.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Mercado Livre</b><div class="muted">Acess√≥rios e suplementos</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.mercadolivre.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Shopee</b><div class="muted">Produtos fitness acess√≠veis</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://shopee.com.br')">Abrir</button>
          </div>
        </div>
      </div>
    </section>

    <!-- CONVITES -->
    <section id="viewConvites" class="screen">
      <div class="h1">CONVITES</div>

      <div class="card">
        <div class="hint">
          Compartilhe seu link.
        </div>

        <div style="margin-top:12px" class="card">
          <div class="label">Seu c√≥digo</div>
          <div id="myCode" style="font-weight:1000; font-size:18px">‚Äî</div>

          <div class="label" style="margin-top:12px">Seu link</div>
          <div id="myLink" class="muted" style="word-break:break-all">‚Äî</div>

          <div class="miniRow" style="margin-top:12px">
            <button class="miniBtn" type="button" onclick="copyInviteLink()">Copiar link</button>
            <button class="miniBtn" type="button" onclick="shareInvite()">Compartilhar</button>
          </div>
        </div>
      </div>
    </section>

  </div>

  <!-- NAV (ORDEM PEDIDA) -->
  <div class="nav" id="navBar">
    <div class="navInner">
      <button class="navBtn" data-view="viewCadastro" type="button">CADASTRO</button>
      <button class="navBtn" data-view="viewPerfil" type="button">PERFIL</button>
      <button class="navBtn" data-view="viewPrato" type="button">PRATO</button>
      <button class="navBtn" data-view="viewDieta" type="button">DIETA</button>
      <button class="navBtn" data-view="viewTreino" type="button">TREINO</button>
      <button class="navBtn" data-view="viewEvolucao" type="button">EVOLU√á√ÉO</button>
      <button class="navBtn" data-view="viewProgresso" type="button">PROGRESSO</button>
      <button class="navBtn" data-view="viewSaude" type="button">SA√öDE</button>
      <button class="navBtn" data-view="viewParceiros" type="button">PARCEIROS</button>
      <button class="navBtn" data-view="viewConvites" type="button">CONVITES</button>
    </div>
  </div>

  <button id="btnTop" onclick="scrollToTop()">‚Üë</button>

  <!-- Firebase (opcional, desativado por padr√£o) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    /***********************
     * 0) PWA
     ***********************/
    if ("serviceWorker" in navigator){
      navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    }

    /***********************
     * 1) Helpers
     ***********************/
    const $ = (id)=>document.getElementById(id);
    function abrirLink(url){ window.open(url, "_blank"); }
    window.abrirLink = abrirLink;

    function escapeHtml(s){
      return String(s).replace(/[&<>"]/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m]));
    }

    /***********************
     * 2) Storage Keys
     ***********************/
    const KEY_PROFILE = "cp_profile_v2";
    const KEY_AVATAR  = "cp_avatar_v2";

    const KEY_PLATE_LAST = "cp_plate_last_v2";
    const KEY_PLATES = "cp_plates_v2"; // {dateISO, score, kcal, prot, desc}

    const KEY_DIETA   = "cp_dieta_v2";
    const KEY_TREINO  = "cp_treino_v2";

    const KEY_INV_CODE = "cp_inv_code_v2";

    const KEY_DASH = "cp_dash_v2"; // kcal, km, done, goal, weekStart
    const KEY_EVO  = "cp_evo_v2";  // xp, level, lastDayISO, streak, days[{date,score}]

    /***********************
     * 3) Firebase (opcional)
     ***********************/
    const FIREBASE_CONFIG = {
      // Cole aqui seu firebaseConfig quando quiser ativar.
    };
    let firebaseEnabled = false;
    function initFirebaseIfPossible(){
      try{
        const hasKeys = FIREBASE_CONFIG && FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.projectId;
        if(!hasKeys) return;
        firebase.initializeApp(FIREBASE_CONFIG);
        firebaseEnabled = true;
      }catch(e){
        console.log("Firebase init error:", e);
      }
    }

    /***********************
     * 4) Navega√ß√£o (fix total)
     ***********************/
    function showOnly(viewId){
      document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
      const el = document.getElementById(viewId);
      if(el) el.classList.add("active");

      document.querySelectorAll(".navBtn").forEach(b=>{
        b.classList.toggle("active", b.dataset.view === viewId);
      });

      updateTopBtn();
      window.scrollTo({ top:0, behavior:"smooth" });
    }
    window.showOnly = showOnly;

    document.addEventListener("click", (e)=>{
      const btn = e.target.closest(".navBtn");
      if(!btn) return;
      const viewId = btn.dataset.view;
      if(viewId) showOnly(viewId);
    });

    function scrollToTop(){ window.scrollTo({ top:0, behavior:"smooth" }); }
    window.scrollToTop = scrollToTop;

    function updateTopBtn(){
      const btn = $("btnTop");
      if(!btn) return;
      btn.style.display = (window.scrollY > 200) ? "block" : "none";
    }
    window.addEventListener("scroll", updateTopBtn, { passive:true });

    function goCadastro(){ showOnly("viewCadastro"); }
    function goManual(){ showOnly("viewManual"); }
    window.goCadastro = goCadastro;
    window.goManual = goManual;

    /***********************
     * 5) Welcome carousel
     ***********************/
    let wIndex = 0;
    function buildWelcomeDots(){
      const host = $("wDots");
      if(!host) return;
      host.innerHTML = "";
      const slides = [...document.querySelectorAll(".wSlide")];
      slides.forEach((_, i)=>{
        const d = document.createElement("div");
        d.className = "wDot" + (i===wIndex ? " on" : "");
        d.addEventListener("click", ()=> setWelcomeSlide(i));
        host.appendChild(d);
      });
    }
    function setWelcomeSlide(i){
      const slides = [...document.querySelectorAll(".wSlide")];
      wIndex = Math.max(0, Math.min(slides.length-1, i));
      slides.forEach(s=>s.classList.remove("active"));
      slides[wIndex]?.classList.add("active");
      buildWelcomeDots();
    }
    function autoWelcome(){
      const slides = [...document.querySelectorAll(".wSlide")];
      if(!slides.length) return;
      setInterval(()=> setWelcomeSlide((wIndex+1)%slides.length), 5500);
    }

    /***********************
     * 6) Cadastro + Avatar
     ***********************/
    const ESPORTES = ["Muscula√ß√£o","Futebol","Corrida","Crossfit","Ciclismo","Nata√ß√£o","Luta","Basquete","V√¥lei","Yoga","Pilates","Caminhada","Muay Thai","Jiu-jitsu","Boxe","Calistenia"];
    let selectedSports = new Set();

    function safeJSON(key){
      try{ return JSON.parse(localStorage.getItem(key) || "null"); }catch{ return null; }
    }

    function buildSportsChips(){
      const box = $("chipsEsportes");
      if(!box) return;
      box.innerHTML = "";
      ESPORTES.forEach(name=>{
        const div = document.createElement("div");
        div.className = "chip";
        div.textContent = name;
        div.addEventListener("click", ()=>{
          if(selectedSports.has(name)) selectedSports.delete(name);
          else selectedSports.add(name);
          div.classList.toggle("on");
        });
        box.appendChild(div);
      });

      const p = safeJSON(KEY_PROFILE);
      if(p && Array.isArray(p.esportes)){
        selectedSports = new Set(p.esportes);
        [...box.querySelectorAll(".chip")].forEach(ch=>{
          if(selectedSports.has(ch.textContent)) ch.classList.add("on");
        });
      }
    }

    function applyProfileToUI(){
      const p = safeJSON(KEY_PROFILE);
      if(!p) return;
      $("nome").value = p.nome || "";
      $("emailPerfil").value = p.email || "";
      $("peso").value = p.peso || "";
      $("altura").value = p.altura || "";
      $("objetivo").value = p.objetivo || "";
      $("nivel").value = p.nivel || "";
      $("condicao").value = p.condicao || "";
      $("restricao").value = p.restricao || "";
      $("metaProt").value = p.metaProt || "";
      $("metaDias").value = p.metaDias || "";
      $("termo").checked = true;
    }

    async function salvarCadastro(){
      const termo = $("termo")?.checked;
      if(!termo){
        alert("Marque o aceite para salvar.");
        return;
      }
      const perfil = {
        nome: ($("nome").value || "").trim(),
        email: ($("emailPerfil").value || "").trim(),
        peso: ($("peso").value || "").trim(),
        altura: ($("altura").value || "").trim(),
        objetivo: $("objetivo").value || "",
        nivel: $("nivel").value || "",
        condicao: $("condicao").value || "",
        restricao: $("restricao").value || "",
        metaProt: ($("metaProt").value || "").trim(),
        metaDias: ($("metaDias").value || "").trim(),
        esportes: Array.from(selectedSports),
        updatedAt: Date.now()
      };
      localStorage.setItem(KEY_PROFILE, JSON.stringify(perfil));
      const out = $("outCadastro");
      out.style.display="block";
      out.textContent="‚úÖ Cadastro salvo.";
      updatePerfilBox();
      refreshEvolucaoUI();
      renderDash();
      fillTreinoTemaOptions();
    }
    window.salvarCadastro = salvarCadastro;

    function limparCadastro(){
      localStorage.removeItem(KEY_PROFILE);
      ["nome","emailPerfil","peso","altura","metaProt","metaDias"].forEach(id=> $(id).value="");
      ["objetivo","nivel","condicao","restricao"].forEach(id=> $(id).value="");
      $("termo").checked = false;
      selectedSports = new Set();
      buildSportsChips();
      const out = $("outCadastro");
      out.style.display="block";
      out.textContent="üßπ Cadastro limpo.";
      updatePerfilBox();
      refreshEvolucaoUI();
      renderDash();
      fillTreinoTemaOptions();
    }
    window.limparCadastro = limparCadastro;

    function pickAvatar(){ $("avatarFile").click(); }
    window.pickAvatar = pickAvatar;

    function applyAvatar(){
      const dataUrl = localStorage.getItem(KEY_AVATAR);
      const img = $("avatarImg");
      const fb = $("avatarFallback");
      if(dataUrl){
        img.src = dataUrl; img.style.display="block";
        fb.style.display="none";
      }else{
        img.style.display="none";
        fb.style.display="flex";
      }
    }

    function wireAvatarInput(){
      const f = $("avatarFile");
      f.addEventListener("change", ()=>{
        const file = f.files?.[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          localStorage.setItem(KEY_AVATAR, String(reader.result||""));
          applyAvatar();
          updatePerfilBox();
        };
        reader.readAsDataURL(file);
      });
    }

    /***********************
     * 7) Prato
     ***********************/
    function wirePlateInput(){
      const btnCam = $("btnCamera");
      const btnGal = $("btnGaleria");
      const fc = $("fileCamera");
      const fg = $("fileGaleria");
      btnCam.addEventListener("click", ()=> fc.click());
      btnGal.addEventListener("click", ()=> fg.click());

      function onFile(file){
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          const dataUrl = String(reader.result || "");
          localStorage.setItem(KEY_PLATE_LAST, dataUrl);
          showPlate(dataUrl);
        };
        reader.readAsDataURL(file);
      }
      fc.addEventListener("change", ()=> onFile(fc.files?.[0]));
      fg.addEventListener("change", ()=> onFile(fg.files?.[0]));
    }

    function showPlate(dataUrl){
      $("plateImg").src = dataUrl;
      $("platePreview").style.display = "block";
    }

    function loadLastPlate(){
      const dataUrl = localStorage.getItem(KEY_PLATE_LAST);
      if(dataUrl) showPlate(dataUrl);
    }

    function getPlates(){
      try{ return JSON.parse(localStorage.getItem(KEY_PLATES) || "[]"); }catch{ return []; }
    }
    function setPlates(arr){
      localStorage.setItem(KEY_PLATES, JSON.stringify(arr.slice(-120)));
    }

    function calcPlateScore({kcal, prot}){
      const p = safeJSON(KEY_PROFILE) || {};
      const metaProt = Math.max(1, parseInt(p.metaProt || "120",10));
      const obj = (p.objetivo || "Manter").toLowerCase();

      // Prote√≠na: at√© 60 pts
      const protPct = Math.max(0, Math.min(1, prot / Math.max(1, metaProt/3))); // alvo ~ 1/3 da meta no prato
      const protPts = Math.round(60 * protPct);

      // Calorias: at√© 40 pts (depende do objetivo)
      let idealMin = 450, idealMax = 750;
      if(obj.includes("emag")){ idealMin = 350; idealMax = 650; }
      if(obj.includes("massa")){ idealMin = 550; idealMax = 950; }
      if(obj.includes("perform")){ idealMin = 500; idealMax = 900; }

      let kcalPts = 0;
      if(kcal >= idealMin && kcal <= idealMax) kcalPts = 40;
      else{
        const dist = kcal < idealMin ? (idealMin - kcal) : (kcal - idealMax);
        kcalPts = Math.max(0, 40 - Math.round(dist / 15)); // penaliza suavemente
      }

      const score = Math.max(0, Math.min(100, protPts + kcalPts));
      let insight = "Bom equil√≠brio.";
      if(score >= 85) insight = "Excelente: alto valor nutricional e alinhado √† sua meta.";
      else if(score >= 70) insight = "Muito bom: ajuste fino e voc√™ acelera o resultado.";
      else if(score >= 55) insight = "Ok: d√° pra melhorar prote√≠na e qualidade geral.";
      else insight = "Baixo: tente aumentar prote√≠na e manter equil√≠brio no prato.";

      return { score, insight };
    }

    function analisarPrato(){
      const desc = ($("plateDesc").value || "").trim();
      const kcal = parseInt(($("plateKcal").value || "0").replace(/\D/g,""), 10) || 0;
      const prot = parseInt(($("plateProt").value || "0").replace(/\D/g,""), 10) || 0;

      if(!desc){
        $("plateOut").style.display="block";
        $("plateOut").textContent="Escreva uma descri√ß√£o do prato.";
        return;
      }
      if(kcal <= 0 || prot < 0){
        $("plateOut").style.display="block";
        $("plateOut").textContent="Preencha calorias e prote√≠na (valores v√°lidos).";
        return;
      }

      const {score, insight} = calcPlateScore({kcal, prot});

      $("plateOut").style.display="block";
      $("plateOut").textContent="‚úÖ Score calculado. Se estiver correto, salve no hist√≥rico.";

      $("plateScore").textContent = String(score);
      $("plateInsight").textContent = insight;
      $("pillProt").textContent = `Prote√≠na: ${prot}g`;
      $("pillKcal").textContent = `Calorias: ${kcal} kcal`;
      $("scoreBox").style.display = "flex";
    }
    window.analisarPrato = analisarPrato;

    function todayISO(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function salvarPrato(){
      const desc = ($("plateDesc").value || "").trim();
      const kcal = parseInt(($("plateKcal").value || "0").replace(/\D/g,""), 10) || 0;
      const prot = parseInt(($("plateProt").value || "0").replace(/\D/g,""), 10) || 0;
      if(!desc || kcal<=0) return;

      const {score} = calcPlateScore({kcal, prot});
      const arr = getPlates();
      arr.push({ dateISO: todayISO(), ts: Date.now(), score, kcal, prot, desc });
      setPlates(arr);

      $("plateOut").style.display="block";
      $("plateOut").textContent="‚úÖ Salvo no hist√≥rico.";

      renderPlateHistory();
      refreshEvolucaoUI();
      renderDash();
    }
    window.salvarPrato = salvarPrato;

    function renderPlateHistory(){
      const arr = getPlates();
      if(!arr.length){
        $("plateHistoryTxt").textContent = "Sem registros ainda.";
        return;
      }
      const last = arr[arr.length-1];
      const count = arr.length;
      $("plateHistoryTxt").textContent = `Registros: ${count}. √öltimo: score ${last.score}/100 ‚Ä¢ ${last.prot}g prote√≠na ‚Ä¢ ${last.kcal} kcal.`;
    }

    /***********************
     * 8) Dieta
     ***********************/
    const DIETAS_BASE = [
      [
        {t:"Caf√© da manh√£", d:"Omelete 2‚Äì3 ovos + fruta + caf√© sem a√ß√∫car.", k:420},
        {t:"Lanche", d:"Iogurte natural + chia.", k:180},
        {t:"Almo√ßo", d:"Frango + arroz + feij√£o + salada + azeite.", k:650},
        {t:"Lanche", d:"Whey ou iogurte + banana.", k:240},
        {t:"Jantar", d:"Peixe + legumes + batata-doce.", k:520},
      ],
      [
        {t:"Caf√© da manh√£", d:"Aveia + banana + 2 ovos.", k:520},
        {t:"Almo√ßo", d:"Arroz + feij√£o + carne magra + br√≥colis.", k:780},
        {t:"Jantar", d:"Macarr√£o integral + frango + molho de tomate.", k:720},
        {t:"Ceia", d:"Iogurte + granola.", k:300},
      ],
      [
        {t:"Caf√© da manh√£", d:"Tapioca + queijo + 1 fruta.", k:460},
        {t:"Almo√ßo", d:"Carne magra + mandioca + salada.", k:720},
        {t:"Jantar", d:"Omelete + legumes + salada.", k:480},
      ]
    ];

    function renderDieta(d){
      const box = $("dietaBox");
      box.innerHTML = "";
      if(!d){
        const s = document.createElement("div");
        s.className="status";
        s.textContent="Gere uma dieta para aparecer aqui.";
        box.appendChild(s);
        return;
      }
      d.forEach(m=>{
        const div = document.createElement("div");
        div.className="meal";
        div.innerHTML = `
          <div>
            <div class="title">${escapeHtml(m.t)}</div>
            <p>${escapeHtml(m.d)}</p>
          </div>
          <div class="kcal">${Number(m.k||0)}<br/>kcal</div>
        `;
        box.appendChild(div);
      });
    }

    function gerarDieta(){
      const d = DIETAS_BASE[Math.floor(Math.random()*DIETAS_BASE.length)];
      localStorage.setItem(KEY_DIETA, JSON.stringify(d));
      renderDieta(d);
    }
    window.gerarDieta = gerarDieta;

    function refazerDieta(){ gerarDieta(); }
    window.refazerDieta = refazerDieta;

    /***********************
     * 9) Treino (muito mais op√ß√µes)
     ***********************/
    const TREINOS = {
      "Academia": [
        ["Segunda", ["Agachamento","Supino reto","Remada curvada","Panturrilha"]],
        ["Quarta", ["Desenvolvimento","Puxada na barra","Rosca direta","Abdominal prancha"]],
        ["Sexta", ["Levantamento terra","Leg press","Tr√≠ceps corda","Eleva√ß√£o lateral"]],
      ],
      "Corrida": [
        ["Segunda", ["Corrida leve 30 min","Mobilidade"]],
        ["Quarta", ["Tiros 8x 200m","Alongamento"]],
        ["Sexta", ["Corrida moderada 40 min","Core (prancha)"]],
      ],
      "Futebol":[
        ["Segunda", ["Arranque","Controle de bola","Finaliza√ß√£o"]],
        ["Quarta", ["Agilidade","Passe e dom√≠nio","Resist√™ncia"]],
        ["Sexta", ["Jogo reduzido","Alongamento"]],
      ],
      "Basquete":[
        ["Ter√ßa", ["Drible","Arremessos","Pliometria"]],
        ["Quinta", ["Defesa lateral","Bandejas","Condicionamento"]],
        ["S√°bado", ["Treino de jogo","Alongamento"]],
      ],
      "Muay Thai":[
        ["Ter√ßa", ["Sombra 10 min","Chutes b√°sicos","Combina√ß√µes"]],
        ["Quinta", ["Manopla","Defesas","Condicionamento"]],
        ["S√°bado", ["Clinch","Sequ√™ncias","Alongamento"]],
      ],
      "Calistenia":[
        ["Segunda", ["Flex√£o (varia√ß√µes)","Barra fixa (ou remada)","Prancha"]],
        ["Quarta", ["Agachamento livre","Afundo","Eleva√ß√£o de quadril"]],
        ["Sexta", ["Flex√£o diamante","Remada australiana","Abdominal"]],
      ],
      "Ciclismo":[
        ["Ter√ßa", ["Pedal leve 40 min","Mobilidade"]],
        ["Quinta", ["Subidas 6x 2 min","Alongamento"]],
        ["S√°bado", ["Long√£o 60‚Äì90 min","Core"]],
      ],
      "Nata√ß√£o":[
        ["Segunda", ["T√©cnica 30 min","Pernada 10 min"]],
        ["Quarta", ["S√©ries 10x 50m","Respira√ß√£o"]],
        ["Sexta", ["Resist√™ncia 30‚Äì40 min","Alongamento"]],
      ],
    };

    function fillTreinoTemaOptions(){
      const sel = $("temaTreino");
      if(!sel) return;
      const p = safeJSON(KEY_PROFILE) || {};
      const prefer = Array.isArray(p.esportes) ? p.esportes : [];
      const temas = Object.keys(TREINOS);

      sel.innerHTML = "";
      const ordered = [
        ...prefer.filter(x=>temas.includes(x)),
        ...temas.filter(x=>!prefer.includes(x))
      ];

      ordered.forEach(t=>{
        const o = document.createElement("option");
        o.textContent = t;
        sel.appendChild(o);
      });
      if(!ordered.length){
        const o = document.createElement("option");
        o.textContent = "Academia";
        sel.appendChild(o);
      }
    }

    function renderTreino(t){
      const box = $("treinoSemana");
      box.innerHTML = "";
      if(!t){
        const s = document.createElement("div");
        s.className="status";
        s.textContent="Gere um treino para aparecer aqui.";
        box.appendChild(s);
        return;
      }

      t.dias.forEach(d=>{
        const day = document.createElement("div");
        day.className="dayCard";
        day.innerHTML = `<div class="dayTitle"><span>${escapeHtml(d[0])}</span><span class="muted">${escapeHtml(t.tema)}</span></div>`;
        (d[1]||[]).forEach(ex=>{
          const row = document.createElement("div");
          row.className="exercise";
          const left = document.createElement("div");
          left.innerHTML = `<b>${escapeHtml(ex)}</b><div class="muted" style="font-size:12px; margin-top:4px">${escapeHtml(t.intensidade)}</div>`;
          const btn = document.createElement("button");
          btn.className="ytBtn";
          btn.textContent="Ver t√©cnica";
          btn.addEventListener("click", ()=> abrirLink(`https://www.youtube.com/results?search_query=${encodeURIComponent(ex+" como fazer")}`));
          row.appendChild(left);
          row.appendChild(btn);
          day.appendChild(row);
        });
        box.appendChild(day);
      });
    }

    function gerarTreino(){
      const tema = $("temaTreino")?.value || "Academia";
      const intensidade = $("intTreino")?.value || "Moderado";
      const base = TREINOS[tema] || TREINOS["Academia"];
      const plano = { tema, intensidade, dias: base, createdAt: Date.now() };
      localStorage.setItem(KEY_TREINO, JSON.stringify(plano));
      renderTreino(plano);

      const out = $("outTreino");
      out.style.display="block";
      out.textContent = `‚úÖ Treino salvo: ${tema} (${intensidade}).`;
    }
    window.gerarTreino = gerarTreino;

    function limparTreino(){
      localStorage.removeItem(KEY_TREINO);
      $("treinoSemana").innerHTML = "";
      const out = $("outTreino");
      out.style.display="block";
      out.textContent="üßπ Treino removido.";
    }
    window.limparTreino = limparTreino;

    /***********************
     * 10) Convites
     ***********************/
    function getOrCreateInviteCode(){
      let code = localStorage.getItem(KEY_INV_CODE);
      if(code) return code;
      code = "ELITE-" + Math.random().toString(16).slice(2,8).toUpperCase();
      localStorage.setItem(KEY_INV_CODE, code);
      return code;
    }
    function getMyInviteLink(){
      const code = getOrCreateInviteCode();
      const url = new URL(location.href);
      url.searchParams.set("ref", code);
      return url.toString();
    }
    async function copyInviteLink(){
      const link = getMyInviteLink();
      try{
        await navigator.clipboard.writeText(link);
        alert("‚úÖ Link copiado!");
      }catch{
        prompt("Copie o link:", link);
      }
    }
    window.copyInviteLink = copyInviteLink;

    function shareInvite(){
      const link = getMyInviteLink();
      const text = `Baixa o CheckPrato e usa meu link: ${link}`;
      if(navigator.share){
        navigator.share({ title:"CheckPrato", text, url: link }).catch(()=>{});
      }else{
        copyInviteLink();
      }
    }
    window.shareInvite = shareInvite;

    function renderInviteUI(){
      $("myCode").textContent = getOrCreateInviteCode();
      $("myLink").textContent = getMyInviteLink();
    }

    /***********************
     * 11) Dashboard (Progresso)
     ***********************/
    function getDash(){
      const d = safeJSON(KEY_DASH);
      if(d && typeof d === "object") return d;
      const now = new Date();
      const start = new Date(now);
      start.setHours(0,0,0,0);
      start.setDate(now.getDate() - ((now.getDay()+6)%7)); // segunda
      return { kcal:0, km:0, done:0, goal:7, weekStart: start.getTime() };
    }
    function setDash(d){
      localStorage.setItem(KEY_DASH, JSON.stringify(d));
      renderDash();
    }
    function weekLabel(ts){
      const dt = new Date(ts);
      const dd = String(dt.getDate()).padStart(2,"0");
      const mm = String(dt.getMonth()+1).padStart(2,"0");
      return `Semana ‚Ä¢ ${dd}/${mm}`;
    }

    function sumWeekProtein(){
      const d = getDash();
      const start = d.weekStart;
      const end = start + 7*24*3600*1000;
      const arr = getPlates();
      let sum = 0;
      arr.forEach(p=>{
        if(p.ts >= start && p.ts < end) sum += (Number(p.prot)||0);
      });
      return Math.round(sum);
    }

    function setProgressoUI({ kcal, km, doneDays, goalDays, weekStart }){
      $("proKcal").textContent = String(Math.round(kcal));
      $("proKm").textContent = String(Math.round(km));
      $("proDone").textContent = String(doneDays);
      $("proGoal").textContent = String(goalDays);
      $("proDays").textContent = String(doneDays);
      $("proDaysGoal").textContent = String(goalDays);
      $("proWeek").textContent = weekLabel(weekStart);

      const pct = goalDays > 0 ? Math.max(0, Math.min(100, Math.round((doneDays / goalDays) * 100))) : 0;
      $("proPct").textContent = pct + "%";

      const C = 301.59;
      const offset = C - (C * pct / 100);
      const ring = $("ringProg");
      ring.style.strokeDasharray = String(C);
      ring.style.strokeDashoffset = String(offset);

      $("protWeek").textContent = String(sumWeekProtein());

      const resumo = $("proResumo");
      resumo.innerHTML = `Voc√™ fez <b>${doneDays}</b> dias de treino, <b>${Math.round(km)} km</b> e <b>${Math.round(kcal)} kcal</b> na semana.`;
    }

    function renderDash(){
      const d = getDash();
      setProgressoUI({ kcal:d.kcal, km:d.km, doneDays:d.done, goalDays:d.goal, weekStart:d.weekStart });
      updatePerfilBox();
    }

    function addKcal(){ const d=getDash(); d.kcal += 500; setDash(d); }
    function addKm(){ const d=getDash(); d.km += 2; setDash(d); }
    function addTreinoDone(){ const d=getDash(); d.done = Math.min(d.goal, d.done + 1); setDash(d); }
    window.addKcal = addKcal;
    window.addKm = addKm;
    window.addTreinoDone = addTreinoDone;

    function resetProgresso(){
      const d = getDash();
      d.kcal = 0; d.km = 0; d.done = 0;
      const now = new Date();
      const start = new Date(now);
      start.setHours(0,0,0,0);
      start.setDate(now.getDate() - ((now.getDay()+6)%7));
      d.weekStart = start.getTime();
      setDash(d);
    }
    window.resetProgresso = resetProgresso;

    function setGoalDaysPrompt(){
      const d = getDash();
      const v = prompt("Meta de dias de treino na semana (ex: 5, 6, 7):", String(d.goal));
      if(v === null) return;
      const n = Math.max(1, Math.min(14, parseInt(v,10) || d.goal));
      d.goal = n;
      if(d.done > d.goal) d.done = d.goal;
      setDash(d);
    }
    window.setGoalDaysPrompt = setGoalDaysPrompt;

    /***********************
     * 12) Evolu√ß√£o (XP, streak, medalhas, ranking + chart)
     ***********************/
    let evoChart = null;

    function getEvo(){
      const e = safeJSON(KEY_EVO);
      if(e && typeof e === "object") return e;
      return { xp:0, level:1, lastDayISO:"", streak:0, days:[] };
    }
    function setEvo(e){
      localStorage.setItem(KEY_EVO, JSON.stringify(e));
      refreshEvolucaoUI();
    }

    function xpNeedForLevel(lv){
      return 80 + (lv-1)*35;
    }

    function calcBadges(state){
      const plates = getPlates();
      const best = plates.reduce((m,p)=>Math.max(m, p.score||0), 0);
      const total = plates.length;
      const streak = state.streak||0;
      const badges = [
        {id:"b1", name:"Primeiro registro", ok: total >= 1},
        {id:"b2", name:"3 dias seguidos", ok: streak >= 3},
        {id:"b3", name:"7 dias seguidos", ok: streak >= 7},
        {id:"b4", name:"Score 80+", ok: best >= 80},
        {id:"b5", name:"10 pratos", ok: total >= 10},
        {id:"b6", name:"20 pratos", ok: total >= 20},
      ];
      return badges;
    }

    function calcWeeklyRankEstimate(){
      const d = getDash();
      const start = d.weekStart;
      const end = start + 7*24*3600*1000;
      const plates = getPlates().filter(p => p.ts >= start && p.ts < end);

      const sumScore = plates.reduce((s,p)=>s+(p.score||0), 0);
      const count = plates.length;
      const avg = count ? (sumScore / count) : 0;

      // Estimativa (refer√™ncia), sem dizer que √© ‚Äúoutros usu√°rios reais‚Äù
      // Faixa: avg score 50=baixo, 65=ok, 75=top, 85=elite
      let tier = "Iniciante";
      let pct = 60;
      if(avg >= 85){ tier="Elite"; pct=10; }
      else if(avg >= 75){ tier="Avan√ßado"; pct=25; }
      else if(avg >= 65){ tier="Intermedi√°rio"; pct=45; }
      else { tier="Iniciante"; pct=65; }

      return { avg: Math.round(avg), tier, pct };
    }

    function buildEvoChart(){
      const ctx = $("evoChart");
      if(!ctx) return;

      const e = getEvo();
      const labels = e.days.map(d=>d.date.slice(5)); // MM-DD
      const values = e.days.map(d=>d.score);

      if(evoChart){
        evoChart.data.labels = labels;
        evoChart.data.datasets[0].data = values;
        evoChart.update();
        return;
      }

      evoChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Score",
            data: values,
            tension: 0.35,
            borderWidth: 2,
            pointRadius: 3,
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display:false } },
          scales: {
            x: { ticks: { color: "rgba(234,242,255,.65)" }, grid: { color: "rgba(255,255,255,.06)" } },
            y: { min:0, max:100, ticks: { color: "rgba(234,242,255,.65)" }, grid: { color: "rgba(255,255,255,.06)" } }
          }
        }
      });
    }

    function refreshEvolucaoUI(){
      const e = getEvo();

      $("streakDays").textContent = String(e.streak||0);
      $("streakHint").textContent = e.streak >= 3 ? "Voc√™ est√° no ritmo. N√£o quebra hoje." : "Comece simples: 1 dia de cada vez.";

      const need = xpNeedForLevel(e.level);
      $("userLevel").textContent = String(e.level);
      $("xpNow").textContent = String(e.xp);
      $("xpNeed").textContent = String(need);
      $("xpBar").style.width = `${Math.max(0, Math.min(100, Math.round((e.xp/need)*100)))}%`;

      const badges = calcBadges(e);
      const row = $("badgeRow");
      row.innerHTML = "";
      badges.forEach(b=>{
        const el = document.createElement("div");
        el.className = "badge" + (b.ok ? " ok" : "");
        el.textContent = b.ok ? `üèÖ ${b.name}` : `üîí ${b.name}`;
        row.appendChild(el);
      });

      const rank = calcWeeklyRankEstimate();
      $("rankTxt").textContent = `M√©dia semanal: ${rank.avg}/100 ‚Ä¢ Faixa: ${rank.tier} ‚Ä¢ Voc√™ est√° por volta do top ${rank.pct}% (estimativa por refer√™ncia).`;

      buildEvoChart();
      updatePerfilBox();
    }

    function marcarDia(){
      // Usa o √∫ltimo prato do dia como score do dia (ou m√©dia do dia)
      const iso = todayISO();
      const plates = getPlates().filter(p=>p.dateISO === iso);
      if(!plates.length){
        alert("Registre pelo menos 1 prato hoje para salvar o dia.");
        return;
      }
      const avg = Math.round(plates.reduce((s,p)=>s+(p.score||0),0) / plates.length);

      const e = getEvo();
      // atualiza/insere dia
      const idx = e.days.findIndex(d=>d.date === iso);
      if(idx >= 0) e.days[idx].score = avg;
      else e.days.push({ date: iso, score: avg });
      e.days = e.days.slice(-30);

      // streak
      if(e.lastDayISO){
        const last = new Date(e.lastDayISO+"T00:00:00");
        const cur  = new Date(iso+"T00:00:00");
        const diffDays = Math.round((cur - last) / (24*3600*1000));
        if(diffDays === 1) e.streak += 1;
        else if(diffDays === 0) { /* mesmo dia */ }
        else e.streak = 1;
      }else{
        e.streak = 1;
      }
      e.lastDayISO = iso;

      // XP: baseado no score
      const gain = Math.max(10, Math.round(avg/3)); // 10 a ~33
      e.xp += gain;

      // level up
      let need = xpNeedForLevel(e.level);
      while(e.xp >= need){
        e.xp -= need;
        e.level += 1;
        need = xpNeedForLevel(e.level);
      }

      setEvo(e);
      alert(`‚úÖ Dia salvo. +${gain} XP`);
    }
    window.marcarDia = marcarDia;

    function resetEvolucao(){
      if(!confirm("Zerar evolu√ß√£o?")) return;
      localStorage.removeItem(KEY_EVO);
      evoChart = null;
      refreshEvolucaoUI();
    }
    window.resetEvolucao = resetEvolucao;

    /***********************
     * 13) Perfil
     ***********************/
    function updatePerfilBox(){
      const p = safeJSON(KEY_PROFILE) || {};
      const dash = getDash();
      const evo = getEvo();

      const sports = Array.isArray(p.esportes) ? p.esportes.join(", ") : "‚Äî";
      const metaProt = p.metaProt ? `${p.metaProt} g/dia` : "‚Äî";
      const metaDias = p.metaDias ? `${p.metaDias} dias/sem` : "‚Äî";

      const html = `
        <div><b>Nome:</b> ${escapeHtml(p.nome || "‚Äî")}</div>
        <div><b>Objetivo:</b> ${escapeHtml(p.objetivo || "‚Äî")}</div>
        <div><b>Esportes:</b> ${escapeHtml(sports || "‚Äî")}</div>
        <div><b>Meta prote√≠na:</b> ${escapeHtml(metaProt)}</div>
        <div><b>Meta treino:</b> ${escapeHtml(metaDias)}</div>
        <div style="margin-top:8px"><b>Evolu√ß√£o:</b> Lv ${evo.level} ‚Ä¢ Streak ${evo.streak} dias</div>
        <div style="margin-top:8px"><b>Semana:</b> ${escapeHtml(weekLabel(dash.weekStart))}</div>
        <div><b>Calorias:</b> ${Math.round(dash.kcal)} | <b>KM:</b> ${Math.round(dash.km)} | <b>Dias treino:</b> ${dash.done}/${dash.goal}</div>
      `;
      $("perfilBox").innerHTML = html;
    }

    function resetAllData(){
      if(!confirm("Zerar tudo do app neste aparelho?")) return;
      [
        KEY_PROFILE, KEY_AVATAR, KEY_PLATE_LAST, KEY_PLATES, KEY_DIETA, KEY_TREINO, KEY_INV_CODE, KEY_DASH, KEY_EVO
      ].forEach(k=>localStorage.removeItem(k));
      location.reload();
    }
    window.resetAllData = resetAllData;

    /***********************
     * 14) Init
     ***********************/
    function init(){
      initFirebaseIfPossible();

      buildSportsChips();
      applyProfileToUI();
      applyAvatar();
      wireAvatarInput();

      wirePlateInput();
      loadLastPlate();
      renderPlateHistory();

      renderDieta(safeJSON(KEY_DIETA));
      renderTreino(safeJSON(KEY_TREINO));

      renderInviteUI();

      fillTreinoTemaOptions();

      buildWelcomeDots();
      autoWelcome();

      refreshEvolucaoUI();
      renderDash();

      // badge topo
      $("authTxt").textContent = firebaseEnabled ? "Modo: Conta" : "Modo: Local";
      $("proMode").textContent = firebaseEnabled ? "Conta" : "Local";
    }

    init();
  </script>
</body>
</html>
