<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Confira o Prato Elite</title>

  <meta name="theme-color" content="#0a1320"/>
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" sizes="192x192" href="./icon-192.png">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <style>
    :root{
      --bg:#07121f;
      --bg2:#0b2033;
      --card:rgba(255,255,255,.04);
      --stroke:rgba(255,255,255,.08);
      --txt:#eaf2ff;
      --muted:rgba(234,242,255,.72);
      --green:#21e6b6;
      --green2:#17caa0;
      --orange:#f6b23a;
      --shadow:0 20px 60px rgba(0,0,0,.45);
      --r:22px;
      --max:540px;
    }
    *{ box-sizing:border-box; }
    html, body{
      height:100%;
      margin:0;
      padding:0;
      background: var(--bg);
      color: var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow-x:hidden;
    }
    body{ padding-bottom: calc(92px + env(safe-area-inset-bottom)); }

    .wrap{ max-width: var(--max); margin:0 auto; padding:16px 14px 24px; }

    .topbar{ display:flex; align-items:center; gap:12px; margin-top:6px; margin-bottom: 14px; }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(33,230,182,.35), rgba(33,230,182,.05));
      border:1px solid rgba(33,230,182,.35);
      display:flex;align-items:center;justify-content:center;
      font-weight:1000;
      color:var(--green);
      box-shadow: var(--shadow);
      flex:0 0 auto;
      overflow:hidden;
    }
    .logo img{width:100%;height:100%;object-fit:cover;display:block}
    .brand{display:flex;flex-direction:column;gap:2px;min-width:0;flex:1 1 auto;}
    .brand small{color:var(--muted); letter-spacing:.08em; font-weight:900}
    .brand b{font-size:18px}

    .pill{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--stroke);
      color:var(--muted);
      font-weight:800;
      flex:0 0 auto;
      white-space:nowrap;
    }
    .pill .dot{
      width:10px;height:10px;border-radius:99px;background:var(--green);
      box-shadow: 0 0 0 6px rgba(33,230,182,.12);
    }

    .h1{
      font-size:34px;
      margin:12px 2px 14px;
      letter-spacing:.02em;
      color:var(--green);
      font-weight: 1000;
      line-height: 1.05;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .hint{ color: var(--muted); font-weight: 650; line-height: 1.35; }
    .muted{ opacity:.85; }

    .row{display:flex; gap:12px; flex-wrap:wrap}
    .col{flex:1 1 140px; min-width: 140px}

    .label{
      margin: 12px 2px 6px;
      color: rgba(234,242,255,.65);
      font-weight: 950;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-size: 12px;
    }

    input, select, textarea{
      width:100%;
      padding:14px 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      outline: none;
      font-size: 15px;
    }
    textarea{ min-height: 90px; resize: vertical; }
    input::placeholder{color: rgba(234,242,255,.35)}
    select{appearance:none}

    .btn{
      width:100%;
      padding: 16px 16px;
      border-radius: 18px;
      border: 0;
      cursor: pointer;
      font-weight: 950;
      font-size: 16px;
      letter-spacing: .02em;
      background: linear-gradient(135deg, var(--green), var(--green2));
      color:#042019;
      box-shadow: 0 18px 45px rgba(33,230,182,.18);
      margin-top: 14px;
    }
    .btnSecondary{
      width:100%;
      padding: 14px 16px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      cursor: pointer;
      font-weight: 900;
      font-size: 15px;
      background: rgba(255,255,255,.05);
      color: var(--txt);
      margin-top: 10px;
    }
    .btnOrange{
      width:100%;
      padding: 16px 16px;
      border-radius: 18px;
      border: 0;
      cursor: pointer;
      font-weight: 950;
      font-size: 16px;
      background: linear-gradient(135deg, #ffcc5a, #f6b23a);
      color:#201400;
      margin-top: 12px;
      box-shadow: 0 18px 45px rgba(246,178,58,.18);
    }

    .status{ margin-top: 10px; font-weight: 800; color: rgba(234,242,255,.86); }

    /* chips esportes */
    .chips{ display:flex; flex-wrap:wrap; gap:10px; margin-top: 10px; }
    .chip{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-weight: 900;
      cursor: pointer;
      user-select: none;
    }
    .chip.on{
      border-color: rgba(33,230,182,.45);
      background: rgba(33,230,182,.12);
      color: var(--txt);
      box-shadow: 0 0 0 6px rgba(33,230,182,.08);
    }

    /* telas */
    .screen{
      display:none;
      margin-top: 8px;
      width:100%;
      background: var(--bg);
      padding-bottom: calc(140px + env(safe-area-inset-bottom));
    }
    .screen.active{ display:block; }

    /* nav fixo */
    .nav{
      position:fixed;
      left:0; right:0; bottom:0;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: #07121f;
      border-top: 1px solid rgba(255,255,255,.08);
      z-index: 1000;
    }
    .navInner{
      max-width: var(--max);
      margin: 0 auto;
      display:flex;
      gap:10px;
      overflow-x: auto;
      padding: 6px 6px;
      scrollbar-width: none;
    }
    .navInner::-webkit-scrollbar{display:none}
    .navBtn{
      flex:0 0 auto;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color: rgba(234,242,255,.6);
      font-weight: 950;
      padding: 12px 14px;
      border-radius: 999px;
      cursor:pointer;
      letter-spacing:.05em;
      white-space: nowrap;
    }
    .navBtn.active{
      background: rgba(33,230,182,.12);
      border-color: rgba(33,230,182,.35);
      color: var(--green);
      box-shadow: 0 0 0 6px rgba(33,230,182,.08);
    }

    /* cards dieta */
    .meal{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding: 16px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      margin-top: 12px;
    }
    .meal .title{
      font-weight: 950;
      color: var(--green);
      letter-spacing:.08em;
      text-transform: uppercase;
      font-size: 12px;
      margin-bottom: 6px;
    }
    .meal p{margin:0; color: rgba(234,242,255,.88); font-weight:750; line-height:1.35}
    .kcal{
      display:flex; align-items:center; justify-content:center;
      min-width: 88px;
      border-radius: 999px;
      border:1px solid rgba(33,230,182,.25);
      background: rgba(33,230,182,.08);
      color: var(--green);
      font-weight: 1000;
      padding: 10px 12px;
      text-align:center;
    }

    /* treino */
    .dayCard{
      margin-top: 12px;
      padding: 14px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .dayTitle{
      display:flex; align-items:center; justify-content:space-between;
      font-weight: 1000;
      color: rgba(234,242,255,.92);
      margin-bottom: 10px;
      letter-spacing:.03em;
    }
    .exercise{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding: 12px 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      margin-top: 10px;
    }
    .ytBtn{
      border:0;
      border-radius: 999px;
      padding: 10px 12px;
      background: rgba(33,230,182,.10);
      border: 1px solid rgba(33,230,182,.25);
      color: var(--green);
      font-weight: 1000;
      cursor: pointer;
      min-width: 110px;
    }

    /* loja/parceiros */
    .shopGrid{display:flex; flex-direction:column; gap:12px; margin-top: 12px}
    .shopItem{
      padding: 16px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .shopItem h3{margin:0 0 6px; font-weight: 1000}

    .partnerList{display:flex; flex-direction:column; gap:12px; margin-top:12px}
    .partnerRow{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px;
      border-radius:18px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
    }
    .partnerName{display:flex; flex-direction:column; gap:4px}
    .partnerName b{font-weight: 1000}

    /* prato */
    .plateBox{margin-top: 12px}
    .platePreview{
      width: 100%;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
      overflow:hidden;
    }
    .platePreview img{width:100%; display:block}

    .miniRow{display:flex; gap:10px; flex-wrap:wrap}
    .miniBtn{
      flex: 1 1 160px;
      padding: 14px 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--txt);
      font-weight: 900;
      cursor: pointer;
    }

    #btnTop{
      position:fixed;
      bottom:110px;
      right:18px;
      width:48px;
      height:48px;
      border-radius:50%;
      border:none;
      background:linear-gradient(135deg,#21e6b6,#17caa0);
      color:#042019;
      font-size:22px;
      font-weight:900;
      box-shadow:0 10px 25px rgba(0,0,0,.4);
      display:none;
      z-index:999;
      cursor:pointer;
    }

    .hidden{ display:none !important; }

    /* Modal Auth */
    .modalBack{
      display:none;
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      z-index: 3000;
      padding: 18px;
      overflow:auto;
    }
    .modal{
      max-width: 560px;
      margin: 32px auto;
      background: #0b1726;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      box-shadow: 0 25px 80px rgba(0,0,0,.55);
      padding: 16px;
    }
    .modalTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .xBtn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 900;
      cursor:pointer;
    }
  </style>

  <!-- Firebase CDN (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="logo" id="logoBox">E</div>
      <div class="brand">
        <small>ELITE TERMINAL</small>
        <b>Confira o Prato Elite</b>
      </div>
      <div class="pill"><span class="dot"></span><span id="authTxt">Modo: Local</span></div>
    </div>

    <!-- WELCOME -->
    <section id="viewWelcome" class="screen active">
      <div class="h1">Bem-vindo üëã</div>
      <div class="card">
        <div class="hint">
          Monte seu perfil, gere dieta e treino, e analise seu prato.
          <br><br>
          <b>Recomendado:</b> entrar com Google/Email pra salvar na nuvem (Firebase).
        </div>

        <button class="btn" type="button" onclick="openAuthModal()">Entrar / Criar conta</button>
        <button class="btnSecondary" type="button" onclick="enterGuest()">Entrar como convidado</button>

        <div id="authWarn" class="status" style="display:none"></div>
      </div>
    </section>

    <!-- CADASTRO -->
    <section id="viewCadastro" class="screen">
      <div class="h1">CADASTRO</div>

      <div class="card">
        <div class="label">Foto do perfil</div>
        <div class="row" style="align-items:center">
          <div style="width:64px;height:64px;border-radius:18px;overflow:hidden;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.2)">
            <img id="avatarImg" alt="Foto" style="width:100%;height:100%;object-fit:cover;display:none"/>
            <div id="avatarFallback" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:1000;color:rgba(234,242,255,.7)">üë§</div>
          </div>
          <div style="flex:1">
            <button class="btnSecondary" type="button" onclick="pickAvatar()">Escolher foto</button>
            <input id="avatarFile" type="file" accept="image/*" style="display:none">
            <div class="hint" style="margin-top:6px">No modo logado, salva no Firebase. Convidado: salva no aparelho.</div>
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <div class="col">
            <div class="label">Nome</div>
            <input id="nome" placeholder="Ex: Jonatan" />
          </div>
          <div class="col">
            <div class="label">Email (opcional)</div>
            <input id="emailPerfil" inputmode="email" placeholder="Ex: voce@gmail.com" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="label">Peso (kg)</div>
            <input id="peso" inputmode="decimal" placeholder="Ex: 78.5" />
          </div>
          <div class="col">
            <div class="label">Altura (cm)</div>
            <input id="altura" inputmode="numeric" placeholder="Ex: 175" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="label">Objetivo</div>
            <select id="objetivo">
              <option value="">Selecione</option>
              <option>Emagrecer</option>
              <option>Ganhar massa</option>
              <option>Manter</option>
              <option>Performance</option>
            </select>
          </div>
          <div class="col">
            <div class="label">N√≠vel</div>
            <select id="nivel">
              <option value="">Selecione</option>
              <option>Iniciante</option>
              <option>Intermedi√°rio</option>
              <option>Avan√ßado</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="label">Condi√ß√£o</div>
            <select id="condicao">
              <option value="">Selecione</option>
              <option>Saud√°vel</option>
              <option>Hipertens√£o</option>
              <option>Diabetes</option>
              <option>Les√£o / Dor</option>
            </select>
          </div>
          <div class="col">
            <div class="label">Restri√ß√£o</div>
            <select id="restricao">
              <option value="">Selecione</option>
              <option>Nenhuma</option>
              <option>Lactose</option>
              <option>Gl√∫ten</option>
              <option>Vegetariano</option>
              <option>Vegano</option>
            </select>
          </div>
        </div>

        <div class="label">Esportes (pode marcar v√°rios)</div>
        <div id="chipsEsportes" class="chips"></div>

        <div style="margin-top:10px">
          <label style="display:flex; gap:10px; align-items:center; font-weight:900; color:rgba(234,242,255,.9)">
            <input id="termo" type="checkbox" style="width:22px; height:22px"/>
            Aceito o termo (conte√∫do informativo)
          </label>
        </div>

        <button class="btn" type="button" onclick="salvarCadastro()">SALVAR / ATUALIZAR</button>
        <button class="btnSecondary" type="button" onclick="limparCadastro()">LIMPAR</button>
        <button class="btnSecondary" type="button" onclick="sair()">SAIR</button>

        <div id="outCadastro" class="status" style="display:none"></div>
      </div>

      <div class="card plateBox" style="margin-top:14px">
        <div class="label">An√°lise do prato (demo)</div>
        <div class="hint">Enviar foto ‚Üí analisar ‚Üí revisar/editar ‚Üí confirmar (salva hist√≥rico).</div>

        <div class="miniRow" style="margin-top:12px">
          <button class="miniBtn" type="button" id="btnCamera">Tirar foto</button>
          <button class="miniBtn" type="button" id="btnGaleria">Escolher da galeria</button>
        </div>

        <input id="fileCamera" type="file" accept="image/*" capture="environment" style="display:none">
        <input id="fileGaleria" type="file" accept="image/*" style="display:none">

        <div class="platePreview" id="platePreview" style="margin-top:12px; display:none">
          <img id="plateImg" alt="Prato"/>
        </div>

        <button class="btnSecondary" type="button" onclick="analisarPrato()">Analisar (demo)</button>
        <div id="plateResult" class="status" style="display:none"></div>

        <div id="plateConfirmBox" style="display:none; margin-top:10px">
          <div class="label">Confirma√ß√£o</div>
          <div class="hint">Edite antes de confirmar:</div>
          <textarea id="plateEdit"></textarea>
          <button class="btn" type="button" onclick="confirmarPrato()">Confirmar</button>
          <button class="btnSecondary" type="button" onclick="refazerAnalise()">Refazer</button>
        </div>
      </div>
    </section>

    <!-- DIETA -->
    <section id="viewDieta" class="screen">
      <div class="h1">DIETA</div>
      <div class="card">
        <div class="hint">Sugest√µes simples. Se n√£o gostar, clique em <b>Refazer</b>.</div>
        <button class="btn" type="button" onclick="gerarDieta()">GERAR DIETA</button>
        <button class="btnSecondary" type="button" onclick="gerarDieta()">REFAZER / TROCAR</button>
        <div id="dietaBox"></div>
      </div>
    </section>

    <!-- TREINO -->
    <section id="viewTreino" class="screen">
      <div class="h1">TREINO</div>
      <div class="card">
        <div class="hint">Treino semanal. Cada exerc√≠cio tem bot√£o ‚ÄúYouTube‚Äù.</div>

        <div class="row" style="margin-top:10px">
          <div class="col">
            <div class="label">Tema</div>
            <select id="temaTreino">
              <option>Academia</option>
              <option>Corrida</option>
              <option>Muay Thai</option>
              <option>Futebol</option>
              <option>Basquete</option>
            </select>
          </div>
          <div class="col">
            <div class="label">Intensidade</div>
            <select id="intTreino">
              <option>Leve</option>
              <option>Moderado</option>
              <option>Pesado</option>
            </select>
          </div>
        </div>

        <button class="btn" type="button" onclick="gerarTreino()">GERAR TREINO DA SEMANA</button>
        <button class="btnSecondary" type="button" onclick="limparTreino()">LIMPAR TREINO</button>

        <div id="outTreino" class="status" style="display:none"></div>
        <div id="treinoSemana"></div>
      </div>
    </section>

    <!-- LOJA -->
    <section id="viewLoja" class="screen">
      <div class="h1">LOJA</div>
      <div class="card">
        <div class="hint">Categorias do app. Clique em parceiros para abrir sites oficiais.</div>
        <div class="shopGrid">
          <div class="shopItem">
            <h3>Suplementos</h3>
            <p class="muted">Whey, creatina, vitaminas e pr√©-treinos.</p>
            <button class="btnSecondary" type="button" onclick="switchView('parceiros')">Ver parceiros</button>
          </div>
          <div class="shopItem">
            <h3>Roupas fitness</h3>
            <p class="muted">T√™nis, camisetas, shorts e roupas de treino.</p>
            <button class="btnSecondary" type="button" onclick="switchView('parceiros')">Ver parceiros</button>
          </div>
          <div class="shopItem">
            <h3>Equipamentos</h3>
            <p class="muted">Acess√≥rios: el√°sticos, corda, luvas, etc.</p>
            <button class="btnSecondary" type="button" onclick="switchView('parceiros')">Ver parceiros</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PARCEIROS -->
    <section id="viewParceiros" class="screen">
      <div class="h1">PARCEIROS</div>
      <div class="card">
        <div class="hint">Sites oficiais (por enquanto). Depois voc√™ troca por links afiliados.</div>
        <div class="partnerList">
          <div class="partnerRow">
            <div class="partnerName"><b>Growth</b><div class="muted">Suplementos</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.gsuplementos.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Max Titanium</b><div class="muted">Nutri√ß√£o esportiva</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.maxtitanium.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Nike</b><div class="muted">Roupas e t√™nis</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.nike.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Adidas</b><div class="muted">Performance</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.adidas.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Mercado Livre</b><div class="muted">Acess√≥rios</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.mercadolivre.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Shopee</b><div class="muted">Produtos fitness</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://shopee.com.br')">Abrir</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PREMIUM -->
    <section id="viewPremium" class="screen">
      <div class="h1">PREMIUM</div>
      <div class="card">
        <div style="font-size:28px;font-weight:1000;color:var(--orange);margin:0 0 6px">ASSINATURA ELITE</div>
        <div class="hint">Pagamento abre no Mercado Pago.</div>

        <div class="card" style="margin-top:12px;background:rgba(255,255,255,.03)">
          <div class="label">Plano</div>
          <div style="font-weight:1000; font-size:18px">Elite Premium ‚Äî R$ 29,90/m√™s</div>
          <div class="muted" style="margin-top:8px">Benef√≠cios: recursos avan√ßados e novidades.</div>
        </div>

        <button class="btnOrange" type="button" onclick="openCheckout()">CONFIRMAR R$ 29,90/M√äS</button>
      </div>
    </section>

    <!-- SA√öDE -->
    <section id="viewSaude" class="screen">
      <div class="h1">SA√öDE</div>
      <div class="card">
        <div class="hint">Conte√∫do educativo. N√£o substitui m√©dico.</div>
        <div class="meal" style="margin-top:14px">
          <div>
            <div class="title">Anabolizantes (aviso)</div>
            <p>Podem afetar cora√ß√£o, press√£o, colesterol, f√≠gado, humor e horm√¥nios. Procure acompanhamento m√©dico.</p>
          </div>
        </div>
        <button class="btnSecondary" type="button" onclick="abrirLink('https://bvsms.saude.gov.br/')">Ler mais</button>
      </div>
    </section>

    <!-- CONVITES -->
    <section id="viewConvites" class="screen">
      <div class="h1">CONVITES</div>
      <div class="card">
        <div class="hint">
          Ganhe <b>R$ 5</b> por cada pessoa que assinar usando seu link (demo).
          Ao atingir <b>R$ 50</b>, pode solicitar saque (demo).
        </div>

        <div class="card" style="margin-top:12px;background:rgba(255,255,255,.03)">
          <div class="label">Seu c√≥digo</div>
          <div id="myCode" style="font-weight:1000; font-size:18px">‚Äî</div>

          <div class="label" style="margin-top:12px">Seu link</div>
          <div id="myLink" class="muted" style="word-break:break-all">‚Äî</div>

          <div class="label" style="margin-top:12px">Saldo</div>
          <div id="balTxt" style="font-weight:1000; font-size:18px">R$ 0,00</div>
          <div id="progressTxt" class="muted" style="margin-top:6px"></div>

          <div class="miniRow" style="margin-top:12px">
            <button class="miniBtn" type="button" onclick="copyInviteLink()">Copiar link</button>
            <button class="miniBtn" type="button" onclick="shareInvite()">Compartilhar</button>
          </div>

          <button id="btnSaque" class="btnSecondary" type="button" style="margin-top:10px" onclick="solicitarSaque()" disabled>
            Solicitar saque (m√≠n. R$ 50)
          </button>

          <div class="miniRow" style="margin-top:10px">
            <button class="miniBtn" type="button" onclick="setBalance(getBalance()+5)">+R$5 (teste)</button>
            <button class="miniBtn" type="button" onclick="setBalance(0)">Zerar (teste)</button>
          </div>
        </div>
      </div>
    </section>

  </div>

  <!-- NAV -->
  <div class="nav" id="navBar">
    <div class="navInner">
      <button class="navBtn active" data-view="welcome" type="button">IN√çCIO</button>
      <button class="navBtn" data-view="cadastro" type="button">CADASTRO</button>
      <button class="navBtn" data-view="dieta" type="button">DIETA</button>
      <button class="navBtn" data-view="treino" type="button">TREINO</button>
      <button class="navBtn" data-view="loja" type="button">LOJA</button>
      <button class="navBtn" data-view="parceiros" type="button">PARCEIROS</button>
      <button class="navBtn" data-view="premium" type="button">PREMIUM</button>
      <button class="navBtn" data-view="saude" type="button">SA√öDE</button>
      <button class="navBtn" data-view="convites" type="button">CONVITES</button>
    </div>
  </div>

  <button id="btnTop" onclick="scrollToTop()">‚Üë</button>

  <!-- AUTH MODAL -->
  <div class="modalBack" id="authModal">
    <div class="modal">
      <div class="modalTop">
        <b style="font-size:18px">Entrar / Criar conta</b>
        <button class="xBtn" onclick="closeAuthModal()">X</button>
      </div>

      <div class="hint" style="margin-top:10px">
        Se o Google/Email n√£o funcionar, revise: <b>Authentication ‚Üí Sign-in method</b> e <b>Authorized domains</b>.
      </div>

      <button class="btn" type="button" onclick="loginGoogle()">Entrar com Google</button>

      <div class="label">Email</div>
      <input id="authEmail" placeholder="seuemail@gmail.com" inputmode="email"/>
      <div class="label">Senha</div>
      <input id="authPass" placeholder="Senha" type="password"/>

      <button class="btnSecondary" type="button" onclick="loginEmail()">Entrar com Email</button>
      <button class="btnSecondary" type="button" onclick="criarContaEmail()">Criar conta Email</button>

      <div id="authMsg" class="status" style="display:none"></div>

      <button class="btnSecondary" type="button" onclick="logoutFirebase()" style="margin-top:14px">Sair do login</button>
    </div>
  </div>

  <script>
    // PWA (n√£o quebra se n√£o existir)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    }

    // Helpers
    const $ = (id)=> document.getElementById(id);
    function abrirLink(url){ window.open(url, "_blank"); }
    function openYT(query){
      const q = encodeURIComponent(query);
      window.open(`https://www.youtube.com/results?search_query=${q}`, "_blank");
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"]/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m]));
    }

    // Keys
    const KEY_PROFILE = "checkprato_profile_v3";
    const KEY_AVATAR  = "checkprato_avatar_v3";
    const KEY_PLATE   = "checkprato_plate_v3";
    const KEY_PLATE_HASH = "checkprato_plate_hash_v3";
    const KEY_PLATE_HISTORY = "checkprato_plate_history_v1";
    const KEY_DIETA   = "checkprato_dieta_v3";
    const KEY_TREINO  = "checkprato_treino_v3";
    const KEY_GUEST   = "checkprato_guest_v1";
    const KEY_INV_CODE = "checkprato_inv_code_v1";
    const KEY_BAL = "checkprato_inv_balance_v1";

    // Premium
    const PREMIUM_CHECKOUT_URL = "https://mpago.la/2BRjpaP";
    function openCheckout(){ window.open(PREMIUM_CHECKOUT_URL, "_blank"); }

   // Import the functions you need from the SDKs you need
   import { initializeApp } from "firebase/app";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAc2hFDkeW9mZVmJ_3Lort0rUQFWabu6tQ",
  authDomain: "checkpratoapp-e60a8.firebaseapp.com",
  projectId: "checkpratoapp-e60a8",
  storageBucket: "checkpratoapp-e60a8.firebasestorage.app",
  messagingSenderId: "329070523974",
  appId: "1:329070523974:web:c4fbffff9e2c7660413c47"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);

    let firebaseEnabled = false;
    let auth = null;
    let db = null;
    let currentUser = null;

    function setAuthBadge(txt){
      const el = $("authTxt");
      if(el) el.textContent = txt;
    }

    function showAuthMsg(msg){
      const el = $("authMsg");
      if(!el) return;
      el.style.display = "block";
      el.textContent = msg;
    }

    function initFirebaseIfPossible(){
      try{
        const hasKeys = FIREBASE_CONFIG && FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.projectId && FIREBASE_CONFIG.authDomain;
        if(!hasKeys){
          firebaseEnabled = false;
          setAuthBadge("Modo: Local");
          return;
        }

        // Evita erro de "already exists"
        if(!firebase.apps.length){
          firebase.initializeApp(FIREBASE_CONFIG);
        }

        auth = firebase.auth();
        db = firebase.firestore();
        firebaseEnabled = true;

        // Redirect result (mobile geralmente usa redirect melhor que popup)
        auth.getRedirectResult().catch(()=>{});

        auth.onAuthStateChanged(async (user)=>{
          currentUser = user || null;
          if(currentUser){
            localStorage.removeItem(KEY_GUEST);
            setAuthBadge(`Logado: ${currentUser.email || "Google"}`);
            await syncFromCloud(); // puxa nuvem
            enterApp();
          }else{
            // se n√£o estiver convidado, volta pro welcome
            if(!localStorage.getItem(KEY_GUEST)){
              setAuthBadge("Modo: Local");
              showOnly("viewWelcome");
            }
          }
        });

      }catch(e){
        firebaseEnabled = false;
        console.log("Firebase init error:", e);
        setAuthBadge("Modo: Local");
        const warn = $("authWarn");
        if(warn){
          warn.style.display="block";
          warn.textContent = "‚ö†Ô∏è Firebase n√£o inicializou. O app continua no modo local.";
        }
      }
    }

    async function syncToCloud(){
      if(!firebaseEnabled || !db || !currentUser) return;
      const uid = currentUser.uid;

      const profile = safeJsonParse(localStorage.getItem(KEY_PROFILE));
      const avatar = localStorage.getItem(KEY_AVATAR) || null;
      const dieta  = safeJsonParse(localStorage.getItem(KEY_DIETA));
      const treino = safeJsonParse(localStorage.getItem(KEY_TREINO));
      const plates = safeJsonParse(localStorage.getItem(KEY_PLATE_HISTORY)) || [];

      // evita estourar firestore com avatar gigante
      const avatarOk = avatar && avatar.length < 250000 ? avatar : null;

      await db.collection("users").doc(uid).set({
        profile: profile || null,
        avatar: avatarOk,
        dieta: dieta || null,
        treino: treino || null,
        plates: plates || [],
        updatedAt: Date.now()
      }, { merge:true });
    }

    async function syncFromCloud(){
      if(!firebaseEnabled || !db || !currentUser) return;
      const uid = currentUser.uid;

      const snap = await db.collection("users").doc(uid).get();
      if(!snap.exists) return;

      const data = snap.data() || {};
      if(data.profile) localStorage.setItem(KEY_PROFILE, JSON.stringify(data.profile));
      if(data.avatar) localStorage.setItem(KEY_AVATAR, data.avatar);
      if(data.dieta) localStorage.setItem(KEY_DIETA, JSON.stringify(data.dieta));
      if(data.treino) localStorage.setItem(KEY_TREINO, JSON.stringify(data.treino));
      if(Array.isArray(data.plates)) localStorage.setItem(KEY_PLATE_HISTORY, JSON.stringify(data.plates));

      // reaplica UI
      aplicarCadastroNaTela();
      loadAvatar();
      renderDieta(carregarDieta());
      renderTreino(carregarTreino());
    }

    function safeJsonParse(s){
      try{ return JSON.parse(s || "null"); }catch{ return null; }
    }

    // Auth UI
    function openAuthModal(){
      if(!firebaseEnabled){
        const warn = $("authWarn");
        if(warn){
          warn.style.display="block";
          warn.textContent = "‚ö†Ô∏è Firebase ainda n√£o est√° configurado (cole o firebaseConfig e habilite Google/Email no console). Use Convidado por enquanto.";
        }
        // Mesmo assim abre modal pra voc√™ ver campos
      }
      $("authModal").style.display = "block";
      showAuthMsg("");
      $("authMsg").style.display = "none";
    }
    function closeAuthModal(){ $("authModal").style.display = "none"; }

    async function loginGoogle(){
      if(!firebaseEnabled || !auth){
        showAuthMsg("Firebase n√£o est√° pronto. Use Convidado ou finalize a configura√ß√£o.");
        return;
      }
      try{
        const provider = new firebase.auth.GoogleAuthProvider();
        // Mobile: redirect √© mais confi√°vel
        await auth.signInWithRedirect(provider);
      }catch(e){
        console.log(e);
        showAuthMsg("Erro no Google login: " + (e.message || e.code || "desconhecido"));
      }
    }

    async function loginEmail(){
      if(!firebaseEnabled || !auth){
        showAuthMsg("Firebase n√£o est√° pronto. Use Convidado ou finalize a configura√ß√£o.");
        return;
      }
      const email = ($("authEmail").value || "").trim();
      const pass  = ($("authPass").value || "").trim();
      if(!email || !pass){ showAuthMsg("Preencha email e senha."); return; }
      try{
        await auth.signInWithEmailAndPassword(email, pass);
        closeAuthModal();
      }catch(e){
        console.log(e);
        showAuthMsg("Erro: " + (e.message || e.code || "desconhecido"));
      }
    }

    async function criarContaEmail(){
      if(!firebaseEnabled || !auth){
        showAuthMsg("Firebase n√£o est√° pronto. Use Convidado ou finalize a configura√ß√£o.");
        return;
      }
      const email = ($("authEmail").value || "").trim();
      const pass  = ($("authPass").value || "").trim();
      if(!email || !pass){ showAuthMsg("Preencha email e senha."); return; }
      try{
        await auth.createUserWithEmailAndPassword(email, pass);
        closeAuthModal();
      }catch(e){
        console.log(e);
        showAuthMsg("Erro: " + (e.message || e.code || "desconhecido"));
      }
    }

    async function logoutFirebase(){
      if(!firebaseEnabled || !auth){
        showAuthMsg("Voc√™ j√° est√° no modo local.");
        return;
      }
      await auth.signOut();
      showAuthMsg("Saiu do login.");
    }

    function sair(){
      // Se estiver logado, sai do Firebase. Se for guest, s√≥ volta pro welcome.
      if(firebaseEnabled && auth && currentUser){
        auth.signOut().catch(()=>{});
      }
      localStorage.removeItem(KEY_GUEST);
      setAuthBadge("Modo: Local");
      showOnly("viewWelcome");
    }

    // ---------- APP ----------
    const ESPORTES = ["Muscula√ß√£o","Futebol","Corrida","Crossfit","Ciclismo","Nata√ß√£o","Luta","Basquete","V√¥lei","Yoga","Pilates","Caminhada"];
    let selectedSports = new Set();

    function carregarCadastro(){ return safeJsonParse(localStorage.getItem(KEY_PROFILE)); }

    function aplicarCadastroNaTela(){
      const p = carregarCadastro();
      if(!p) return;
      $("nome").value = p.nome || "";
      $("emailPerfil").value = p.email || "";
      $("peso").value = p.peso || "";
      $("altura").value = p.altura || "";
      $("objetivo").value = p.objetivo || "";
      $("nivel").value = p.nivel || "";
      $("condicao").value = p.condicao || "";
      $("restricao").value = p.restricao || "";
      $("termo").checked = true;
    }

    function buildSportsChips(){
      const box = $("chipsEsportes");
      box.innerHTML = "";
      ESPORTES.forEach(name=>{
        const div = document.createElement("div");
        div.className = "chip";
        div.textContent = name;
        div.addEventListener("click", ()=>{
          if(selectedSports.has(name)) selectedSports.delete(name);
          else selectedSports.add(name);
          div.classList.toggle("on");
        });
        box.appendChild(div);
      });

      const p = carregarCadastro();
      if(p && Array.isArray(p.esportes)){
        selectedSports = new Set(p.esportes);
        [...box.querySelectorAll(".chip")].forEach(ch=>{
          if(selectedSports.has(ch.textContent)) ch.classList.add("on");
        });
      }
    }

    async function salvarCadastro(){
      if(!$("termo").checked){ alert("Marque o termo para salvar."); return; }

      const perfil = {
        nome: ($("nome").value || "").trim(),
        email: ($("emailPerfil").value || "").trim(),
        peso: ($("peso").value || "").trim(),
        altura: ($("altura").value || "").trim(),
        objetivo: $("objetivo").value || "",
        nivel: $("nivel").value || "",
        condicao: $("condicao").value || "",
        restricao: $("restricao").value || "",
        esportes: Array.from(selectedSports),
        updatedAt: Date.now()
      };

      localStorage.setItem(KEY_PROFILE, JSON.stringify(perfil));
      const out = $("outCadastro");
      out.style.display="block";
      out.textContent="‚úÖ Cadastro salvo.";

      // se logado, salva na nuvem
      try{ await syncToCloud(); }catch(e){ console.log(e); }
    }

    function limparCadastro(){
      localStorage.removeItem(KEY_PROFILE);
      ["nome","emailPerfil","peso","altura"].forEach(id=> $(id).value="");
      ["objetivo","nivel","condicao","restricao"].forEach(id=> $(id).value="");
      $("termo").checked = false;
      selectedSports = new Set();
      buildSportsChips();
      $("outCadastro").style.display="block";
      $("outCadastro").textContent="üßπ Cadastro limpo.";
    }

    // Avatar
    function pickAvatar(){ $("avatarFile").click(); }
    function setAvatar(dataUrl){
      localStorage.setItem(KEY_AVATAR, dataUrl);
      $("avatarImg").src = dataUrl;
      $("avatarImg").style.display="block";
      $("avatarFallback").style.display="none";
      $("logoBox").innerHTML = `<img src="${dataUrl}" alt="logo">`;
    }
    function loadAvatar(){
      const dataUrl = localStorage.getItem(KEY_AVATAR);
      if(dataUrl) setAvatar(dataUrl);
    }
    function wireAvatar(){
      $("avatarFile").addEventListener("change", async ()=>{
        const file = $("avatarFile").files?.[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = async ()=>{
          const dataUrl = String(r.result||"");
          setAvatar(dataUrl);
          try{ await syncToCloud(); }catch(e){ console.log(e); }
        };
        r.readAsDataURL(file);
      });
    }

    // Plate
    function wirePlateInput(){
      $("btnCamera").addEventListener("click", ()=> $("fileCamera").click());
      $("btnGaleria").addEventListener("click", ()=> $("fileGaleria").click());

      function onFile(file){
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          const dataUrl = String(reader.result || "");
          localStorage.setItem(KEY_PLATE, dataUrl);
          showPlate(dataUrl);
        };
        reader.readAsDataURL(file);
      }

      $("fileCamera").addEventListener("change", ()=> onFile($("fileCamera").files?.[0]));
      $("fileGaleria").addEventListener("change", ()=> onFile($("fileGaleria").files?.[0]));
    }

    function showPlate(dataUrl){
      $("plateImg").src = dataUrl;
      $("platePreview").style.display = "block";
    }
    function loadLastPlate(){
      const dataUrl = localStorage.getItem(KEY_PLATE);
      if(dataUrl) showPlate(dataUrl);
    }

    function simpleHash(str){
      let h = 0;
      for(let i=0;i<str.length;i++){
        h = (h<<5) - h + str.charCodeAt(i);
        h |= 0;
      }
      return String(h);
    }

    function analisarPrato(){
      const dataUrl = localStorage.getItem(KEY_PLATE);
      if(!dataUrl){
        $("plateResult").style.display="block";
        $("plateResult").textContent="Envie uma foto primeiro.";
        $("plateConfirmBox").style.display="none";
        return;
      }

      const hash = simpleHash(dataUrl.slice(0, 4000));
      const lastHash = localStorage.getItem(KEY_PLATE_HASH);
      if(lastHash && lastHash === hash){
        $("plateResult").style.display="block";
        $("plateResult").textContent="‚ö†Ô∏è Parece a mesma foto de antes. Troque a imagem para nova an√°lise.";
        $("plateConfirmBox").style.display="none";
        return;
      }

      const p = carregarCadastro() || {};
      const objetivo = (p.objetivo || "Manter").toLowerCase();

      let desc = "Arroz, feij√£o, prote√≠na (ex: frango) e salada.";
      let kcal = 650;
      if(objetivo.includes("emag")) kcal = 520;
      if(objetivo.includes("massa")) kcal = 820;

      $("plateResult").style.display="block";
      $("plateResult").textContent = `‚úÖ (DEMO) Identificado: ${desc}\nEstimativa: ~${kcal} kcal.`;

      $("plateEdit").value = `Prato: ${desc}\nKcal estimada: ${kcal} kcal`;
      $("plateConfirmBox").style.display="block";
    }

    function refazerAnalise(){
      $("plateResult").style.display="none";
      $("plateConfirmBox").style.display="none";
    }

    async function confirmarPrato(){
      const edit = $("plateEdit").value.trim();
      const dataUrl = localStorage.getItem(KEY_PLATE);
      if(!edit || !dataUrl) return;

      const hash = simpleHash(dataUrl.slice(0, 4000));
      localStorage.setItem(KEY_PLATE_HASH, hash);

      const item = { at: Date.now(), text: edit };
      let hist = safeJsonParse(localStorage.getItem(KEY_PLATE_HISTORY)) || [];
      hist.unshift(item);
      hist = hist.slice(0, 20);
      localStorage.setItem(KEY_PLATE_HISTORY, JSON.stringify(hist));

      alert("‚úÖ Prato confirmado e salvo.");
      $("plateConfirmBox").style.display="none";

      try{ await syncToCloud(); }catch(e){ console.log(e); }
    }

    // Dieta
    const DIETAS_BASE = [
      [
        {t:"Caf√© da manh√£", d:"Omelete de 2 ovos + 1 fruta.", k:320},
        {t:"Almo√ßo", d:"Frango + arroz + feij√£o + salada.", k:550},
        {t:"Jantar", d:"Peixe + legumes + batata-doce.", k:480},
      ],
      [
        {t:"Caf√© da manh√£", d:"3 ovos + aveia + banana.", k:550},
        {t:"Almo√ßo", d:"Arroz + feij√£o + carne magra + br√≥colis.", k:780},
        {t:"Jantar", d:"Macarr√£o integral + patinho + salada.", k:720},
      ],
      [
        {t:"Caf√© da manh√£", d:"Tapioca com queijo + caf√©.", k:420},
        {t:"Almo√ßo", d:"Carne magra + mandioca + salada.", k:720},
        {t:"Jantar", d:"Omelete + legumes.", k:460},
      ]
    ];
    function salvarDieta(d){ localStorage.setItem(KEY_DIETA, JSON.stringify(d)); }
    function carregarDieta(){ return safeJsonParse(localStorage.getItem(KEY_DIETA)); }
    function gerarDieta(){
      const d = DIETAS_BASE[Math.floor(Math.random()*DIETAS_BASE.length)];
      salvarDieta(d);
      renderDieta(d);
      syncToCloud().catch(()=>{});
    }
    function renderDieta(d){
      const box = $("dietaBox");
      box.innerHTML = "";
      if(!d){
        const s = document.createElement("div");
        s.className="status";
        s.textContent="Gere uma dieta para aparecer aqui.";
        box.appendChild(s);
        return;
      }
      d.forEach(m=>{
        const div = document.createElement("div");
        div.className="meal";
        div.innerHTML = `
          <div>
            <div class="title">${escapeHtml(m.t)}</div>
            <p>${escapeHtml(m.d)}</p>
          </div>
          <div class="kcal">${Number(m.k||0)}<br/>kcal</div>
        `;
        box.appendChild(div);
      });
    }

    // Treino
    const TREINOS = {
      "Academia": [
        ["Segunda", ["Agachamento livre","Supino reto","Remada curvada"]],
        ["Quarta", ["Desenvolvimento","Puxada na barra","Eleva√ß√£o lateral"]],
        ["Sexta", ["Levantamento terra","Leg press","Prancha"]],
      ],
      "Corrida": [
        ["Segunda", ["Corrida leve 30 min","Mobilidade"]],
        ["Quarta", ["Tiros 8x 200m","Alongamento"]],
        ["Sexta", ["Corrida moderada 40 min","Core"]],
      ],
      "Muay Thai":[
        ["Ter√ßa", ["Sombra 10 min","Chutes b√°sicos","Combina√ß√µes"]],
        ["Quinta", ["Manopla (drills)","Defesas","Condicionamento"]],
        ["S√°bado", ["Clinch","Sequ√™ncias","Alongamento"]],
      ],
      "Futebol":[
        ["Segunda", ["Arranque","Controle de bola","Finaliza√ß√£o"]],
        ["Quarta", ["Agilidade","Passe e dom√≠nio","Resist√™ncia"]],
        ["Sexta", ["Jogo reduzido","Alongamento"]],
      ],
      "Basquete":[
        ["Ter√ßa", ["Drible","Arremessos","Pliometria"]],
        ["Quinta", ["Defesa lateral","Bandejas","Condicionamento"]],
        ["S√°bado", ["Treino de jogo","Alongamento"]],
      ]
    };
    function salvarTreino(t){ localStorage.setItem(KEY_TREINO, JSON.stringify(t)); }
    function carregarTreino(){ return safeJsonParse(localStorage.getItem(KEY_TREINO)); }
    function gerarTreino(){
      const tema = $("temaTreino").value || "Academia";
      const intensidade = $("intTreino").value || "Moderado";
      const base = TREINOS[tema] || TREINOS["Academia"];
      const plano = { tema, intensidade, dias: base, createdAt: Date.now() };
      salvarTreino(plano);
      renderTreino(plano);
      $("outTreino").style.display="block";
      $("outTreino").textContent = `‚úÖ Treino salvo: ${tema} (${intensidade}).`;
      syncToCloud().catch(()=>{});
    }
    function limparTreino(){
      localStorage.removeItem(KEY_TREINO);
      $("treinoSemana").innerHTML="";
      $("outTreino").style.display="block";
      $("outTreino").textContent="üßπ Treino removido.";
      syncToCloud().catch(()=>{});
    }
    function renderTreino(t){
      const box = $("treinoSemana");
      box.innerHTML = "";
      if(!t){
        const s = document.createElement("div");
        s.className="status";
        s.textContent="Gere um treino para aparecer aqui.";
        box.appendChild(s);
        return;
      }
      t.dias.forEach(d=>{
        const day = document.createElement("div");
        day.className="dayCard";
        day.innerHTML = `<div class="dayTitle"><span>${escapeHtml(d[0])}</span><span class="muted">${escapeHtml(t.tema)}</span></div>`;
        (d[1]||[]).forEach(ex=>{
          const row = document.createElement("div");
          row.className="exercise";
          const left = document.createElement("div");
          left.innerHTML = `<b>${escapeHtml(ex)}</b><div class="muted" style="font-size:12px; margin-top:4px">${escapeHtml(t.intensidade)}</div>`;
          const btn = document.createElement("button");
          btn.className="ytBtn";
          btn.textContent="Ver t√©cnica";
          btn.addEventListener("click", ()=> openYT(`${ex} como fazer`));
          row.appendChild(left);
          row.appendChild(btn);
          day.appendChild(row);
        });
        box.appendChild(day);
      });
    }

    // Convites (demo)
    function getOrCreateInviteCode(){
      let code = localStorage.getItem(KEY_INV_CODE);
      if(code) return code;
      code = "ELITE-" + Math.random().toString(16).slice(2,8).toUpperCase();
      localStorage.setItem(KEY_INV_CODE, code);
      return code;
    }
    function getMyInviteLink(){
      const code = getOrCreateInviteCode();
      const url = new URL(location.href);
      url.searchParams.set("ref", code);
      return url.toString();
    }
    function getBalance(){ return Number(localStorage.getItem(KEY_BAL) || "0"); }
    function setBalance(v){ localStorage.setItem(KEY_BAL, String(v)); renderInviteUI(); }
    async function copyInviteLink(){
      const link = getMyInviteLink();
      try{ await navigator.clipboard.writeText(link); alert("‚úÖ Link copiado!"); }
      catch{ prompt("Copie o link:", link); }
    }
    function shareInvite(){
      const link = getMyInviteLink();
      const text = `Baixa o Confira o Prato Elite e usa meu link: ${link}`;
      if(navigator.share){
        navigator.share({ title:"Confira o Prato Elite", text, url: link }).catch(()=>{});
      }else{
        copyInviteLink();
      }
    }
    function solicitarSaque(){
      const bal = getBalance();
      if(bal < 50){ alert("Ainda n√£o atingiu o m√≠nimo de R$ 50."); return; }
      alert("‚úÖ Solicita√ß√£o de saque registrada (DEMO). Pix/QR entra quando ligar o sistema real.");
    }
    function renderInviteUI(){
      const code = getOrCreateInviteCode();
      const link = getMyInviteLink();
      const bal = getBalance();
      const falta = Math.max(0, 50 - bal);

      $("myCode").textContent = code;
      $("myLink").textContent = link;
      $("balTxt").textContent = new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(bal);
      $("progressTxt").textContent = bal >= 50
        ? "‚úÖ Voc√™ atingiu R$ 50! Pode solicitar saque."
        : `Faltam ${new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(falta)} para atingir R$ 50.`;

      const btn = $("btnSaque");
      btn.disabled = bal < 50;
      btn.textContent = bal >= 50 ? "Solicitar saque" : "Solicitar saque (m√≠n. R$ 50)";
    }

    // NAV
    function showOnly(id){
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      const el = $(id);
      if(el) el.classList.add("active");
    }

    function switchView(view){
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      document.querySelectorAll(".navBtn").forEach(b => b.classList.remove("active"));

      const map = {
        welcome:"viewWelcome",
        cadastro:"viewCadastro",
        dieta:"viewDieta",
        treino:"viewTreino",
        loja:"viewLoja",
        parceiros:"viewParceiros",
        premium:"viewPremium",
        saude:"viewSaude",
        convites:"viewConvites",
      };

      const id = map[view];
      if(id) showOnly(id);

      const btn = document.querySelector(`.navBtn[data-view="${view}"]`);
      if(btn) btn.classList.add("active");

      scrollToTop(false);
    }

    function wireNav(){
      document.querySelectorAll(".navBtn").forEach(btn=>{
        btn.addEventListener("click", ()=> switchView(btn.dataset.view));
      });
    }

    // Guest / App
    function enterGuest(){
      localStorage.setItem(KEY_GUEST, "1");
      setAuthBadge("Modo: Local");
      enterApp();
      switchView("cadastro");
    }

    function enterApp(){
      // garante que nav existe sempre
      $("navBar").classList.remove("hidden");
      switchView("cadastro");
    }

    // Modal
    function openAuthModal(){ $("authModal").style.display="block"; }
    function closeAuthModal(){ $("authModal").style.display="none"; }

    // Scroll topo
    function scrollToTop(smooth=true){
      window.scrollTo({ top: 0, behavior: smooth ? "smooth" : "auto" });
    }
    function updateTopBtn(){
      const btn = $("btnTop");
      btn.style.display = (window.scrollY > 220) ? "block" : "none";
    }

    // Init
    function init(){
      wireNav();
      wireAvatar();
      loadAvatar();
      aplicarCadastroNaTela();
      buildSportsChips();
      wirePlateInput();
      loadLastPlate();
      renderDieta(carregarDieta());
      renderTreino(carregarTreino());
      renderInviteUI();

      // Firebase seguro (n√£o quebra app)
      initFirebaseIfPossible();

      // Se j√° era guest
      if(localStorage.getItem(KEY_GUEST)){
        enterApp();
      }else{
        // mant√©m welcome por padr√£o
        showOnly("viewWelcome");
      }

      window.addEventListener("scroll", updateTopBtn);
      updateTopBtn();
    }

    // Expor fun√ß√µes
    window.switchView = switchView;
    window.salvarCadastro = salvarCadastro;
    window.limparCadastro = limparCadastro;
    window.pickAvatar = pickAvatar;
    window.analisarPrato = analisarPrato;
    window.refazerAnalise = refazerAnalise;
    window.confirmarPrato = confirmarPrato;
    window.gerarDieta = gerarDieta;
    window.gerarTreino = gerarTreino;
    window.limparTreino = limparTreino;
    window.openCheckout = openCheckout;
    window.copyInviteLink = copyInviteLink;
    window.shareInvite = shareInvite;
    window.setBalance = setBalance;
    window.getBalance = getBalance;
    window.solicitarSaque = solicitarSaque;
    window.enterGuest = enterGuest;
    window.openAuthModal = openAuthModal;
    window.closeAuthModal = closeAuthModal;
    window.loginGoogle = loginGoogle;
    window.loginEmail = loginEmail;
    window.criarContaEmail = criarContaEmail;
    window.logoutFirebase = logoutFirebase;
    window.sair = sair;
    window.scrollToTop = scrollToTop;

    init();
  </script>
</body>
</html>
