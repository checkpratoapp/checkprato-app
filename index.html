<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CheckPrato ‚Ä¢ Elite</title>

  <meta name="theme-color" content="#0a1320"/>
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" sizes="192x192" href="./icon-192.png">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <!-- Chart (Gr√°fico) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#07121f;
      --bg2:#0b2033;
      --card:rgba(255,255,255,.04);
      --card2:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.08);
      --txt:#eaf2ff;
      --muted:rgba(234,242,255,.72);
      --green:#21e6b6;
      --green2:#17caa0;
      --orange:#f6b23a;
      --shadow:0 20px 60px rgba(0,0,0,.45);
      --r:22px;
      --max:560px;

      --glass: rgba(255,255,255,.06);
      --stroke3d: rgba(255,255,255,.10);
      --shadow3d: 0 24px 70px rgba(0,0,0,.55);
    }
/* ===== WELCOME + MANUAL ===== */
.welcomeHero{
  border-radius: 26px;
  border: 1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(700px 280px at 20% 10%, rgba(33,230,182,.18), transparent 60%),
    radial-gradient(600px 260px at 80% 30%, rgba(246,178,58,.14), transparent 62%),
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  box-shadow: 0 22px 70px rgba(0,0,0,.55);
  padding: 16px;
  overflow:hidden;
}

.wCarousel{
  position: relative;
  border-radius: 22px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.18);
  overflow: hidden;
  min-height: 260px;
}

.wSlide{
  display:none;
  padding: 18px 16px 16px;
  min-height: 260px;
  position: relative;
}

.wSlide.active{ display:block; }

.wBg{
  position:absolute; inset:0;
  opacity:.9;
  background:
    radial-gradient(900px 340px at 20% 20%, rgba(33,230,182,.22), transparent 60%),
    radial-gradient(800px 360px at 80% 30%, rgba(246,178,58,.16), transparent 62%),
    radial-gradient(700px 380px at 45% 110%, rgba(33,230,182,.10), transparent 62%);
  pointer-events:none;
}

.wTop{
  position:relative;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  z-index:1;
}

.wBadge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  color: rgba(234,242,255,.78);
  font-weight: 950;
  letter-spacing:.06em;
  text-transform: uppercase;
  font-size: 12px;
}

.wDots{
  display:flex;
  gap:8px;
  align-items:center;
}

.wDot{
  width:10px;height:10px;border-radius:99px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  cursor:pointer;
}
.wDot.on{
  background: rgba(33,230,182,.40);
  border-color: rgba(33,230,182,.55);
  box-shadow: 0 0 0 6px rgba(33,230,182,.10);
}

.wTitle{
  position:relative;
  z-index:1;
  margin-top: 14px;
  font-size: 26px;
  font-weight: 1000;
  line-height: 1.1;
}

.wText{
  position:relative;
  z-index:1;
  margin-top: 10px;
  color: rgba(234,242,255,.85);
  font-weight: 750;
  line-height: 1.45;
}

.wQuote{
  position:relative;
  z-index:1;
  margin-top: 12px;
  padding: 12px 12px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  color: rgba(234,242,255,.88);
  font-weight: 850;
}

.wNavRow{
  display:flex; gap:10px; flex-wrap:wrap;
  margin-top: 14px;
}

.wMini{
  flex:1 1 160px;
  padding: 14px 14px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.05);
  color: var(--txt);
  font-weight: 950;
  cursor:pointer;
}

.manualList{ display:flex; flex-direction:column; gap:12px; margin-top:12px;}
.faq{
  border-radius: 22px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  padding: 14px;
}
.faq h4{ margin:0 0 8px; font-weight:1000; }
.faq p{ margin:0; color: rgba(234,242,255,.82); font-weight:750; line-height:1.45; }
    *{ box-sizing:border-box; }
    html, body{
      height:100%;
      margin:0;
      padding:0;
      background: var(--bg);
      color: var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow-x:hidden;
    }
    body{
      padding-bottom: calc(92px + env(safe-area-inset-bottom));
    }
    a{ color: var(--green); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .wrap{ max-width: var(--max); margin: 0 auto; padding: 16px 14px 24px; }

    .topbar{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:6px;
      margin-bottom: 14px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(33,230,182,.35), rgba(33,230,182,.05));
      border:1px solid rgba(33,230,182,.35);
      display:flex;align-items:center;justify-content:center;
      font-weight:1000;
      color:var(--green);
      box-shadow: var(--shadow);
      flex:0 0 auto;
      overflow:hidden;
    }
    .brand{
      display:flex;flex-direction:column;gap:2px;
      min-width: 0;
      flex: 1 1 auto;
    }
    .brand small{color:var(--muted); letter-spacing:.08em; font-weight:900}
    .brand b{font-size:18px}

    .pill{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--stroke);
      color:var(--muted);
      font-weight:800;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .pill .dot{
      width:10px;height:10px;border-radius:99px;background:var(--green);
      box-shadow: 0 0 0 6px rgba(33,230,182,.12);
    }

    .h1{
      font-size:34px;
      margin:12px 2px 14px;
      letter-spacing:.02em;
      color:var(--green);
      font-weight: 1000;
      line-height: 1.05;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .hint{ color: var(--muted); font-weight: 650; line-height: 1.35; }
    .muted{ opacity:.85; }

    .row{display:flex; gap:12px; flex-wrap:wrap}
    .col{flex:1 1 140px; min-width: 140px}

    .label{
      margin: 12px 2px 6px;
      color: rgba(234,242,255,.65);
      font-weight: 950;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-size: 12px;
    }

    input, select, textarea{
      width:100%;
      padding:14px 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      outline: none;
      font-size: 15px;
    }
    textarea{ min-height: 90px; resize: vertical; }
    input::placeholder{color: rgba(234,242,255,.35)}
    select{appearance:none}

    .btn{
      width:100%;
      padding: 16px 16px;
      border-radius: 18px;
      border: 0;
      cursor: pointer;
      font-weight: 950;
      font-size: 16px;
      letter-spacing: .02em;
      background: linear-gradient(135deg, var(--green), var(--green2));
      color:#042019;
      box-shadow: 0 18px 45px rgba(33,230,182,.18);
      margin-top: 14px;
    }
    .btnSecondary{
      width:100%;
      padding: 14px 16px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      cursor: pointer;
      font-weight: 900;
      font-size: 15px;
      background: rgba(255,255,255,.05);
      color: var(--txt);
      margin-top: 10px;
    }
    .btnOrange{
      width:100%;
      padding: 16px 16px;
      border-radius: 18px;
      border: 0;
      cursor: pointer;
      font-weight: 950;
      font-size: 16px;
      background: linear-gradient(135deg, #ffcc5a, #f6b23a);
      color:#201400;
      margin-top: 12px;
      box-shadow: 0 18px 45px rgba(246,178,58,.18);
    }

    .status{
      margin-top: 10px;
      font-weight: 800;
      color: rgba(234,242,255,.86);
    }

    .chips{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;}
    .chip{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-weight: 900;
      cursor: pointer;
      user-select: none;
    }
    .chip.on{
      border-color: rgba(33,230,182,.45);
      background: rgba(33,230,182,.12);
      color: var(--txt);
      box-shadow: 0 0 0 6px rgba(33,230,182,.08);
    }

    .screen{
      display:none;
      margin-top: 8px;
      width: 100%;
      background: var(--bg);
      padding-bottom: calc(140px + env(safe-area-inset-bottom));
    }
    .screen.active{ display:block; }

    /* nav */
    .nav{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: #07121f;
      border-top: 1px solid rgba(255,255,255,.08);
      z-index: 1000;
    }
    .navInner{
      max-width: var(--max);
      margin: 0 auto;
      display:flex;
      gap:10px;
      overflow-x: auto;
      padding: 6px 6px;
      scrollbar-width: none;
    }
    .navInner::-webkit-scrollbar{ display:none; }
    .navBtn{
      flex:0 0 auto;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color: rgba(234,242,255,.6);
      font-weight: 950;
      padding: 12px 14px;
      border-radius: 999px;
      cursor:pointer;
      letter-spacing:.05em;
      white-space: nowrap;
    }
    .navBtn.active{
      background: rgba(33,230,182,.12);
      border-color: rgba(33,230,182,.35);
      color: var(--green);
      box-shadow: 0 0 0 6px rgba(33,230,182,.08);
    }

    /* plate */
    .platePreview{
      width:100%;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
      overflow:hidden;
      margin-top: 12px;
    }
    .platePreview img{ width:100%; display:block; }

    .miniRow{ display:flex; gap:10px; flex-wrap:wrap }
    .miniBtn{
      flex:1 1 160px;
      padding:14px 14px;
      border-radius:18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--txt);
      font-weight: 900;
      cursor:pointer;
    }

    /* Diet cards */
    .meal{
      display:flex; justify-content:space-between; gap:12px;
      padding: 16px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      margin-top: 12px;
    }
    .meal .title{
      font-weight: 950;
      color: var(--green);
      letter-spacing:.08em;
      text-transform: uppercase;
      font-size: 12px;
      margin-bottom: 6px;
    }
    .meal p{margin:0; color: rgba(234,242,255,.88); font-weight:750; line-height:1.35}
    .kcal{
      display:flex; align-items:center; justify-content:center;
      min-width: 88px;
      border-radius: 999px;
      border:1px solid rgba(33,230,182,.25);
      background: rgba(33,230,182,.08);
      color: var(--green);
      font-weight: 1000;
      padding: 10px 12px;
      text-align:center;
    }

    /* Treino */
    .dayCard{
      margin-top: 12px;
      padding: 14px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .dayTitle{
      display:flex; align-items:center; justify-content:space-between;
      font-weight: 1000;
      color: rgba(234,242,255,.92);
      margin-bottom: 10px;
      letter-spacing:.03em;
    }
    .exercise{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding: 12px 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      margin-top: 10px;
    }
    .ytBtn{
      border:0;
      border-radius: 999px;
      padding: 10px 12px;
      background: rgba(33,230,182,.10);
      border: 1px solid rgba(33,230,182,.25);
      color: var(--green);
      font-weight: 1000;
      cursor: pointer;
      min-width: 110px;
    }

    /* Parceiros */
    .partnerList{display:flex; flex-direction:column; gap:12px; margin-top:12px}
    .partnerRow{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px; border-radius:18px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
    }
    .partnerName{display:flex; flex-direction:column; gap:4px}
    .partnerName b{font-weight: 1000}

    /* Modal */
    .modalBack{
      display:none;
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      z-index: 2000;
      padding: 20px;
      overflow:auto;
    }
    .modal{
      max-width: 560px;
      margin: 40px auto;
      background: #0b1726;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      box-shadow: 0 25px 80px rgba(0,0,0,.55);
      padding: 16px;
    }
    .modal h3{ margin: 0 0 10px; }
    .modal .closeRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .xBtn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 900;
      cursor:pointer;
    }

    /* bot√£o topo */
    #btnTop{
      position:fixed;
      bottom:110px;
      right:18px;
      width:48px;
      height:48px;
      border-radius:50%;
      border:none;
      background:linear-gradient(135deg,#21e6b6,#17caa0);
      color:#042019;
      font-size:22px;
      font-weight:900;
      box-shadow:0 10px 25px rgba(0,0,0,.4);
      display:none;
      z-index:999;
      cursor:pointer;
    }

    /* ===== DASHBOARD 3D ===== */
    .pro3dWrap{ perspective: 1200px; }
    .pro3dCard{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border: 1px solid var(--stroke3d);
      border-radius: 26px;
      box-shadow: var(--shadow3d);
      transform: rotateX(7deg) rotateY(-6deg);
      transform-style: preserve-3d;
      overflow:hidden;
      position: relative;
    }
    .pro3dCard:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 260px at 20% 10%, rgba(33,230,182,.18), transparent 60%),
        radial-gradient(520px 260px at 80% 30%, rgba(246,178,58,.14), transparent 60%),
        radial-gradient(700px 340px at 40% 100%, rgba(33,230,182,.10), transparent 62%);
      pointer-events:none;
    }
    .proTop{ display:flex; align-items:center; justify-content:space-between; padding:16px 16px 0; position: relative; z-index: 1; }
    .proTitle{
      font-size: 26px;
      font-weight: 1000;
      letter-spacing: .02em;
      margin: 10px 16px 12px;
      color: rgba(234,242,255,.95);
      position: relative; z-index: 1;
    }
    .proGrid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 12px;
      padding: 0 16px 16px;
      position: relative; z-index: 1;
    }
    .proPanel{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
      padding: 14px;
      transform: translateZ(18px);
    }
    .proRingBox{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap: 10px; min-height: 240px; }
    .ring{ width: 180px; height: 180px; position: relative; transform: translateZ(26px); }
    .ring svg{ width: 100%; height: 100%; transform: rotate(-90deg); filter: drop-shadow(0 20px 40px rgba(0,0,0,.55)); }
    .ringCenter{
      position:absolute; inset: 0;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      text-align:center; gap: 2px;
    }
    .ringPct{ font-size: 44px; font-weight: 1000; color: #ffd38a; text-shadow: 0 10px 30px rgba(0,0,0,.45); }
    .ringSub{ color: rgba(234,242,255,.72); font-weight: 900; }

    .proStats{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      padding: 0 16px 16px;
      position: relative; z-index: 1;
    }
    .stat3d{
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      padding: 12px;
      transform: translateZ(14px);
    }
    .stat3d .num{ font-size: 24px; font-weight: 1000; color: rgba(234,242,255,.95); }
    .stat3d .lab{
      margin-top: 2px;
      color: rgba(234,242,255,.65);
      font-weight: 850;
      font-size: 12px;
      letter-spacing:.08em;
      text-transform: uppercase;
    }
    .proHint{ padding: 0 16px 16px; color: rgba(234,242,255,.65); font-weight: 800; position: relative; z-index: 1; }

    /* Evolu√ß√£o / Gamifica√ß√£o */
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .pill2{
      padding: 10px 12px; border-radius: 18px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      font-weight: 900;
      color: rgba(234,242,255,.9);
    }
    .bar{
      width:100%; height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      margin-top: 8px;
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(135deg, rgba(33,230,182,.95), rgba(23,202,160,.85));
    }
    .badgeRow{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .badge{
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-weight: 900;
      color: rgba(234,242,255,.9);
      white-space:nowrap;
    }
    .badge.ok{
      border-color: rgba(33,230,182,.35);
      background: rgba(33,230,182,.10);
      color: var(--txt);
      box-shadow: 0 0 0 6px rgba(33,230,182,.06);
    }

    .chartBox{
      margin-top: 12px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
      padding: 12px;
      overflow:hidden;
    }

    @media (min-width: 900px){
      .wrap{ max-width: 900px; }
      .proGrid{ grid-template-columns: 1fr 1fr; }
      .ring{ width: 210px; height: 210px; }
      .pro3dCard{ transform: rotateX(6deg) rotateY(-4deg); }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="logo">E</div>
      <div class="brand">
        <small>ELITE TERMINAL</small>
        <b>CheckPrato ‚Ä¢ Elite</b>
      </div>
      <div class="pill"><span class="dot"></span><span id="authTxt">Modo: Local</span></div>
    </div>
<!-- BOAS-VINDAS (ANTES DE TUDO) -->
<section id="viewWelcome" class="screen">
  <div class="h1">BEM-VINDO</div>

  <div class="welcomeHero">
    <div class="hint">
      O CheckPrato te ajuda com <b>dieta</b>, <b>treino</b>, <b>prato</b> e <b>evolu√ß√£o</b>.
      Tudo simples, bonito e objetivo.
    </div>

    <div class="wCarousel" style="margin-top:12px">
      <div class="wSlide active" data-slide="0">
        <div class="wBg"></div>
        <div class="wTop">
          <div class="wBadge">üî• Consist√™ncia</div>
          <div class="wDots" id="wDots"></div>
        </div>
        <div class="wTitle">Pequenas escolhas<br>mudam tudo.</div>
        <div class="wText">Voc√™ n√£o precisa de perfei√ß√£o. Precisa de dire√ß√£o.</div>
        <div class="wQuote">‚ÄúHoje eu s√≥ preciso fazer o m√≠nimo bem feito.‚Äù</div>
      </div>

      <div class="wSlide" data-slide="1">
        <div class="wBg"></div>
        <div class="wTop">
          <div class="wBadge">ü•ó Prato</div>
          <div class="wDots"></div>
        </div>
        <div class="wTitle">Controle sem neura.</div>
        <div class="wText">Tire foto, registre, pontue e enxergue padr√µes.</div>
        <div class="wQuote">‚ÄúO que √© medido, melhora.‚Äù</div>
      </div>

      <div class="wSlide" data-slide="2">
        <div class="wBg"></div>
        <div class="wTop">
          <div class="wBadge">üèãÔ∏è Treino</div>
          <div class="wDots"></div>
        </div>
        <div class="wTitle">Treino que encaixa<br>na sua vida.</div>
        <div class="wText">Iniciante, intermedi√°rio ou avan√ßado ‚Äî com v√°rios esportes.</div>
        <div class="wQuote">‚ÄúDisciplina √© fazer mesmo sem vontade.‚Äù</div>
      </div>

      <div class="wSlide" data-slide="3">
        <div class="wBg"></div>
        <div class="wTop">
          <div class="wBadge">üìà Evolu√ß√£o</div>
          <div class="wDots"></div>
        </div>
        <div class="wTitle">Evolu√ß√£o visual.</div>
        <div class="wText">Gr√°ficos, streak, metas, ranking semanal e badges.</div>
        <div class="wQuote">‚Äú1% melhor por dia.‚Äù</div>
      </div>
    </div>

    <div class="wNavRow">
    <button class="btn" type="button" onclick="startNow()">COME√áAR AGORA</button>
    <button class="btnSecondary" type="button" onclick="openManual()">VER MANUAL</button>
    <button class="btnSecondary" type="button" onclick="goPrato()">IR PARA PRATO</button>  
    </div>
  </div>
</section>

<!-- MANUAL (AJUDA) -->
<section id="viewManual" class="screen">
  <div class="h1">MANUAL</div>

  <div class="card">
    <div class="hint">
      Aqui est√° o passo a passo do CheckPrato. R√°pido e sem enrola√ß√£o.
    </div>

    <div class="manualList">
      <div class="faq">
        <h4>1) Cadastro</h4>
        <p>Preencha peso, altura, objetivo, n√≠vel e esportes. Isso personaliza dieta/treino e metas.</p>
      </div>

      <div class="faq">
        <h4>2) Prato</h4>
        <p>Tire foto ou escolha da galeria. Depois descreva e confirme. O app registra e gera score/relat√≥rios.</p>
      </div>

      <div class="faq">
        <h4>3) Dieta</h4>
        <p>Gere uma dieta e refa√ßa quando quiser. Ajuste conforme restri√ß√µes e objetivo.</p>
      </div>

      <div class="faq">
        <h4>4) Treino</h4>
        <p>Escolha tema e intensidade. Cada exerc√≠cio tem atalho para t√©cnica no YouTube.</p>
      </div>

      <div class="faq">
        <h4>5) Evolu√ß√£o</h4>
        <p>Acompanhe gr√°fico, streak, metas de prote√≠na e ranking semanal. Foque em consist√™ncia.</p>
      </div>

      <div class="faq">
        <h4>Privacidade</h4>
        <p>Se voc√™ estiver em modo local, seus dados ficam no seu aparelho. Se conectar Firebase, d√° pra sincronizar.</p>
      </div>
    </div>

    <div class="wNavRow" style="margin-top:14px">
      <button class="btnSecondary" type="button" onclick="switchView('viewCadastro')">IR PARA CADASTRO</button>
      <button class="btnSecondary" type="button" onclick="switchView('viewPerfil')">IR PARA PERFIL</button>
    </div>
  </div>
</section>
    <!-- BOAS VINDAS -->
    <section id="viewWelcome" class="screen active">
      <div class="h1">Bem-vindo üëã</div>
      <div class="card">
        <div class="hint">
          <div class="hint">
          Complete seu perfil para receber recomenda√ß√µes personalizadas.
          </div>
          <br><br>
          <b>Dica:</b> voc√™ pode usar como convidado (sem Firebase) e tudo funciona.
        </div>
        <div class="row" style="margin-top:14px">
          <div class="col">
            <button class="btn" type="button" onclick="openAuthModal()">Entrar / Criar conta</button>
          </div>
          <div class="col">
            <button class="btnSecondary" type="button" onclick="enterGuest()">Entrar como convidado</button>
          </div>
        </div>
        <div id="welcomeStatus" class="status" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- DASHBOARD 3D -->
    <section id="viewProgresso" class="screen">
      <div class="h1">PROGRESSO</div>

      <div class="pro3dWrap">
        <div class="pro3dCard">
          <div class="proTop">
            <div class="pill"><span class="dot"></span><span id="proMode">Local</span></div>
            <div class="pill"><span class="dot"></span><span id="proWeek">Semana</span></div>
          </div>

          <div class="proTitle">Meta da Semana</div>

          <div class="proGrid">
            <div class="proPanel">
              <div class="label" style="margin-top:0">Streak & N√≠vel</div>
              <div class="pill2">üî• Streak: <b id="streakTxt">0</b> dias</div>
              <div class="pill2" style="margin-top:10px">üèÜ N√≠vel: <b id="lvlTxt">1</b> ‚Ä¢ XP <b id="xpTxt">0</b></div>
              <div class="bar"><div id="xpBar"></div></div>
              <div class="hint" style="margin-top:10px" id="coachTxt">‚Äî</div>

              <div class="label">Medalhas</div>
              <div class="badgeRow" id="medalRow"></div>

              <div class="miniRow" style="margin-top:10px">
                <button class="miniBtn" type="button" onclick="openView('viewPrato')">Analisar prato</button>
                <button class="miniBtn" type="button" onclick="openView('viewEvolucao')">Ver evolu√ß√£o</button>
              </div>
            </div>

            <div class="proPanel">
              <div class="label" style="margin-top:0">Progresso semanal</div>

              <div class="proRingBox">
                <div class="ring">
                  <svg viewBox="0 0 120 120">
                    <circle cx="60" cy="60" r="48" stroke="rgba(255,255,255,.10)" stroke-width="10" fill="none"/>
                    <circle id="ringProg" cx="60" cy="60" r="48"
                      stroke="rgba(255,211,138,.95)" stroke-linecap="round"
                      stroke-width="10" fill="none"
                      stroke-dasharray="301.59" stroke-dashoffset="301.59"/>
                  </svg>
                  <div class="ringCenter">
                    <div class="ringPct" id="proPct">0%</div>
                    <div class="ringSub"><span id="proDone">0</span> / <span id="proGoal">7</span> dias</div>
                  </div>
                </div>

                <div class="proHint">
                  Evolua <b>1% por dia</b>. Consist√™ncia vence.
                </div>

                <div class="miniRow" style="margin-top:4px">
                  <button class="miniBtn" type="button" onclick="addTreinoDone()">+1 dia treino</button>
                  <button class="miniBtn" type="button" onclick="resetProgresso()">Reset semana</button>
                </div>
              </div>
            </div>
          </div>

          <div class="proStats">
            <div class="stat3d">
              <div class="num" id="proKcal">0</div>
              <div class="lab">calorias</div>
              <button class="btnSecondary" type="button" onclick="addKcal()">+500</button>
            </div>
            <div class="stat3d">
              <div class="num" id="proKm">0</div>
              <div class="lab">km</div>
              <button class="btnSecondary" type="button" onclick="addKm()">+2 km</button>
            </div>
            <div class="stat3d">
              <div class="num"><span id="proDays">0</span>/<span id="proDaysGoal">7</span></div>
              <div class="lab">dias treino</div>
              <button class="btnSecondary" type="button" onclick="setGoalDaysPrompt()">Meta</button>
            </div>
          </div>

        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="label">Resumo</div>
        <div class="hint" id="proResumo">‚Äî</div>
      </div>
    </section>

    <!-- CADASTRO (SEM PRATO AQUI!) -->
    <section id="viewCadastro" class="screen">
      <div class="h1">CADASTRO</div>

      <div class="card">
        <div class="label">Foto do perfil</div>
        <div class="row" style="align-items:center">
          <div style="width:64px;height:64px;border-radius:18px;overflow:hidden;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.2)">
            <img id="avatarImg" alt="Foto" style="width:100%;height:100%;object-fit:cover;display:none"/>
            <div id="avatarFallback" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:1000;color:rgba(234,242,255,.7)">üë§</div>
          </div>
          <div style="flex:1">
            <button class="btnSecondary" type="button" onclick="pickAvatar()">Escolher foto</button>
            <input id="avatarFile" type="file" accept="image/*" style="display:none">
            <div class="hint" style="margin-top:6px">Salva no aparelho (modo local).</div>
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <div class="col">
            <div class="label">Nome</div>
            <input id="nome" placeholder="nome" />
          </div>
          <div class="col">
            <div class="label">Email (opcional)</div>
            <input id="emailPerfil" inputmode="email" placeholder="Ex: ....@gmail.com" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="label">Peso (kg)</div>
            <input id="peso" inputmode="decimal" placeholder="Ex: 78.5" />
          </div>
          <div class="col">
            <div class="label">Altura (cm)</div>
            <input id="altura" inputmode="numeric" placeholder="Ex: 175" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="label">Objetivo</div>
            <select id="objetivo">
              <option value="">Selecione</option>
              <option>Emagrecer</option>
              <option>Ganhar massa</option>
              <option>Manter</option>
              <option>Performance</option>
            </select>
          </div>
          <div class="col">
            <div class="label">N√≠vel</div>
            <select id="nivel">
              <option value="">Selecione</option>
              <option>Iniciante</option>
              <option>Intermedi√°rio</option>
              <option>Avan√ßado</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="label">Condi√ß√£o</div>
            <select id="condicao">
              <option value="">Selecione</option>
              <option>Saud√°vel</option>
              <option>Hipertens√£o</option>
              <option>Diabetes</option>
              <option>Les√£o / Dor</option>
            </select>
          </div>
          <div class="col">
            <div class="label">Restri√ß√£o</div>
            <select id="restricao">
              <option value="">Selecione</option>
              <option>Nenhuma</option>
              <option>Lactose</option>
              <option>Gl√∫ten</option>
              <option>Vegetariano</option>
              <option>Vegano</option>
            </select>
          </div>
        </div>

        <div class="label">Esportes (pode marcar v√°rios)</div>
        <div id="chipsEsportes" class="chips"></div>

        <div style="margin-top:10px">
          <label style="display:flex; gap:10px; align-items:center; font-weight:900; color:rgba(234,242,255,.9)">
            <input id="termo" type="checkbox" style="width:22px; height:22px"/>
            Aceito o termo (conte√∫do informativo)
          </label>
          <div class="hint" style="margin-top:6px">As sugest√µes s√£o informativas e n√£o substituem profissional.</div>
        </div>

        <button class="btn" type="button" onclick="salvarCadastro()">SALVAR / ATUALIZAR</button>
        <button class="btnSecondary" type="button" onclick="limparCadastro()">LIMPAR</button>

        <div id="outCadastro" class="status" style="display:none"></div>
      </div>

      <div class="card" style="margin-top:14px;display:none;">
        <div class="label">Atalhos</div>
        <div class="hint"style="display:none">Voc√™ pediu pra tirar o prato daqui ‚Äî ent√£o ficou em uma aba separada.</div>
        <div class="miniRow" style="margin-top:10px">
          <button class="miniBtn" type="button" onclick="openView('viewPrato')">üçΩÔ∏è Ir para PRATO</button>
          <button class="miniBtn" type="button" onclick="openView('viewEvolucao')">üìà Ir para EVOLU√á√ÉO</button>
        </div>
      </div>
    </section>

    <!-- PRATO (ABA SEPARADA, PROFISSIONAL) -->
    <section id="viewPrato" class="screen">
      <div class="h1">PRATO</div>

      <div class="card">
        <div class="hint">
          Tire uma foto ou envie da galeria. Depois descreva rapidamente o que tem no prato.
          <br><br>
          <b>O app aprende com voc√™</b> e vai ficando mais assertivo ao longo do tempo.
        </div>

        <div class="miniRow" style="margin-top:12px">
          <button class="miniBtn" type="button" id="btnPratoCamera">Tirar foto</button>
          <button class="miniBtn" type="button" id="btnPratoGaleria">Galeria</button>
        </div>

        <input id="filePratoCamera" type="file" accept="image/*" capture="environment" style="display:none">
        <input id="filePratoGaleria" type="file" accept="image/*" style="display:none">

        <div class="platePreview" id="pratoPreview" style="display:none">
          <img id="pratoImg" alt="Prato"/>
        </div>

        <div class="label">O que tem no prato?</div>
        <textarea id="pratoDesc" placeholder="Ex: arroz, feij√£o, frango grelhado, salada, suco..."></textarea>

        <div class="row">
          <div class="col">
            <div class="label">Quantidade</div>
            <select id="pratoQtd">
              <option>Pequena</option>
              <option selected>M√©dia</option>
              <option>Grande</option>
            </select>
          </div>
          <div class="col">
            <div class="label">Foco</div>
            <select id="pratoFoco">
              <option selected>Equil√≠brio</option>
              <option>Emagrecimento</option>
              <option>Hipertrofia</option>
              <option>Performance</option>
            </select>
          </div>
        </div>

        <button class="btn" type="button" onclick="analisarPratoElite()">ANALISAR</button>
        <button class="btnSecondary" type="button" onclick="confirmarPratoElite()">CONFIRMAR E SALVAR</button>

        <div id="pratoResultado" class="status" style="display:none"></div>

        <div class="card" style="margin-top:12px; background:rgba(255,255,255,.03)">
          <div class="label">Resumo r√°pido</div>
          <div class="hint" id="pratoResumo">‚Äî</div>
          <div class="badgeRow" id="pratoBadges"></div>
        </div>

        <div class="label">Hist√≥rico (local)</div>
        <div class="hint" id="pratoHistTxt">‚Äî</div>

        <div class="miniRow" style="margin-top:10px">
          <button class="miniBtn" type="button" onclick="openView('viewEvolucao')">üìà Evolu√ß√£o</button>
          <button class="miniBtn" type="button" onclick="openNotifPrompt()">üîî Notifica√ß√µes</button>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="label">Desafio da semana</div>
        <div class="hint" id="challengeTxt">‚Äî</div>
        <div class="bar"><div id="challengeBar"></div></div>
        <div class="miniRow" style="margin-top:10px">
          <button class="miniBtn" type="button" onclick="rerollChallenge()">Trocar desafio</button>
          <button class="miniBtn" type="button" onclick="markChallengeStep()">+1 progresso</button>
        </div>
      </div>
    </section>

    <!-- EVOLU√á√ÉO -->
    <section id="viewEvolucao" class="screen">
      <div class="h1">EVOLU√á√ÉO</div>

      <div class="card">
        <div class="label">Score do prato (√∫ltimos 14)</div>
        <div class="hint">A curva mostra consist√™ncia. N√£o √© perfei√ß√£o ‚Äî √© dire√ß√£o.</div>
        <div class="chartBox">
          <canvas id="scoreChart" height="160"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="label">Ranking semanal</div>
        <div class="hint" id="rankTxt">‚Äî</div>
        <div class="grid2" style="margin-top:10px">
          <div class="pill2">M√©dia 7 dias: <b id="avg7Txt">‚Äî</b></div>
          <div class="pill2">Prote√≠na hoje: <b id="protTodayTxt">‚Äî</b></div>
          <div class="pill2">Meta prote√≠na: <b id="protGoalTxt">‚Äî</b></div>
          <div class="pill2">Score hoje: <b id="scoreTodayTxt">‚Äî</b></div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="label">Gamifica√ß√£o</div>
        <div class="hint">Recompensas por consist√™ncia. Isso gera h√°bito real.</div>
        <div class="pill2" style="margin-top:10px">üî• Streak: <b id="streakTxt2">0</b> dias</div>
        <div class="pill2" style="margin-top:10px">üèÜ N√≠vel: <b id="lvlTxt2">1</b> ‚Ä¢ XP <b id="xpTxt2">0</b></div>
        <div class="bar"><div id="xpBar2"></div></div>
        <div class="badgeRow" id="medalRow2"></div>
      </div>
    </section>

    <!-- DIETA -->
    <section id="viewDieta" class="screen">
      <div class="h1">DIETA</div>

      <div class="card">
        <div class="hint">
          Dieta inteligente (modo local). Se n√£o gostar, clique em <b>Refazer</b>.
        </div>

        <button class="btn" type="button" onclick="gerarDieta()">GERAR DIETA</button>
        <button class="btnSecondary" type="button" onclick="refazerDieta()">REFAZER / TROCAR</button>

        <div id="dietaBox"></div>
      </div>
    </section>

    <!-- TREINO -->
    <section id="viewTreino" class="screen">
      <div class="h1">TREINO</div>

      <div class="card">
        <div class="hint">Treino semanal. Cada exerc√≠cio tem bot√£o ‚ÄúYouTube‚Äù.</div>

        <div class="row" style="margin-top:10px">
          <div class="col">
            <div class="label">Tema</div>
            <select id="temaTreino">
              <option>Academia</option>
              <option>Corrida</option>
              <option>Muay Thai</option>
              <option>Futebol</option>
              <option>Basquete</option>
              <option>V√¥lei</option>
              <option>Nata√ß√£o</option>
              <option>Ciclismo</option>
              <option>Crossfit</option>
              <option>Pilates</option>
              <option>Yoga</option>
            </select>
          </div>
          <div class="col">
            <div class="label">Intensidade</div>
            <select id="intTreino">
              <option>Leve</option>
              <option selected>Moderado</option>
              <option>Pesado</option>
            </select>
          </div>
        </div>

        <button class="btn" type="button" onclick="gerarTreino()">GERAR TREINO DA SEMANA</button>
        <button class="btnSecondary" type="button" onclick="limparTreino()">LIMPAR TREINO</button>

        <div id="outTreino" class="status" style="display:none"></div>
        <div id="treinoSemana"></div>
      </div>
    </section>

    <!-- PARCEIROS -->
    <section id="viewParceiros" class="screen">
      <div class="h1">PARCEIROS</div>

      <div class="card">
        <div class="hint">Sites oficiais (voc√™ troca pelos seus links depois).</div>

        <div class="partnerList">
          <div class="partnerRow">
            <div class="partnerName"><b>Growth Supplements</b><div class="muted">Whey, creatina e suplementos</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.gsuplementos.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Max Titanium</b><div class="muted">Nutri√ß√£o esportiva</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.maxtitanium.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Nike</b><div class="muted">T√™nis e roupas</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.nike.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Adidas</b><div class="muted">Performance e lifestyle</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.adidas.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Mercado Livre</b><div class="muted">Acess√≥rios e suplementos</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.mercadolivre.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Shopee</b><div class="muted">Produtos fitness acess√≠veis</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://shopee.com.br')">Abrir</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PREMIUM (ESCONDIDO - SEM BOT√ÉO NO NAV) -->
    <section id="viewPremium" class="screen">
      <div class="h1">PREMIUM</div>
      <div class="card">
        <div class="hint">√Årea preparada para o futuro (sem exibir ao usu√°rio).</div>
        <button class="btnOrange" type="button" onclick="openCheckout()">Checkout</button>
      </div>
    </section>

    <!-- CONVITES -->
    <section id="viewConvites" class="screen">
      <div class="h1">CONVITES</div>

      <div class="card">
        <div class="hint">
          Convide amigos e ganhe: <b>R$ 5</b> por cada pessoa que assinar usando seu link.
          Ao atingir <b>R$ 50</b>, voc√™ pode solicitar saque (modo local) e ganha <b>1 m√™s gr√°tis</b>.
        </div>

        <div style="margin-top:12px" class="card">
          <div class="label">Seu c√≥digo</div>
          <div id="myCode" style="font-weight:1000; font-size:18px">‚Äî</div>

          <div class="label" style="margin-top:12px">Seu link</div>
          <div id="myLink" class="muted" style="word-break:break-all">‚Äî</div>

          <div class="label" style="margin-top:12px">Saldo (local)</div>
          <div id="balTxt" style="font-weight:1000; font-size:18px">R$ 0,00</div>
          <div id="progressTxt" class="muted" style="margin-top:6px"></div>

          <div class="miniRow" style="margin-top:12px">
            <button class="miniBtn" type="button" onclick="copyInviteLink()">Copiar link</button>
            <button class="miniBtn" type="button" onclick="shareInvite()">Compartilhar</button>
          </div>

          <div class="miniRow" style="margin-top:10px">
            <button class="miniBtn" type="button" onclick="setBalance(getBalance()+5)">+R$5 (teste)</button>
            <button class="miniBtn" type="button" onclick="setBalance(0)">Zerar (teste)</button>
          </div>

          <button id="btnSaque" class="btnSecondary" type="button" onclick="solicitarSaque()">Solicitar saque</button>
          <div id="saqueMsg" class="status" style="display:none"></div>
        </div>
      </div>
    </section>

    <!-- SA√öDE -->
    <section id="viewSaude" class="screen">
      <div class="h1">SA√öDE</div>

      <div class="card">
        <div class="hint">
          Conte√∫do educativo. N√£o substitui m√©dico. Em caso de sintomas ou d√∫vidas, procure um profissional.
        </div>

        <div class="meal" style="margin-top:14px">
          <div>
            <div class="title">Anabolizantes: aten√ß√£o</div>
            <p>Podem causar efeitos no cora√ß√£o, press√£o, colesterol, f√≠gado, humor e horm√¥nios. N√£o use sem acompanhamento.</p>
          </div>
        </div>

        <div class="meal">
          <div>
            <div class="title">Sinais de alerta</div>
            <p>Dor no peito, falta de ar, palpita√ß√£o, desmaio, incha√ßo, pele/olhos amarelados, urina escura: pare e procure atendimento.</p>
          </div>
        </div>

        <div class="meal">
          <div>
            <div class="title">Exames</div>
            <p>Press√£o, hemograma, lipidograma, glicemia, TGO/TGP, creatinina, testosterona, estradiol. Com m√©dico.</p>
          </div>
        </div>

        <div class="meal">
          <div>
            <div class="title">Cuidados gerais</div>
            <p>Sono 7‚Äì9h, hidrata√ß√£o, dieta com fibras, evitar √°lcool, treino com progress√£o e descanso.</p>
          </div>
        </div>

        <button class="btnSecondary" type="button" onclick="abrirLink('https://bvsms.saude.gov.br/')">Ler mais (Fontes)</button>
      </div>
    </section>

    <!-- PERFIL -->
    <section id="viewPerfil" class="screen">
      <div class="h1">PERFIL</div>

      <div class="card">
        <div class="hint">Status da conta e dados locais.</div>
        <div id="perfilBox" class="status" style="margin-top:12px">‚Äî</div>

        <button class="btnSecondary" type="button" onclick="logoutFirebase()">Sair (se logado)</button>
        <button class="btnSecondary" type="button" onclick="sair()">Voltar ao in√≠cio</button>
      </div>

      <div class="card" style="margin-top:14px; display:none;">
  <div class="label">Atalho oculto</div>
  <div class="hint">Premium fica escondido...</div>
      </div>
    </section>
  </div>

  <!-- NAV (SEM PREMIUM) -->
  <div class="nav" id="navBar">
    <div class="navInner">
  <button class="navBtn active" data-view="viewCadastro" type="button">CADASTRO</button>
  <button class="navBtn" data-view="viewPerfil" type="button">PERFIL</button>
  <button class="navBtn" data-view="viewPrato" type="button">PRATO</button>
  <button class="navBtn" data-view="viewDieta" type="button">DIETA</button>
  <button class="navBtn" data-view="viewTreino" type="button">TREINO</button>
  <button class="navBtn" data-view="viewEvolucao" type="button">EVOLU√á√ÉO</button>
  <button class="navBtn" data-view="viewProgresso" type="button">PROGRESSO</button>
  <button class="navBtn" data-view="viewSaude" type="button">SA√öDE</button>
  <button class="navBtn" data-view="viewParceiros" type="button">PARCEIROS</button>
  <button class="navBtn" data-view="viewConvites" type="button">CONVITES</button>
</div>
  </div>

  <button id="btnTop" onclick="scrollToTop()">‚Üë</button>

  <!-- MODAL LOGIN (Firebase opcional) -->
  <div id="authModalBack" class="modalBack">
    <div class="modal">
      <div class="closeRow">
        <h3>Entrar / Criar conta</h3>
        <button class="xBtn" type="button" onclick="closeAuthModal()">X</button>
      </div>

      <div class="hint" style="margin-top:8px">
        <b>Firebase √© opcional.</b> Se n√£o configurar agora, use <b>Convidado</b> e tudo funciona local.
      </div>

      <button class="btn" type="button" onclick="loginGoogle()">Entrar com Google</button>

      <div class="label">Email</div>
      <input id="authEmail" inputmode="email" placeholder="email@exemplo.com">

      <div class="label">Senha</div>
      <input id="authPass" type="password" placeholder="********">

      <div class="miniRow" style="margin-top:12px">
        <button class="miniBtn" type="button" onclick="loginEmail()">Entrar</button>
        <button class="miniBtn" type="button" onclick="criarContaEmail()">Criar conta</button>
      </div>

      <button class="btnSecondary" type="button" onclick="enterGuest()">Entrar como convidado</button>
      <div id="authMsg" class="status" style="display:none"></div>
    </div>
  </div>

  <!-- Firebase CDN (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    /***********************
     * 0) PWA
     ***********************/
    if ("serviceWorker" in navigator){
      navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    }

    /***********************
     * 1) Helpers
     ***********************/
    const $ = (id)=>document.getElementById(id);
    // ===== SISTEMA DE NAVEGA√á√ÉO GLOBAL =====
    function showOnly(viewId) {
  // esconde todas as telas
  document.querySelectorAll(".screen").forEach(screen => {
    screen.classList.remove("active");
  });

  // mostra a tela desejada
  const target = document.getElementById(viewId);
  if (target) {
    target.classList.add("active");
  }

  // ativa bot√£o do menu inferior
  document.querySelectorAll(".navBtn").forEach(btn => {
    btn.classList.remove("active");
    if (btn.dataset.view === viewId) {
      btn.classList.add("active");
    }
  });

  // salva √∫ltima tela (melhora experi√™ncia)
  localStorage.setItem("lastView", viewId);
}
    const fmtBRL = (n)=> new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n||0));
    function abrirLink(url){ window.open(url, "_blank"); }
    window.abrirLink = abrirLink;

    function escapeHtml(s){
      return String(s).replace(/[&<>"]/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m]));
    }

    function show(el, on){
      if(!el) return;
      el.style.display = on ? "block" : "none";
    }

    /***********************
     * 2) Storage Keys
     ***********************/
    const KEY_PROFILE = "cp_profile_v2";
    const KEY_AVATAR  = "cp_avatar_v2";
    const KEY_GUEST   = "cp_guest_v2";
    const KEY_DIETA   = "cp_dieta_v2";
    const KEY_TREINO  = "cp_treino_v2";
    const KEY_INV_CODE = "cp_inv_code_v2";
    const KEY_BAL = "cp_inv_balance_v2";

    // Prato + evolu√ß√£o + IA aprende
    const KEY_PLATE_LAST = "cp_plate_last_v2";
    const KEY_PLATE_HISTORY = "cp_plate_history_v2"; // [{ts, desc, kcal, prot, score, tags, focus}]
    const KEY_AI_PROFILE = "cp_ai_profile_v2"; // aprende prefer√™ncias
    const KEY_GAMIFY = "cp_gamify_v2"; // streak, xp, lvl, medals, lastLogDay
    const KEY_CHALLENGE = "cp_challenge_v2"; // desafio semanal
    const KEY_NOTIF = "cp_notif_v2"; // enabled, hour1, hour2

    // Dashboard stats
    const KEY_DASH = "cp_dash_v2"; // kcal, km, done, goal, weekStart

    function safeJSON(key){
      try{ return JSON.parse(localStorage.getItem(key) || "null"); }catch{ return null; }
    }

    /***********************
     * 3) Firebase (OPCIONAL)
     ***********************/
    const FIREBASE_CONFIG = {
      // Cole aqui seu firebaseConfig se quiser.
    };

    let firebaseEnabled = false;
    let auth = null;
    let db = null;
    let currentUser = null;

    function setAuthBadge(txt){
      const el = $("authTxt");
      if(el) el.textContent = txt;
      const mode = $("proMode");
      if(mode) mode.textContent = txt.includes("Logado") ? "Logado" : "Local";
    }

    function initFirebaseIfPossible(){
      try{
        const hasKeys = FIREBASE_CONFIG && FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.projectId;
        if(!hasKeys) return;

        firebase.initializeApp(FIREBASE_CONFIG);
        auth = firebase.auth();
        db = firebase.firestore();
        firebaseEnabled = true;

        auth.onAuthStateChanged(async (user)=>{
          currentUser = user || null;
          if(currentUser){
            localStorage.removeItem(KEY_GUEST);
            setAuthBadge(`Logado`);
            closeAuthModal();
            showNav(true);
            openView("viewCadastro");
            await syncFromCloud();
            refreshAllUI();
          }else{
            if(!localStorage.getItem(KEY_GUEST)){
              setAuthBadge("Modo: Local");
              showNav(false);
              openView("viewWelcome");
            }
          }
        });
      }catch(e){
        console.log("Firebase init error:", e);
      }
    }

    async function syncFromCloud(){
      if(!firebaseEnabled || !db || !currentUser) return;
      try{
        const ref = db.collection("users").doc(currentUser.uid);
        const snap = await ref.get();
        if(snap.exists){
          const data = snap.data() || {};
          if(data.profile) localStorage.setItem(KEY_PROFILE, JSON.stringify(data.profile));
          if(data.avatar) localStorage.setItem(KEY_AVATAR, String(data.avatar));
          if(data.dash) localStorage.setItem(KEY_DASH, JSON.stringify(data.dash));
          if(data.dieta) localStorage.setItem(KEY_DIETA, JSON.stringify(data.dieta));
          if(data.treino) localStorage.setItem(KEY_TREINO, JSON.stringify(data.treino));
          if(data.plateHistory) localStorage.setItem(KEY_PLATE_HISTORY, JSON.stringify(data.plateHistory));
          if(data.gamify) localStorage.setItem(KEY_GAMIFY, JSON.stringify(data.gamify));
          if(data.aiProfile) localStorage.setItem(KEY_AI_PROFILE, JSON.stringify(data.aiProfile));
          if(data.challenge) localStorage.setItem(KEY_CHALLENGE, JSON.stringify(data.challenge));
        }else{
          await ref.set({ createdAt: Date.now() }, { merge:true });
        }
      }catch(e){
        console.log("syncFromCloud error:", e);
      }
    }

    async function pushToCloud(){
      if(!firebaseEnabled || !db || !currentUser) return;
      try{
        const ref = db.collection("users").doc(currentUser.uid);
        const payload = {
          updatedAt: Date.now(),
          profile: safeJSON(KEY_PROFILE),
          avatar: localStorage.getItem(KEY_AVATAR) || "",
          dash: safeJSON(KEY_DASH),
          dieta: safeJSON(KEY_DIETA),
          treino: safeJSON(KEY_TREINO),
          plateHistory: safeJSON(KEY_PLATE_HISTORY),
          gamify: safeJSON(KEY_GAMIFY),
          aiProfile: safeJSON(KEY_AI_PROFILE),
          challenge: safeJSON(KEY_CHALLENGE),
        };
        await ref.set(payload, { merge:true });
      }catch(e){
        console.log("pushToCloud error:", e);
      }
    }

    /***********************
     * 4) Auth UI
     ***********************/
    function openAuthModal(){
      $("authModalBack").style.display = "block";
      show($("authMsg"), false);
    }
    window.openAuthModal = openAuthModal;

    function closeAuthModal(){
      $("authModalBack").style.display = "none";
    }
    window.closeAuthModal = closeAuthModal;

    function setAuthMsg(txt){
      const el = $("authMsg");
      if(!el) return;
      el.textContent = txt;
      el.style.display = "block";
    }

    function enterGuest(){
      localStorage.setItem(KEY_GUEST, "1");
      setAuthBadge("Modo: Local");
      closeAuthModal();
      showNav(true);
      openView("viewCadastro");
      refreshAllUI();
    }
    window.enterGuest = enterGuest;

    async function loginGoogle(){
      if(!firebaseEnabled || !auth){
        openAuthModal();
        setAuthMsg("Firebase n√£o est√° configurado. Use Convidado por enquanto.");
        return;
      }
      try{
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithRedirect(provider);
      }catch(e){
        setAuthMsg("Erro no Google: " + (e?.message || e));
      }
    }
    window.loginGoogle = loginGoogle;

    async function loginEmail(){
      if(!firebaseEnabled || !auth){
        openAuthModal();
        setAuthMsg("Firebase n√£o est√° configurado. Use Convidado por enquanto.");
        return;
      }
      const email = ($("authEmail").value || "").trim();
      const pass  = ($("authPass").value || "").trim();
      try{
        await auth.signInWithEmailAndPassword(email, pass);
      }catch(e){
        setAuthMsg("Erro: " + (e?.message || e));
      }
    }
    window.loginEmail = loginEmail;

    async function criarContaEmail(){
      if(!firebaseEnabled || !auth){
        openAuthModal();
        setAuthMsg("Firebase n√£o est√° configurado. Use Convidado por enquanto.");
        return;
      }
      const email = ($("authEmail").value || "").trim();
      const pass  = ($("authPass").value || "").trim();
      try{
        await auth.createUserWithEmailAndPassword(email, pass);
      }catch(e){
        setAuthMsg("Erro: " + (e?.message || e));
      }
    }
    window.criarContaEmail = criarContaEmail;

    async function logoutFirebase(){
      try{
        if(firebaseEnabled && auth) await auth.signOut();
        localStorage.removeItem(KEY_GUEST);
        setAuthBadge("Modo: Local");
        showNav(false);
        openView("viewWelcome");
        refreshAllUI();
      }catch(e){
        console.log(e);
      }
    }
    window.logoutFirebase = logoutFirebase;

    function sair(){
      showNav(false);
      openView("viewWelcome");
    }
    window.sair = sair;

    /***********************
     * 5) Navega√ß√£o
     ***********************/
    function openView(viewId){
      document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
      const el = document.getElementById(viewId);
      if(el) el.classList.add("active");
      updateNavActive(viewId);
      updateTopBtn();
    }
    window.openView = openView;

    function showNav(on){
      const nav = $("navBar");
      if(!nav) return;
      nav.style.display = on ? "block" : "none";
    }

    function updateNavActive(viewId){
      document.querySelectorAll(".navBtn").forEach(b=>b.classList.remove("active"));
      const btn = document.querySelector(`.navBtn[data-view="${viewId}"]`);
      if(btn) btn.classList.add("active");
    }

    function wireNav(){
      document.querySelectorAll(".navBtn").forEach(btn=>{
        btn.addEventListener("click", ()=> openView(btn.dataset.view));
      });
    }

    function scrollToTop(){
      window.scrollTo({ top:0, behavior:"smooth" });
    }
    window.scrollToTop = scrollToTop;

    function updateTopBtn(){
      const btn = $("btnTop");
      if(!btn) return;
      btn.style.display = (window.scrollY > 200) ? "block" : "none";
    }
    window.addEventListener("scroll", updateTopBtn, { passive:true });

    /***********************
     * 6) Cadastro + Avatar
     ***********************/
    const ESPORTES = [
      "Muscula√ß√£o","Futebol","Corrida","Crossfit","Ciclismo","Nata√ß√£o","Luta","Basquete",
      "V√¥lei","Yoga","Pilates","Caminhada","Muay Thai","Jiu-Jitsu","Boxe","Funcional"
    ];
    let selectedSports = new Set();

    function buildSportsChips(){
      const box = $("chipsEsportes");
      if(!box) return;
      box.innerHTML = "";
      ESPORTES.forEach(name=>{
        const div = document.createElement("div");
        div.className = "chip";
        div.textContent = name;
        div.addEventListener("click", ()=>{
          if(selectedSports.has(name)) selectedSports.delete(name);
          else selectedSports.add(name);
          div.classList.toggle("on");
        });
        box.appendChild(div);
      });

      const p = safeJSON(KEY_PROFILE);
      if(p && Array.isArray(p.esportes)){
        selectedSports = new Set(p.esportes);
        [...box.querySelectorAll(".chip")].forEach(ch=>{
          if(selectedSports.has(ch.textContent)) ch.classList.add("on");
        });
      }
    }

    function applyProfileToUI(){
      const p = safeJSON(KEY_PROFILE);
      if(!p) return;
      if($("nome")) $("nome").value = p.nome || "";
      if($("emailPerfil")) $("emailPerfil").value = p.email || "";
      if($("peso")) $("peso").value = p.peso || "";
      if($("altura")) $("altura").value = p.altura || "";
      if($("objetivo")) $("objetivo").value = p.objetivo || "";
      if($("nivel")) $("nivel").value = p.nivel || "";
      if($("condicao")) $("condicao").value = p.condicao || "";
      if($("restricao")) $("restricao").value = p.restricao || "";
      if($("termo")) $("termo").checked = true;
    }

    async function salvarCadastro(){
      const termo = $("termo")?.checked;
      if(!termo){
        alert("Marque 'Aceito o termo' para salvar.");
        return;
      }
      const perfil = {
        nome: ($("nome")?.value || "").trim(),
        email: ($("emailPerfil")?.value || "").trim(),
        peso: ($("peso")?.value || "").trim(),
        altura: ($("altura")?.value || "").trim(),
        objetivo: $("objetivo")?.value || "",
        nivel: $("nivel")?.value || "",
        condicao: $("condicao")?.value || "",
        restricao: $("restricao")?.value || "",
        esportes: Array.from(selectedSports),
        updatedAt: Date.now()
      };
      localStorage.setItem(KEY_PROFILE, JSON.stringify(perfil));
      const out = $("outCadastro");
      if(out){ out.style.display="block"; out.textContent="‚úÖ Cadastro salvo."; }
      updatePerfilBox();
      refreshCoach();
      await pushToCloud();
    }
    window.salvarCadastro = salvarCadastro;

    async function limparCadastro(){
      localStorage.removeItem(KEY_PROFILE);
      ["nome","emailPerfil","peso","altura"].forEach(id=>{ if($(id)) $(id).value=""; });
      ["objetivo","nivel","condicao","restricao"].forEach(id=>{ if($(id)) $(id).value=""; });
      if($("termo")) $("termo").checked = false;
      selectedSports = new Set();
      buildSportsChips();
      const out = $("outCadastro");
      if(out){ out.style.display="block"; out.textContent="üßπ Cadastro limpo."; }
      updatePerfilBox();
      refreshCoach();
      await pushToCloud();
    }
    window.limparCadastro = limparCadastro;

    function pickAvatar(){
      const f = $("avatarFile");
      if(f) f.click();
    }
    window.pickAvatar = pickAvatar;

    function applyAvatar(){
      const dataUrl = localStorage.getItem(KEY_AVATAR);
      const img = $("avatarImg");
      const fb = $("avatarFallback");
      if(img && fb){
        if(dataUrl){
          img.src = dataUrl;
          img.style.display = "block";
          fb.style.display = "none";
        }else{
          img.style.display = "none";
          fb.style.display = "flex";
        }
      }
    }

    function wireAvatarInput(){
      const f = $("avatarFile");
      if(!f) return;
      f.addEventListener("change", async ()=>{
        const file = f.files?.[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async ()=>{
          const dataUrl = String(reader.result || "");
          localStorage.setItem(KEY_AVATAR, dataUrl);
          applyAvatar();
          await pushToCloud();
        };
        reader.readAsDataURL(file);
      });
    }
    /***********************
     * 7) PRATO (foto real + an√°lise + IA aprende)
     ***********************/
    function getPlateHistory(){
      try{ return JSON.parse(localStorage.getItem(KEY_PLATE_HISTORY) || "[]"); }catch{ return []; }
    }
    function setPlateHistory(arr){
      localStorage.setItem(KEY_PLATE_HISTORY, JSON.stringify(arr.slice(0, 60)));
    }

    function getAIProfile(){
      const p = safeJSON(KEY_AI_PROFILE);
      return (p && typeof p === "object") ? p : { likes: {}, dislikes: {}, avgScore: 70, tone: "modern" };
    }
    function setAIProfile(p){
      localStorage.setItem(KEY_AI_PROFILE, JSON.stringify(p));
    }

    function normalizeWords(text){
      return (text || "")
        .toLowerCase()
        .replace(/[^\p{L}\p{N}\s]/gu, " ")
        .split(/\s+/)
        .filter(Boolean)
        .slice(0, 80);
    }

    function scorePlate({ desc, focus }){
      const t = (desc || "").toLowerCase();
      let s = 62;

      // positivos
      const good = [
        "salada","legume","legumes","verdura","frango","peixe","ovo","ovos",
        "arroz integral","integral","feij√£o","feijao","batata doce","batata-doce","iogurte",
        "aveia","banana","ma√ß√£","maca","castanha","√°gua","agua"
      ];

      // negativos
      const bad = [
        "fritura","frito","refrigerante","doce","sobremesa","ultraprocessado","salgadinho",
        "hamburguer","hamb√∫rguer","pizza","alcohol","√°lcool","cerveja","a√ß√∫car","acucar"
      ];

      good.forEach(k=>{ if(t.includes(k)) s += 6; });
      bad.forEach(k=>{ if(t.includes(k)) s -= 9; });

      // foco ajusta
      if((focus||"").toLowerCase().includes("emagre")) s -= t.includes("refrigerante") ? 6 : 0;
      if((focus||"").toLowerCase().includes("hiper")) s += t.includes("frango") || t.includes("ovo") || t.includes("peixe") ? 6 : 0;

      // AI aprende: penaliza coisas que voc√™ sempre marca como "ruim" no feedback impl√≠cito
      const ai = getAIProfile();
      const words = normalizeWords(desc);
      let bias = 0;
      for(const w of words){
        if(ai.dislikes[w]) bias -= Math.min(4, ai.dislikes[w]);
        if(ai.likes[w]) bias += Math.min(3, ai.likes[w] * 0.6);
      }
      s += bias;

      return Math.max(10, Math.min(100, Math.round(s)));
    }

    function estimateMacros({ desc, qtd, focus }){
      // heur√≠stica forte (sem backend), variando por foco e por palavras
      const t = (desc||"").toLowerCase();
      let kcal = 520;
      let prot = 26;
      let carb = 60;
      let fat  = 16;

      const add = (dk, dp, dc, df)=>{ kcal+=dk; prot+=dp; carb+=dc; fat+=df; };

      if(t.includes("frango")) add(120, 22, 0, 3);
      if(t.includes("carne")) add(160, 26, 0, 6);
      if(t.includes("peixe")) add(130, 24, 0, 4);
      if(t.includes("ovo")) add(90, 10, 1, 7);
      if(t.includes("arroz")) add(140, 2, 30, 1);
      if(t.includes("feij√£o") || t.includes("feijao")) add(110, 7, 18, 1);
      if(t.includes("batata")) add(120, 2, 25, 1);
      if(t.includes("salada") || t.includes("legume") || t.includes("verdura")) add(40, 2, 6, 0);
      if(t.includes("refrigerante")) add(160, 0, 40, 0);
      if(t.includes("doce") || t.includes("sobremesa")) add(220, 2, 40, 8);
      if(t.includes("pizza") || t.includes("hamb")) add(280, 16, 28, 16);

      // quantidade
      if((qtd||"").toLowerCase().includes("pequena")) { kcal-=160; prot-=6; carb-=18; fat-=5; }
      if((qtd||"").toLowerCase().includes("grande"))  { kcal+=260; prot+=10; carb+=26; fat+=8; }

      // foco
      const f = (focus||"").toLowerCase();
      if(f.includes("emagre")) { kcal = Math.round(kcal * 0.88); fat = Math.round(fat * 0.92); }
      if(f.includes("hiper"))  { prot = Math.round(prot * 1.15); kcal = Math.round(kcal * 1.07); }
      if(f.includes("perform")){ carb = Math.round(carb * 1.08); }

      kcal = Math.max(180, Math.round(kcal));
      prot = Math.max(5, Math.round(prot));
      carb = Math.max(5, Math.round(carb));
      fat  = Math.max(3, Math.round(fat));

      return { kcal, prot, carb, fat };
    }

    function plateBadges({ score, prot, kcal }){
      const badges = [];
      if(score >= 82) badges.push("üî• Elite");
      if(score >= 70 && score < 82) badges.push("üí™ Bom");
      if(score < 55) badges.push("‚ö° Ajust√°vel");
      if(prot >= 35) badges.push("ü•© Prote√≠na+");
      if(kcal <= 520) badges.push("üü¢ Leve");
      if(kcal >= 850) badges.push("üü† Refor√ßado");
      return badges;
    }

    function wirePratoInputs(){
      const camBtn = $("btnPratoCamera");
      const galBtn = $("btnPratoGaleria");
      const fc = $("filePratoCamera");
      const fg = $("filePratoGaleria");

      if(camBtn && fc) camBtn.addEventListener("click", ()=> fc.click());
      if(galBtn && fg) galBtn.addEventListener("click", ()=> fg.click());

      async function onFile(file){
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async ()=>{
          const dataUrl = String(reader.result || "");
          localStorage.setItem(KEY_PLATE_LAST, dataUrl);
          showPratoPreview(dataUrl);
          renderPratoHistory();
          await pushToCloud();
        };
        reader.readAsDataURL(file);
      }

      if(fc) fc.addEventListener("change", ()=> onFile(fc.files?.[0]));
      if(fg) fg.addEventListener("change", ()=> onFile(fg.files?.[0]));
    }

    function showPratoPreview(dataUrl){
      const box = $("pratoPreview");
      const img = $("pratoImg");
      if(!box || !img) return;
      img.src = dataUrl;
      box.style.display = "block";
    }

    function loadLastPrato(){
      const dataUrl = localStorage.getItem(KEY_PLATE_LAST);
      if(dataUrl) showPratoPreview(dataUrl);
    }

    function setPratoResult(html){
      const out = $("pratoResultado");
      if(!out) return;
      out.innerHTML = html;
      out.style.display = "block";
    }

    function pratoCoachCopy(score, focus){
      const f = (focus||"Equil√≠brio").toLowerCase();
      const pool = [
        "Consist√™ncia √© o que muda o jogo. Um prato melhor por dia te deixa inevit√°vel.",
        "Voc√™ n√£o precisa de perfei√ß√£o. Precisa de repeti√ß√£o inteligente.",
        "A meta √© simples: escolhas pequenas, resultado grande.",
        "Foco no h√°bito. O corpo responde com o tempo.",
        "Um dia bom n√£o te define. Uma semana consistente, sim."
      ];

      if(score >= 85) return "üî• Isso √© elite. Mant√©m esse padr√£o e o f√≠sico acompanha.";
      if(score >= 70) return f.includes("hiper")
        ? "üí™ Bom. Se quiser subir mais, aumenta prote√≠na magra + carbo limpo."
        : "üí™ Bom. Pra ficar elite, coloca mais vegetais e controla ultraprocessados.";
      if(score >= 55) return "‚ö° D√° pra melhorar r√°pido: corta bebida a√ßucarada e coloca prote√≠na + salada.";
      return pool[Math.floor(Math.random()*pool.length)];
    }

    // Gamifica√ß√£o
    function getGamify(){
      const g = safeJSON(KEY_GAMIFY);
      return (g && typeof g === "object") ? g : { streak:0, xp:0, lastDay:"", medals:{} };
    }
    function setGamify(g){
      localStorage.setItem(KEY_GAMIFY, JSON.stringify(g));
    }

    function todayKey(){
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    }

    function addXP(amount){
      const g = getGamify();
      g.xp = Math.max(0, Math.round((g.xp || 0) + amount));
      setGamify(g);
    }

    function updateStreak(){
      const g = getGamify();
      const t = todayKey();
      if(g.lastDay === t) return g;

      // diferen√ßa de dias
      const prev = g.lastDay ? new Date(g.lastDay) : null;
      const now  = new Date(t);
      if(!prev){
        g.streak = 1;
      }else{
        const diff = Math.round((now - prev) / (1000*60*60*24));
        if(diff === 1) g.streak = (g.streak || 0) + 1;
        else g.streak = 1;
      }

      g.lastDay = t;
      setGamify(g);
      return g;
    }

    function levelFromXP(xp){
      // curva suave: 0-99 lvl1, 100-219 lvl2, etc
      let lvl = 1;
      let need = 100;
      let acc = 0;
      while(xp >= acc + need){
        acc += need;
        lvl++;
        need = Math.round(need * 1.12);
        if(lvl > 50) break;
      }
      const nextNeed = need;
      const into = xp - acc;
      const pct = Math.max(0, Math.min(100, Math.round((into / nextNeed) * 100)));
      return { lvl, pct, into, nextNeed };
    }

    function unlockMedals(){
      const g = getGamify();
      g.medals = g.medals || {};
      const hist = getPlateHistory();

      const count = hist.length;
      const avg7 = averageScore(7);
      const streak = g.streak || 0;
      const xp = g.xp || 0;

      const set = (k)=>{ if(!g.medals[k]) g.medals[k] = Date.now(); };
      if(count >= 5) set("primeiros_5_pratos");
      if(count >= 20) set("viciado_em_progresso");
      if(streak >= 3) set("streak_3");
      if(streak >= 7) set("streak_7");
      if(streak >= 14) set("streak_14");
      if(avg7 >= 75) set("media_75");
      if(avg7 >= 85) set("media_85");
      if(xp >= 500) set("xp_500");
      if(xp >= 1500) set("xp_1500");

      setGamify(g);
      return g;
    }

    function renderMedals(){
      const g = unlockMedals();
      const row1 = $("medalRow");
      const row2 = $("medalRow2");
      const make = (key, label)=>{
        const div = document.createElement("div");
        div.className = "badge " + (g.medals[key] ? "ok" : "");
        div.textContent = label;
        return div;
      };

      const items = [
        ["primeiros_5_pratos","ü•á 5 pratos"],
        ["viciado_em_progresso","üèÖ 20 pratos"],
        ["streak_3","üî• 3 dias"],
        ["streak_7","üî• 7 dias"],
        ["streak_14","üî• 14 dias"],
        ["media_75","üìà m√©dia 75"],
        ["media_85","üíé m√©dia 85"],
        ["xp_500","‚ö° XP 500"],
        ["xp_1500","‚ö° XP 1500"],
      ];

      [row1,row2].forEach(r=>{
        if(!r) return;
        r.innerHTML = "";
        items.forEach(([k,l])=> r.appendChild(make(k,l)));
      });
    }

    function proteinGoal(){
      const p = safeJSON(KEY_PROFILE) || {};
      const w = Math.max(40, Math.min(180, parseFloat(p.peso || "70") || 70));
      const obj = (p.objetivo || "Manter").toLowerCase();
      let factor = 1.6; // equil√≠brio
      if(obj.includes("massa")) factor = 2.0;
      if(obj.includes("emag")) factor = 1.7;
      if(obj.includes("perform")) factor = 1.8;
      return Math.round(w * factor);
    }

    function proteinToday(){
      const hist = getPlateHistory();
      const t = todayKey();
      const today = hist.filter(x=> (x.dayKey || "") === t);
      return today.reduce((a,b)=> a + (b.prot || 0), 0);
    }

    function averageScore(n){
      const hist = getPlateHistory();
      const slice = hist.slice(0, n);
      if(!slice.length) return 0;
      const avg = slice.reduce((a,b)=> a + (b.score || 0), 0) / slice.length;
      return Math.round(avg);
    }

    // ‚Äúsocial fake‚Äù (compara√ß√£o)
    function socialPercent(avg7){
      // escala: 50..95
      const p = Math.round(50 + (Math.max(0, Math.min(100, avg7)) * 0.45));
      return Math.max(50, Math.min(95, p));
    }

    let lastPratoAnalysis = null;

    function analisarPratoElite(){
      const dataUrl = localStorage.getItem(KEY_PLATE_LAST);
      const desc = ($("pratoDesc")?.value || "").trim();
      const qtd  = $("pratoQtd")?.value || "M√©dia";
      const focus= $("pratoFoco")?.value || "Equil√≠brio";

      if(!dataUrl){
        setPratoResult("üì∏ Envie uma foto primeiro.");
        return;
      }
      if(!desc){
        setPratoResult("‚úçÔ∏è Descreva o prato (r√°pido). Ex: arroz, feij√£o, frango, salada.");
        return;
      }

      const m = estimateMacros({ desc, qtd, focus });
      const score = scorePlate({ desc, focus });
      const badges = plateBadges({ score, prot: m.prot, kcal: m.kcal });

      // IA aprende (incrementa prefer√™ncias por palavras)
      const ai = getAIProfile();
      const words = normalizeWords(desc);
      words.forEach(w=>{
        ai.likes[w] = (ai.likes[w] || 0) + (score >= 70 ? 1 : 0);
        ai.dislikes[w] = (ai.dislikes[w] || 0) + (score < 55 ? 1 : 0);
      });
      ai.avgScore = Math.round((ai.avgScore * 0.85) + (score * 0.15));
      setAIProfile(ai);

      lastPratoAnalysis = { ts: Date.now(), dayKey: todayKey(), desc, qtd, focus, ...m, score, badges };

      const coach = pratoCoachCopy(score, focus);
      const html = `
        ‚úÖ <b>An√°lise pronta</b><br><br>
        <b>Score:</b> ${score}/100<br>
        <b>Estimativa:</b> ${m.kcal} kcal ‚Ä¢ ${m.prot}g prote√≠na ‚Ä¢ ${m.carb}g carbo ‚Ä¢ ${m.fat}g gorduras<br>
        <b>Foco:</b> ${escapeHtml(focus)} ‚Ä¢ <b>Qtd:</b> ${escapeHtml(qtd)}<br><br>
        <span class="muted">${escapeHtml(coach)}</span><br><br>
        <span class="muted">Agora clique em <b>CONFIRMAR E SALVAR</b> para guardar no hist√≥rico.</span>
      `;
      setPratoResult(html);

      // resumo + badges
      const resumo = $("pratoResumo");
      if(resumo) resumo.textContent = coach;
      const br = $("pratoBadges");
      if(br){
        br.innerHTML = "";
        badges.forEach(b=>{
          const d = document.createElement("div");
          d.className = "badge ok";
          d.textContent = b;
          br.appendChild(d);
        });
      }
    }
    window.analisarPratoElite = analisarPratoElite;

    async function confirmarPratoElite(){
      if(!lastPratoAnalysis){
        setPratoResult("Fa√ßa a an√°lise primeiro.");
        return;
      }

      // salva hist√≥rico
      const hist = getPlateHistory();
      hist.unshift(lastPratoAnalysis);
      setPlateHistory(hist);

      // streak / xp / medalhas
      const g = updateStreak();
      // xp: score/2 + b√¥nus de prote√≠na/meta + b√¥nus streak
      const bonusProt = proteinToday() >= proteinGoal() ? 14 : 0;
      const bonusStreak = Math.min(18, Math.floor((g.streak || 1) / 3) * 6);
      addXP(Math.round(lastPratoAnalysis.score / 2) + bonusProt + bonusStreak);
      unlockMedals();

      setPratoResult("‚úÖ Salvo no hist√≥rico. Continue ‚Äî consist√™ncia vence.");
      lastPratoAnalysis = null;

      renderPratoHistory();
      refreshCoach();
      renderMedals();
      renderEvolucao();
      renderDash();
      updatePerfilBox();
      await pushToCloud();
    }
    window.confirmarPratoElite = confirmarPratoElite;

    function renderPratoHistory(){
      const el = $("pratoHistTxt");
      if(!el) return;
      const h = getPlateHistory();
      if(!h.length){
        el.textContent = "Sem hist√≥rico ainda.";
        return;
      }
      const last = h[0];
      el.innerHTML = `
        √öltimo: <b>${escapeHtml(last.desc.slice(0, 52))}${last.desc.length>52?"‚Ä¶":""}</b>
        ‚Ä¢ Score <b>${last.score}</b> ‚Ä¢ ${last.kcal} kcal ‚Ä¢ ${last.prot}g prot
        <br><span class="muted">Total salvo: ${h.length}</span>
      `;
    }

    /***********************
     * 8) Desafios semanais
     ***********************/
    const CHALLENGES = [
      { id:"score_avg_75", title:"M√©dia 75+ por 7 dias", goal:7, tip:"Foco: prote√≠na + vegetais. Evite bebida a√ßucarada." },
      { id:"prot_goal_5", title:"Bater meta de prote√≠na 5 dias", goal:5, tip:"Inclua frango/ovos/iogurte/peixe." },
      { id:"streak_7", title:"Streak de 7 dias", goal:7, tip:"Um prato bom por dia j√° resolve." },
      { id:"water_7", title:"√Ågua 2L por 7 dias", goal:7, tip:"√Ågua melhora performance e controle de fome." },
      { id:"steps_5", title:"Caminhada 30min por 5 dias", goal:5, tip:"Lifestyle: const√¢ncia e leveza." }
    ];

    function getChallenge(){
      const c = safeJSON(KEY_CHALLENGE);
      if(c && typeof c === "object" && c.id) return c;
      const pick = CHALLENGES[Math.floor(Math.random()*CHALLENGES.length)];
      const obj = { ...pick, progress:0, weekStart: getWeekStart() };
      localStorage.setItem(KEY_CHALLENGE, JSON.stringify(obj));
      return obj;
    }

    function setChallenge(c){
      localStorage.setItem(KEY_CHALLENGE, JSON.stringify(c));
    }

    function getWeekStart(){
      const now = new Date();
      const start = new Date(now);
      start.setHours(0,0,0,0);
      start.setDate(now.getDate() - ((now.getDay()+6)%7)); // segunda
      return start.getTime();
    }

    function ensureChallengeWeek(){
      const c = getChallenge();
      const ws = getWeekStart();
      if(c.weekStart !== ws){
        const pick = CHALLENGES[Math.floor(Math.random()*CHALLENGES.length)];
        const obj = { ...pick, progress:0, weekStart: ws };
        setChallenge(obj);
        return obj;
      }
      return c;
    }

    function renderChallenge(){
      const c = ensureChallengeWeek();
      const txt = $("challengeTxt");
      const bar = $("challengeBar");
      if(txt){
        txt.innerHTML = `<b>${escapeHtml(c.title)}</b><br><span class="muted">${escapeHtml(c.tip)}</span>`;
      }
      if(bar){
        const pct = Math.max(0, Math.min(100, Math.round((c.progress / c.goal) * 100)));
        bar.style.width = pct + "%";
      }
    }

    function rerollChallenge(){
      const pick = CHALLENGES[Math.floor(Math.random()*CHALLENGES.length)];
      const obj = { ...pick, progress:0, weekStart: getWeekStart() };
      setChallenge(obj);
      renderChallenge();
      pushToCloud();
    }
    window.rerollChallenge = rerollChallenge;

    function markChallengeStep(){
      const c = ensureChallengeWeek();
      c.progress = Math.min(c.goal, (c.progress || 0) + 1);
      setChallenge(c);
      renderChallenge();
      // b√¥nus XP quando completa
      if(c.progress >= c.goal){
        addXP(60);
        setPratoResult("üèÅ Desafio conclu√≠do! +60 XP");
        renderMedals();
        refreshCoach();
      }
      pushToCloud();
    }
    window.markChallengeStep = markChallengeStep;

    /***********************
     * 9) Notifica√ß√µes inteligentes
     ***********************/
    function getNotifCfg(){
      const n = safeJSON(KEY_NOTIF);
      return (n && typeof n === "object") ? n : { enabled:false, h1:12, h2:19 };
    }
    function setNotifCfg(n){
      localStorage.setItem(KEY_NOTIF, JSON.stringify(n));
    }

    async function openNotifPrompt(){
      const cfg = getNotifCfg();
      const on = confirm(`Notifica√ß√µes: ${cfg.enabled ? "ATIVADAS" : "DESATIVADAS"}\n\nQuer ${cfg.enabled ? "DESATIVAR" : "ATIVAR"} agora?`);
      cfg.enabled = !cfg.enabled;
      setNotifCfg(cfg);

      if(cfg.enabled){
        if(!("Notification" in window)){
          alert("Seu navegador n√£o suporta notifica√ß√µes.");
          cfg.enabled = false;
          setNotifCfg(cfg);
          return;
        }
        const perm = await Notification.requestPermission();
        if(perm !== "granted"){
          alert("Permiss√£o negada. N√£o foi poss√≠vel ativar.");
          cfg.enabled = false;
          setNotifCfg(cfg);
          return;
        }
        scheduleDailyNotifs();
        alert("‚úÖ Notifica√ß√µes ativadas.");
      }else{
        alert("‚úÖ Notifica√ß√µes desativadas.");
      }
    }
    window.openNotifPrompt = openNotifPrompt;

    let notifTimers = [];
    function clearNotifs(){
      notifTimers.forEach(t=> clearTimeout(t));
      notifTimers = [];
    }

    function scheduleDailyNotifs(){
      clearNotifs();
      const cfg = getNotifCfg();
      if(!cfg.enabled) return;

      const scheduleAt = (hour)=>{
        const now = new Date();
        const t = new Date(now);
        t.setHours(hour, 0, 0, 0);
        if(t <= now) t.setDate(t.getDate()+1);
        const ms = t - now;

        const timer = setTimeout(()=>{
          try{
            const avg7 = averageScore(7);
            const msg = avg7 >= 80
              ? "üî• Voc√™ t√° voando. Mant√©m a consist√™ncia hoje."
              : avg7 >= 65
                ? "üí™ Hoje √© dia de subir o score. Um prato melhor j√° resolve."
                : "‚ö° Faz o b√°sico bem feito: prote√≠na + salada + √°gua.";
            new Notification("CheckPrato Elite", { body: msg });
          }catch{}
          scheduleDailyNotifs(); // re-agenda
        }, ms);

        notifTimers.push(timer);
      };

      scheduleAt(cfg.h1 || 12);
      scheduleAt(cfg.h2 || 19);
    }

    /***********************
     * 10) Evolu√ß√£o (gr√°fico + ranking + meta prote√≠na)
     ***********************/
    let scoreChart = null;

    function renderScoreChart(){
      const canvas = $("scoreChart");
      if(!canvas) return;

      const h = getPlateHistory().slice(0, 14).reverse();
      const labels = h.map(x=>{
        const d = new Date(x.ts);
        return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}`;
      });
      const data = h.map(x=> x.score || 0);

      if(scoreChart){
        scoreChart.destroy();
        scoreChart = null;
      }

      scoreChart = new Chart(canvas.getContext("2d"), {
        type: "line",
        data: {
          labels,
          datasets: [{
            data,
            tension: 0.35,
            borderWidth: 2,
            pointRadius: 2,
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display:false } },
          scales: {
            y: { min: 0, max: 100, ticks: { color: "rgba(234,242,255,.65)" }, grid: { color:"rgba(255,255,255,.08)" } },
            x: { ticks: { color: "rgba(234,242,255,.65)" }, grid: { color:"rgba(255,255,255,.06)" } }
          }
        }
      });
    }

    function renderEvolucao(){
      const avg7 = averageScore(7);
      const pct = socialPercent(avg7);
      const protG = proteinGoal();
      const protT = proteinToday();
      const scoreToday = (getPlateHistory().find(x=> x.dayKey === todayKey())?.score) ?? "‚Äî";

      if($("rankTxt")) $("rankTxt").innerHTML = `Voc√™ est√° melhor que <b>${pct}%</b> dos usu√°rios (compara√ß√£o motivacional).`;
      if($("avg7Txt")) $("avg7Txt").textContent = avg7 ? `${avg7}/100` : "‚Äî";
      if($("protGoalTxt")) $("protGoalTxt").textContent = `${protG}g`;
      if($("protTodayTxt")) $("protTodayTxt").textContent = `${protT}g`;
      if($("scoreTodayTxt")) $("scoreTodayTxt").textContent = scoreToday;

      const g = unlockMedals();
      const lvl = levelFromXP(g.xp || 0);

      if($("streakTxt2")) $("streakTxt2").textContent = String(g.streak || 0);
      if($("lvlTxt2")) $("lvlTxt2").textContent = String(lvl.lvl);
      if($("xpTxt2")) $("xpTxt2").textContent = String(g.xp || 0);
      if($("xpBar2")) $("xpBar2").style.width = `${lvl.pct}%`;

      renderScoreChart();
      renderMedals();
    }

    function refreshCoach(){
      const g = unlockMedals();
      const lvl = levelFromXP(g.xp || 0);

      if($("streakTxt")) $("streakTxt").textContent = String(g.streak || 0);
      if($("lvlTxt")) $("lvlTxt").textContent = String(lvl.lvl);
      if($("xpTxt")) $("xpTxt").textContent = String(g.xp || 0);
      if($("xpBar")) $("xpBar").style.width = `${lvl.pct}%`;

      const avg7 = averageScore(7);
      const p = safeJSON(KEY_PROFILE) || {};
      const obj = (p.objetivo || "Equil√≠brio");
      const coach = avg7 >= 85
        ? "üíé Elite real. Mant√©m o ritmo e escala o resto."
        : avg7 >= 70
          ? "üí™ T√° s√≥lido. Agora √© consist√™ncia + pequenos ajustes."
          : avg7 >= 55
            ? "‚ö° Voc√™ j√° come√ßou. Agora corta distra√ß√µes e faz o b√°sico bem feito."
            : "üß† Come√ßa simples: prote√≠na + salada + √°gua. Repetir > motiva√ß√£o.";

      if($("coachTxt")) $("coachTxt").textContent = `${coach} ‚Ä¢ Objetivo: ${obj}`;
    }
    /***********************
     * 11) Dieta (mais varia√ß√µes)
     ***********************/
    const DIETAS_BASE = [
      [
        {t:"Caf√© da manh√£", d:"Omelete 2 ovos + aveia com banana.", k:520},
        {t:"Lanche", d:"Iogurte natural + chia + fruta.", k:260},
        {t:"Almo√ßo", d:"Frango + arroz + feij√£o + salada.", k:720},
        {t:"Lanche", d:"Castanhas + 1 fruta.", k:220},
        {t:"Jantar", d:"Peixe + legumes + batata-doce.", k:680},
      ],
      [
        {t:"Caf√© da manh√£", d:"Tapioca com queijo + caf√© sem a√ß√∫car.", k:420},
        {t:"Almo√ßo", d:"Carne magra + mandioca + salada.", k:760},
        {t:"Jantar", d:"Omelete + legumes + azeite.", k:540},
        {t:"Ceia", d:"Iogurte + granola.", k:300},
      ],
      [
        {t:"Caf√© da manh√£", d:"P√£o integral + ovos + fruta.", k:520},
        {t:"Almo√ßo", d:"Arroz integral + feij√£o + frango + salada.", k:740},
        {t:"Jantar", d:"Macarr√£o integral + frango + molho caseiro.", k:720},
        {t:"Ceia", d:"Cottage/ricota + fruta.", k:260},
      ],
      [
        {t:"Caf√© da manh√£", d:"Vitamina: leite/iogurte + banana + aveia.", k:520},
        {t:"Lanche", d:"Sandu√≠che integral com atum.", k:420},
        {t:"Almo√ßo", d:"Peixe + arroz + feij√£o + salada.", k:720},
        {t:"Jantar", d:"Carne + legumes + batata.", k:760},
      ]
    ];

    function renderDieta(d){
      const box = $("dietaBox");
      if(!box) return;
      box.innerHTML = "";
      if(!d){
        const s = document.createElement("div");
        s.className="status";
        s.textContent="Gere uma dieta para aparecer aqui.";
        box.appendChild(s);
        return;
      }
      d.forEach(m=>{
        const div = document.createElement("div");
        div.className="meal";
        div.innerHTML = `
          <div>
            <div class="title">${escapeHtml(m.t)}</div>
            <p>${escapeHtml(m.d)}</p>
          </div>
          <div class="kcal">${Number(m.k||0)}<br/>kcal</div>
        `;
        box.appendChild(div);
      });
    }

    function gerarDieta(){
      const p = safeJSON(KEY_PROFILE) || {};
      const objetivo = (p.objetivo || "Manter").toLowerCase();
      let pick = DIETAS_BASE[Math.floor(Math.random()*DIETAS_BASE.length)];

      // Ajuste simples por objetivo (sem prometer precis√£o)
      if(objetivo.includes("emag")){
        pick = pick.map(x=> ({...x, k: Math.max(180, Math.round(x.k * 0.88))}));
      }
      if(objetivo.includes("massa")){
        pick = pick.map(x=> ({...x, k: Math.round(x.k * 1.08)}));
      }

      localStorage.setItem(KEY_DIETA, JSON.stringify(pick));
      renderDieta(pick);
      pushToCloud();
    }
    window.gerarDieta = gerarDieta;

    function refazerDieta(){ gerarDieta(); }
    window.refazerDieta = refazerDieta;

    /***********************
     * 12) Treino (mais esportes)
     ***********************/
    const TREINOS = {
      "Academia": [
        ["Segunda", ["Agachamento","Supino","Remada","Panturrilha"]],
        ["Quarta", ["Desenvolvimento","Puxada","Abdominal prancha","Eleva√ß√£o lateral"]],
        ["Sexta", ["Levantamento terra","Rosca","Tr√≠ceps","Abdominal"]],
      ],
      "Corrida": [
        ["Segunda", ["Corrida leve 30 min","Mobilidade"]],
        ["Quarta", ["Tiros 10x 200m","Alongamento"]],
        ["Sexta", ["Corrida moderada 45 min","Core"]],
      ],
      "Muay Thai":[
        ["Ter√ßa", ["Sombra 10 min","Chutes b√°sicos","Combina√ß√µes"]],
        ["Quinta", ["Manopla","Defesas","Condicionamento"]],
        ["S√°bado", ["Clinch","Sequ√™ncias","Alongamento"]],
      ],
      "Futebol":[
        ["Segunda", ["Arranque","Controle de bola","Finaliza√ß√£o"]],
        ["Quarta", ["Agilidade","Passe e dom√≠nio","Resist√™ncia"]],
        ["Sexta", ["Jogo reduzido","Alongamento"]],
      ],
      "Basquete":[
        ["Ter√ßa", ["Drible","Arremessos","Pliometria"]],
        ["Quinta", ["Defesa lateral","Bandejas","Condicionamento"]],
        ["S√°bado", ["Treino de jogo","Alongamento"]],
      ],
      "V√¥lei":[
        ["Ter√ßa", ["Saque","Recep√ß√£o","Pliometria"]],
        ["Quinta", ["Ataque","Bloqueio","Mobilidade"]],
        ["S√°bado", ["Jogo reduzido","Alongamento"]],
      ],
      "Nata√ß√£o":[
        ["Segunda", ["T√©cnica 30 min","S√©ries leves"]],
        ["Quarta", ["S√©ries 10x 50m","Respira√ß√£o"]],
        ["Sexta", ["Long√£o 40 min","Alongamento"]],
      ],
      "Ciclismo":[
        ["Segunda", ["Giro leve 40 min","Mobilidade"]],
        ["Quarta", ["Subidas 6x 2min","Giro"]],
        ["Sexta", ["Giro moderado 60 min","Core"]],
      ],
      "Crossfit":[
        ["Segunda", ["WOD leve","Mobilidade","T√©cnica"]],
        ["Quarta", ["For√ßa","WOD moderado","Alongamento"]],
        ["Sexta", ["WOD pesado","Core","Alongamento"]],
      ],
      "Pilates":[
        ["Segunda", ["Core","Postura","Respira√ß√£o"]],
        ["Quarta", ["Estabilidade","Flexibilidade"]],
        ["Sexta", ["Controle motor","Alongamento"]],
      ],
      "Yoga":[
        ["Segunda", ["Flow leve","Respira√ß√£o"]],
        ["Quarta", ["Mobilidade","Alongamento"]],
        ["Sexta", ["For√ßa isom√©trica","Relaxamento"]],
      ]
    };

    function renderTreino(t){
      const box = $("treinoSemana");
      if(!box) return;
      box.innerHTML = "";
      if(!t){
        const s = document.createElement("div");
        s.className="status";
        s.textContent="Gere um treino para aparecer aqui.";
        box.appendChild(s);
        return;
      }

      t.dias.forEach(d=>{
        const day = document.createElement("div");
        day.className="dayCard";
        day.innerHTML = `<div class="dayTitle"><span>${escapeHtml(d[0])}</span><span class="muted">${escapeHtml(t.tema)}</span></div>`;
        (d[1]||[]).forEach(ex=>{
          const row = document.createElement("div");
          row.className="exercise";
          const left = document.createElement("div");
          left.innerHTML = `<b>${escapeHtml(ex)}</b><div class="muted" style="font-size:12px; margin-top:4px">${escapeHtml(t.intensidade)}</div>`;
          const btn = document.createElement("button");
          btn.className="ytBtn";
          btn.textContent="Ver t√©cnica";
          btn.addEventListener("click", ()=> abrirLink(`https://www.youtube.com/results?search_query=${encodeURIComponent(ex+" como fazer")}`));
          row.appendChild(left);
          row.appendChild(btn);
          day.appendChild(row);
        });
        box.appendChild(day);
      });
    }

    function gerarTreino(){
      const tema = $("temaTreino")?.value || "Academia";
      const intensidade = $("intTreino")?.value || "Moderado";
      const base = TREINOS[tema] || TREINOS["Academia"];
      const plano = { tema, intensidade, dias: base, createdAt: Date.now() };
      localStorage.setItem(KEY_TREINO, JSON.stringify(plano));
      renderTreino(plano);

      const out = $("outTreino");
      if(out){ out.style.display="block"; out.textContent = `‚úÖ Treino salvo: ${tema} (${intensidade}).`; }

      // treino conta para streak (h√°bitos)
      updateStreak();
      addXP(18);
      unlockMedals();
      refreshCoach();
      renderMedals();
      renderEvolucao();

      pushToCloud();
    }
    window.gerarTreino = gerarTreino;

    function limparTreino(){
      localStorage.removeItem(KEY_TREINO);
      if($("treinoSemana")) $("treinoSemana").innerHTML = "";
      const out = $("outTreino");
      if(out){ out.style.display="block"; out.textContent="üßπ Treino removido."; }
      pushToCloud();
    }
    window.limparTreino = limparTreino;

    /***********************
     * 13) Convites + saque
     ***********************/
    function getOrCreateInviteCode(){
      let code = localStorage.getItem(KEY_INV_CODE);
      if(code) return code;
      code = "ELITE-" + Math.random().toString(16).slice(2,8).toUpperCase();
      localStorage.setItem(KEY_INV_CODE, code);
      return code;
    }
    function getMyInviteLink(){
      const code = getOrCreateInviteCode();
      const url = new URL(location.href);
      url.searchParams.set("ref", code);
      return url.toString();
    }
    function getBalance(){ return Number(localStorage.getItem(KEY_BAL) || "0"); }
    function setBalance(v){
      localStorage.setItem(KEY_BAL, String(v));
      renderInviteUI();
    }
    window.getBalance = getBalance;
    window.setBalance = setBalance;

    async function copyInviteLink(){
      const link = getMyInviteLink();
      try{
        await navigator.clipboard.writeText(link);
        alert("‚úÖ Link copiado!");
      }catch{
        prompt("Copie o link:", link);
      }
    }
    window.copyInviteLink = copyInviteLink;

    function shareInvite(){
      const link = getMyInviteLink();
      const text = `Baixa o CheckPrato Elite e usa meu link: ${link}`;
      if(navigator.share){
        navigator.share({ title:"CheckPrato Elite", text, url: link }).catch(()=>{});
      }else{
        copyInviteLink();
      }
    }
    window.shareInvite = shareInvite;

    function renderInviteUI(){
      const code = getOrCreateInviteCode();
      const link = getMyInviteLink();
      const bal = getBalance();
      const falta = Math.max(0, 50 - bal);

      if($("myCode")) $("myCode").textContent = code;
      if($("myLink")) $("myLink").textContent = link;
      if($("balTxt")) $("balTxt").textContent = fmtBRL(bal);

      if($("progressTxt")){
        $("progressTxt").textContent = bal >= 50
          ? "‚úÖ Voc√™ atingiu R$ 50! Agora pode solicitar saque."
          : `Faltam ${fmtBRL(falta)} para atingir R$ 50.`;
      }

      const btn = $("btnSaque");
      if(btn){
        btn.disabled = bal < 50;
        btn.style.opacity = bal < 50 ? .55 : 1;
      }
    }

    function solicitarSaque(){
      const bal = getBalance();
      const msg = $("saqueMsg");
      if(!msg) return;

      if(bal < 50){
        msg.style.display="block";
        msg.textContent = "Ainda n√£o atingiu o m√≠nimo (R$50).";
        return;
      }

      msg.style.display="block";
      msg.textContent = "‚úÖ Solicita√ß√£o registrada. Depois ligamos Pix/QR de verdade no backend.";
    }
    window.solicitarSaque = solicitarSaque;

    /***********************
     * 14) Premium (escondido)
     ***********************/
    const PREMIUM_PRICE = 29.90;
    const PREMIUM_CHECKOUT_URL = "https://mpago.la/2BRjpaP"; // voc√™ troca depois
    function openCheckout(){ window.open(PREMIUM_CHECKOUT_URL, "_blank"); }
    window.openCheckout = openCheckout;

    // Acesso oculto: digitar ELITE na tela Perfil
    let secret = "";
    window.addEventListener("keydown",(e)=>{
      const active = document.querySelector(".screen.active");
      if(!active || active.id !== "viewPerfil") return;
      const k = (e.key || "").toUpperCase();
      if(!/^[A-Z]$/.test(k)) return;
      secret = (secret + k).slice(-5);
      if(secret === "ELITE"){
        openView("viewPremium");
        secret = "";
      }
    });

    /***********************
     * 15) Dashboard (kcal, km, dias)
     ***********************/
    function getDash(){
      const d = safeJSON(KEY_DASH);
      if(d && typeof d === "object") return d;

      const now = new Date();
      const start = new Date(now);
      start.setHours(0,0,0,0);
      start.setDate(now.getDate() - ((now.getDay()+6)%7)); // segunda
      return { kcal:0, km:0, done:0, goal:7, weekStart: start.getTime() };
    }
    function setDash(d){
      localStorage.setItem(KEY_DASH, JSON.stringify(d));
      renderDash();
      pushToCloud();
    }

    function weekLabel(ts){
      const dt = new Date(ts);
      const dd = String(dt.getDate()).padStart(2,"0");
      const mm = String(dt.getMonth()+1).padStart(2,"0");
      return `Semana ‚Ä¢ ${dd}/${mm}`;
    }

    function setProgressoUI({ kcal, km, doneDays, goalDays, weekStart }){
      $("proKcal").textContent = String(Math.round(kcal));
      $("proKm").textContent = String(Math.round(km));
      $("proDone").textContent = String(doneDays);
      $("proGoal").textContent = String(goalDays);
      $("proDays").textContent = String(doneDays);
      $("proDaysGoal").textContent = String(goalDays);
      $("proWeek").textContent = weekLabel(weekStart);

      const pct = goalDays > 0 ? Math.max(0, Math.min(100, Math.round((doneDays / goalDays) * 100))) : 0;
      $("proPct").textContent = pct + "%";

      const C = 301.59;
      const offset = C - (C * pct / 100);
      const ring = $("ringProg");
      ring.style.strokeDasharray = String(C);
      ring.style.strokeDashoffset = String(offset);

      const resumo = $("proResumo");
      if(resumo){
        resumo.innerHTML = `Voc√™ fez <b>${doneDays}</b> dias de treino, <b>${Math.round(km)} km</b> e <b>${Math.round(kcal)} kcal</b> na semana.`;
      }
    }

    function renderDash(){
      const d = getDash();
      setProgressoUI({ kcal:d.kcal, km:d.km, doneDays:d.done, goalDays:d.goal, weekStart:d.weekStart });
      refreshCoach();
      renderChallenge();
      renderPratoHistory();
      renderEvolucao();
      updatePerfilBox();
    }

    function addKcal(){ const d = getDash(); d.kcal += 500; setDash(d); }
    window.addKcal = addKcal;

    function addKm(){ const d = getDash(); d.km += 2; setDash(d); }
    window.addKm = addKm;

    function addTreinoDone(){
      const d = getDash();
      d.done = Math.min(d.goal, d.done + 1);
      setDash(d);
      updateStreak();
      addXP(10);
      unlockMedals();
      renderMedals();
      refreshCoach();
      renderEvolucao();
    }
    window.addTreinoDone = addTreinoDone;

    function resetProgresso(){
      const d = getDash();
      d.kcal = 0; d.km = 0; d.done = 0;
      const now = new Date();
      const start = new Date(now);
      start.setHours(0,0,0,0);
      start.setDate(now.getDate() - ((now.getDay()+6)%7));
      d.weekStart = start.getTime();
      setDash(d);
    }
    window.resetProgresso = resetProgresso;

    function setGoalDaysPrompt(){
      const d = getDash();
      const v = prompt("Meta de dias de treino na semana (ex: 5, 6, 7):", String(d.goal));
      if(v === null) return;
      const n = Math.max(1, Math.min(14, parseInt(v,10) || d.goal));
      d.goal = n;
      if(d.done > d.goal) d.done = d.goal;
      setDash(d);
    }
    window.setGoalDaysPrompt = setGoalDaysPrompt;

    /***********************
     * 16) Perfil
     ***********************/
    function updatePerfilBox(){
      const p = safeJSON(KEY_PROFILE) || {};
      const dash = getDash();
      const mode = localStorage.getItem(KEY_GUEST) ? "Convidado (Local)" : (currentUser ? "Logado" : "Local");
      const sports = Array.isArray(p.esportes) ? p.esportes.join(", ") : "‚Äî";
      const protG = proteinGoal();
      const protT = proteinToday();
      const avg7 = averageScore(7);
      const html = `
        <div><b>Modo:</b> ${escapeHtml(mode)}</div>
        <div><b>Nome:</b> ${escapeHtml(p.nome || "‚Äî")}</div>
        <div><b>Objetivo:</b> ${escapeHtml(p.objetivo || "‚Äî")}</div>
        <div><b>Esportes:</b> ${escapeHtml(sports || "‚Äî")}</div>
        <div style="margin-top:8px"><b>Semana:</b> ${escapeHtml(weekLabel(dash.weekStart))}</div>
        <div><b>Calorias:</b> ${Math.round(dash.kcal)} | <b>KM:</b> ${Math.round(dash.km)} | <b>Dias:</b> ${dash.done}/${dash.goal}</div>
        <div style="margin-top:8px"><b>Prote√≠na hoje:</b> ${protT}g / ${protG}g</div>
        <div><b>M√©dia 7 dias:</b> ${avg7 ? (avg7+"/100") : "‚Äî"}</div>
      `;
      if($("perfilBox")) $("perfilBox").innerHTML = html;
    }

    /***********************
     * 17) Init
     ***********************/
    function refreshAllUI(){
      applyProfileToUI();
      buildSportsChips();
      applyAvatar();
      loadLastPrato();
      renderPratoHistory();

      renderDieta(safeJSON(KEY_DIETA));
      renderTreino(safeJSON(KEY_TREINO));

      renderInviteUI();
      renderDash();
      renderChallenge();
      renderMedals();
      renderEvolucao();

      // Welcome message
      if($("welcomeStatus")){
        $("welcomeStatus").textContent = "‚úÖ Dica: se algo n√£o abrir, limpe o cache do navegador e recarregue.";
      }

      // notif schedule
      scheduleDailyNotifs();
    }

    function init(){
      wireNav();
      wireAvatarInput();
      wirePratoInputs();

      // decide entrada
      const isGuest = !!localStorage.getItem(KEY_GUEST);
      if(isGuest){
        setAuthBadge("Modo: Local");
        showNav(true);
        openView("viewCadastro");
      }else{
        showNav(false);
        openView("viewWelcome");
      }

      initFirebaseIfPossible();
      refreshAllUI();
    }
// restaura a √∫ltima aba quando o usu√°rio volta
window.addEventListener("load", () => {
  const last = localStorage.getItem("lastView");
  if (last) showOnly(last);
});
    init();
  </script>
</body>
</html>
