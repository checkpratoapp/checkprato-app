<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CheckPrato ‚Ä¢ Elite</title>

  <meta name="theme-color" content="#0a1320"/>
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" sizes="192x192" href="./icon-192.png">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <style>
    :root{
      --bg:#07121f;
      --bg2:#0b2033;
      --card:rgba(255,255,255,.04);
      --card2:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.08);
      --txt:#eaf2ff;
      --muted:rgba(234,242,255,.72);
      --green:#21e6b6;
      --green2:#17caa0;
      --orange:#f6b23a;
      --shadow:0 20px 60px rgba(0,0,0,.45);
      --r:22px;
      --max:560px;

      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.03);
      --stroke3d: rgba(255,255,255,.10);
      --shadow3d: 0 24px 70px rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    html, body{
      height:100%;
      margin:0;
      padding:0;
      background: var(--bg);
      color: var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow-x:hidden;
    }
    body{
      padding-bottom: calc(92px + env(safe-area-inset-bottom));
    }
    a{ color: var(--green); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .wrap{ max-width: var(--max); margin: 0 auto; padding: 16px 14px 24px; }

    .topbar{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:6px;
      margin-bottom: 14px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(33,230,182,.35), rgba(33,230,182,.05));
      border:1px solid rgba(33,230,182,.35);
      display:flex;align-items:center;justify-content:center;
      font-weight:1000;
      color:var(--green);
      box-shadow: var(--shadow);
      flex:0 0 auto;
      overflow:hidden;
    }
    .brand{
      display:flex;flex-direction:column;gap:2px;
      min-width: 0;
      flex: 1 1 auto;
    }
    .brand small{color:var(--muted); letter-spacing:.08em; font-weight:900}
    .brand b{font-size:18px}

    .pill{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--stroke);
      color:var(--muted);
      font-weight:800;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .pill .dot{
      width:10px;height:10px;border-radius:99px;background:var(--green);
      box-shadow: 0 0 0 6px rgba(33,230,182,.12);
    }

    .h1{
      font-size:34px;
      margin:12px 2px 14px;
      letter-spacing:.02em;
      color:var(--green);
      font-weight: 1000;
      line-height: 1.05;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .hint{ color: var(--muted); font-weight: 650; line-height: 1.35; }
    .muted{ opacity:.85; }

    .row{display:flex; gap:12px; flex-wrap:wrap}
    .col{flex:1 1 140px; min-width: 140px}

    .label{
      margin: 12px 2px 6px;
      color: rgba(234,242,255,.65);
      font-weight: 950;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-size: 12px;
    }

    input, select, textarea{
      width:100%;
      padding:14px 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      outline: none;
      font-size: 15px;
    }
    textarea{ min-height: 90px; resize: vertical; }
    input::placeholder{color: rgba(234,242,255,.35)}
    select{appearance:none}

    .btn{
      width:100%;
      padding: 16px 16px;
      border-radius: 18px;
      border: 0;
      cursor: pointer;
      font-weight: 950;
      font-size: 16px;
      letter-spacing: .02em;
      background: linear-gradient(135deg, var(--green), var(--green2));
      color:#042019;
      box-shadow: 0 18px 45px rgba(33,230,182,.18);
      margin-top: 14px;
    }
    .btnSecondary{
      width:100%;
      padding: 14px 16px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      cursor: pointer;
      font-weight: 900;
      font-size: 15px;
      background: rgba(255,255,255,.05);
      color: var(--txt);
      margin-top: 10px;
    }

    .status{
      margin-top: 10px;
      font-weight: 800;
      color: rgba(234,242,255,.86);
    }

    /* chips */
    .chips{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;}
    .chip{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-weight: 900;
      cursor: pointer;
      user-select: none;
    }
    .chip.on{
      border-color: rgba(33,230,182,.45);
      background: rgba(33,230,182,.12);
      color: var(--txt);
      box-shadow: 0 0 0 6px rgba(33,230,182,.08);
    }

    /* screens */
    .screen{
      display:none;
      margin-top: 8px;
      width: 100%;
      background: var(--bg);
      padding-bottom: calc(140px + env(safe-area-inset-bottom));
    }
    .screen.active{ display:block; }

    /* nav */
    .nav{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: #07121f;
      border-top: 1px solid rgba(255,255,255,.08);
      z-index: 1000;
    }
    .navInner{
      max-width: var(--max);
      margin: 0 auto;
      display:flex;
      gap:10px;
      overflow-x: auto;
      padding: 6px 6px;
      scrollbar-width: none;
    }
    .navInner::-webkit-scrollbar{ display:none; }
    .navBtn{
      flex:0 0 auto;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color: rgba(234,242,255,.6);
      font-weight: 950;
      padding: 12px 14px;
      border-radius: 999px;
      cursor:pointer;
      letter-spacing:.05em;
      white-space: nowrap;
    }
    .navBtn.active{
      background: rgba(33,230,182,.12);
      border-color: rgba(33,230,182,.35);
      color: var(--green);
      box-shadow: 0 0 0 6px rgba(33,230,182,.08);
    }

    /* plate */
    .plateBox{margin-top:12px;}
    .platePreview{
      width:100%;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
      overflow:hidden;
    }
    .platePreview img{ width:100%; display:block; }
    .miniRow{ display:flex; gap:10px; flex-wrap:wrap }
    .miniBtn{
      flex:1 1 160px;
      padding:14px 14px;
      border-radius:18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--txt);
      font-weight: 900;
      cursor:pointer;
    }

    /* Diet cards */
    .meal{
      display:flex; justify-content:space-between; gap:12px;
      padding: 16px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      margin-top: 12px;
    }
    .meal .title{
      font-weight: 950;
      color: var(--green);
      letter-spacing:.08em;
      text-transform: uppercase;
      font-size: 12px;
      margin-bottom: 6px;
    }
    .meal p{margin:0; color: rgba(234,242,255,.88); font-weight:750; line-height:1.35}
    .kcal{
      display:flex; align-items:center; justify-content:center;
      min-width: 92px;
      border-radius: 999px;
      border:1px solid rgba(33,230,182,.25);
      background: rgba(33,230,182,.08);
      color: var(--green);
      font-weight: 1000;
      padding: 10px 12px;
      text-align:center;
    }

    /* Treino */
    .dayCard{
      margin-top: 12px;
      padding: 14px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .dayTitle{
      display:flex; align-items:center; justify-content:space-between;
      font-weight: 1000;
      color: rgba(234,242,255,.92);
      margin-bottom: 10px;
      letter-spacing:.03em;
    }
    .exercise{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding: 12px 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      margin-top: 10px;
    }
    .ytBtn{
      border:0;
      border-radius: 999px;
      padding: 10px 12px;
      background: rgba(33,230,182,.10);
      border: 1px solid rgba(33,230,182,.25);
      color: var(--green);
      font-weight: 1000;
      cursor: pointer;
      min-width: 110px;
    }

    /* Parceiros */
    .partnerList{display:flex; flex-direction:column; gap:12px; margin-top:12px}
    .partnerRow{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px; border-radius:18px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
    }
    .partnerName{display:flex; flex-direction:column; gap:4px}
    .partnerName b{font-weight: 1000}

    /* Modal */
    .modalBack{
      display:none;
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      z-index: 2000;
      padding: 20px;
      overflow:auto;
    }
    .modal{
      max-width: 560px;
      margin: 40px auto;
      background: #0b1726;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      box-shadow: 0 25px 80px rgba(0,0,0,.55);
      padding: 16px;
    }
    .modal h3{ margin: 0 0 10px; }
    .modal .closeRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .xBtn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 900;
      cursor:pointer;
    }

    /* bot√£o topo */
    #btnTop{
      position:fixed;
      bottom:110px;
      right:18px;
      width:48px;
      height:48px;
      border-radius:50%;
      border:none;
      background:linear-gradient(135deg,#21e6b6,#17caa0);
      color:#042019;
      font-size:22px;
      font-weight:900;
      box-shadow:0 10px 25px rgba(0,0,0,.4);
      display:none;
      z-index:999;
      cursor:pointer;
    }

    /* ===== DASHBOARD 3D ===== */
    .pro3dWrap{ perspective: 1200px; }
    .pro3dCard{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border: 1px solid var(--stroke3d);
      border-radius: 26px;
      box-shadow: var(--shadow3d);
      transform: rotateX(7deg) rotateY(-6deg);
      transform-style: preserve-3d;
      overflow:hidden;
      position: relative;
    }
    .pro3dCard:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 260px at 20% 10%, rgba(33,230,182,.18), transparent 60%),
        radial-gradient(520px 260px at 80% 30%, rgba(246,178,58,.14), transparent 60%),
        radial-gradient(700px 340px at 40% 100%, rgba(33,230,182,.10), transparent 62%);
      pointer-events:none;
    }
    .proTop{ display:flex; align-items:center; justify-content:space-between; padding:16px 16px 0; position: relative; z-index: 1; }
    .proTitle{
      font-size: 26px;
      font-weight: 1000;
      letter-spacing: .02em;
      margin: 10px 16px 12px;
      color: rgba(234,242,255,.95);
      position: relative; z-index: 1;
    }
    .proGrid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 12px;
      padding: 0 16px 16px;
      position: relative; z-index: 1;
    }
    .proPanel{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
      padding: 14px;
      transform: translateZ(18px);
    }
    .proMuscle{
      position: relative;
      min-height: 240px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .proMuscle svg{
      width: 100%;
      max-width: 260px;
      opacity: .9;
      filter: drop-shadow(0 18px 40px rgba(0,0,0,.55));
    }
    .proLabels{ margin-top: 10px; display:grid; gap: 8px; }
    .proTag{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .proTag b{ color: rgba(234,242,255,.92); font-weight: 950; }
    .proTag small{ color: rgba(234,242,255,.62); font-weight: 800; }

    .proRingBox{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap: 10px; min-height: 240px; }
    .ring{ width: 180px; height: 180px; position: relative; transform: translateZ(26px); }
    .ring svg{ width: 100%; height: 100%; transform: rotate(-90deg); filter: drop-shadow(0 20px 40px rgba(0,0,0,.55)); }
    .ringCenter{
      position:absolute; inset: 0;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      text-align:center; gap: 2px;
    }
    .ringPct{ font-size: 44px; font-weight: 1000; color: #ffd38a; text-shadow: 0 10px 30px rgba(0,0,0,.45); }
    .ringSub{ color: rgba(234,242,255,.72); font-weight: 900; }

    .proStats{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      padding: 0 16px 16px;
      position: relative; z-index: 1;
    }
    .stat3d{
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      padding: 12px;
      transform: translateZ(14px);
    }
    .stat3d .num{ font-size: 24px; font-weight: 1000; color: rgba(234,242,255,.95); }
    .stat3d .lab{
      margin-top: 2px;
      color: rgba(234,242,255,.65);
      font-weight: 850;
      font-size: 12px;
      letter-spacing:.08em;
      text-transform: uppercase;
    }
    .proHint{ padding: 0 16px 16px; color: rgba(234,242,255,.65); font-weight: 800; position: relative; z-index: 1; }

    @media (min-width: 900px){
      .wrap{ max-width: 900px; }
      .proGrid{ grid-template-columns: 1fr 1fr; }
      .ring{ width: 210px; height: 210px; }
      .pro3dCard{ transform: rotateX(6deg) rotateY(-4deg); }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="logo">E</div>
      <div class="brand">
        <small>ELITE TERMINAL</small>
        <b>CheckPrato ‚Ä¢ Elite</b>
      </div>
      <div class="pill"><span class="dot"></span><span id="authTxt">Modo: Local</span></div>
    </div>

    <!-- BOAS VINDAS -->
    <section id="viewWelcome" class="screen active">
      <div class="h1">Bem-vindo üëã</div>
      <div class="card">
        <div class="hint">
          Crie seu perfil, acompanhe progresso, dieta, treino e analise seu prato.
          <br><br>
          <b>Dica:</b> voc√™ pode usar como convidado (sem Firebase) e tudo funciona.
        </div>
        <div class="row" style="margin-top:14px">
          <div class="col">
            <button class="btn" type="button" onclick="openAuthModal()">Entrar / Criar conta</button>
          </div>
          <div class="col">
            <button class="btnSecondary" type="button" onclick="enterGuest()">Entrar como convidado</button>
          </div>
        </div>
        <div id="welcomeStatus" class="status" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- DASHBOARD 3D -->
    <section id="viewProgresso" class="screen">
      <div class="h1">PROGRESSO</div>

      <div class="pro3dWrap">
        <div class="pro3dCard">

          <div class="proTop">
            <div class="pill"><span class="dot"></span><span id="proMode">Local</span></div>
            <div class="pill"><span class="dot"></span><span id="proWeek">Semana</span></div>
          </div>

          <div class="proTitle">Meta da Semana</div>

          <div class="proGrid">
            <div class="proPanel">
              <div class="label" style="margin-top:0">M√∫sculos foco</div>
              <div class="proMuscle">
                <svg viewBox="0 0 220 320" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <defs>
                    <linearGradient id="g" x1="30" y1="30" x2="190" y2="290">
                      <stop stop-color="rgba(33,230,182,.55)"/>
                      <stop offset="1" stop-color="rgba(33,230,182,.08)"/>
                    </linearGradient>
                  </defs>
                  <path d="M110 16c22 0 40 18 40 40 0 10-4 18-10 26 18 14 28 34 28 58 0 12-2 22-8 32 10 14 16 30 16 50 0 34-14 64-36 84-9 8-18 13-30 13s-21-5-30-13c-22-20-36-50-36-84 0-20 6-36 16-50-6-10-8-20-8-32 0-24 10-44 28-58-6-8-10-16-10-26 0-22 18-40 40-40Z"
                    stroke="url(#g)" stroke-width="4" fill="rgba(0,0,0,.10)"/>
                  <path d="M52 150h116" stroke="rgba(255,255,255,.10)" stroke-width="2"/>
                  <path d="M60 210h100" stroke="rgba(255,255,255,.10)" stroke-width="2"/>
                  <circle cx="110" cy="92" r="18" stroke="rgba(33,230,182,.55)" stroke-width="3"/>
                </svg>
              </div>

              <div class="proLabels">
                <div class="proTag"><b>Peito</b><small id="mPei">Foco</small></div>
                <div class="proTag"><b>Costas</b><small id="mCos">Foco</small></div>
                <div class="proTag"><b>Abd√¥men</b><small id="mAbd">Foco</small></div>
                <div class="proTag"><b>Pernas</b><small id="mPer">Foco</small></div>
              </div>
            </div>

            <div class="proPanel">
              <div class="label" style="margin-top:0">Progresso</div>

              <div class="proRingBox">
                <div class="ring">
                  <svg viewBox="0 0 120 120">
                    <circle cx="60" cy="60" r="48" stroke="rgba(255,255,255,.10)" stroke-width="10" fill="none"/>
                    <circle id="ringProg" cx="60" cy="60" r="48"
                      stroke="rgba(255,211,138,.95)" stroke-linecap="round"
                      stroke-width="10" fill="none"
                      stroke-dasharray="301.59" stroke-dashoffset="301.59"/>
                  </svg>
                  <div class="ringCenter">
                    <div class="ringPct" id="proPct">0%</div>
                    <div class="ringSub"><span id="proDone">0</span> / <span id="proGoal">7</span> dias</div>
                  </div>
                </div>

                <div class="proHint">
                  Sem perfei√ß√£o. S√≥ <b>consist√™ncia</b>.
                </div>

                <div class="miniRow" style="margin-top:4px">
                  <button class="miniBtn" type="button" onclick="addTreinoDone()">+1 dia treino</button>
                  <button class="miniBtn" type="button" onclick="resetProgresso()">Reset semana</button>
                </div>
              </div>
            </div>
          </div>

          <div class="proStats">
            <div class="stat3d">
              <div class="num" id="proKcal">0</div>
              <div class="lab">calorias</div>
              <button class="btnSecondary" type="button" onclick="addKcal()">+500</button>
            </div>
            <div class="stat3d">
              <div class="num" id="proKm">0</div>
              <div class="lab">km</div>
              <button class="btnSecondary" type="button" onclick="addKm()">+2 km</button>
            </div>
            <div class="stat3d">
              <div class="num"><span id="proDays">0</span>/<span id="proDaysGoal">7</span></div>
              <div class="lab">dias treino</div>
              <button class="btnSecondary" type="button" onclick="setGoalDaysPrompt()">Meta</button>
            </div>
          </div>

        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="label">Resumo</div>
        <div class="hint" id="proResumo">‚Äî</div>
      </div>
    </section>

    <!-- CADASTRO -->
    <section id="viewCadastro" class="screen">
      <div class="h1">CADASTRO</div>

      <div class="card">
        <div class="label">Foto do perfil</div>
        <div class="row" style="align-items:center">
          <div style="width:64px;height:64px;border-radius:18px;overflow:hidden;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.2)">
            <img id="avatarImg" alt="Foto" style="width:100%;height:100%;object-fit:cover;display:none"/>
            <div id="avatarFallback" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:1000;color:rgba(234,242,255,.7)">üë§</div>
          </div>
          <div style="flex:1">
            <button class="btnSecondary" type="button" onclick="pickAvatar()">Escolher foto</button>
            <input id="avatarFile" type="file" accept="image/*" style="display:none">
            <div class="hint" style="margin-top:6px">Salva no aparelho (modo local).</div>
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <div class="col">
            <div class="label">Nome</div>
            <input id="nome" placeholder="Ex: Jonatan" />
          </div>
          <div class="col">
            <div class="label">Email (opcional)</div>
            <input id="emailPerfil" inputmode="email" placeholder="Ex: voce@gmail.com" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="label">Peso (kg)</div>
            <input id="peso" inputmode="decimal" placeholder="Ex: 78.5" />
          </div>
          <div class="col">
            <div class="label">Altura (cm)</div>
            <input id="altura" inputmode="numeric" placeholder="Ex: 175" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="label">Objetivo</div>
            <select id="objetivo">
              <option value="">Selecione</option>
              <option>Emagrecer</option>
              <option>Ganhar massa</option>
              <option>Manter</option>
              <option>Performance</option>
            </select>
          </div>
          <div class="col">
            <div class="label">N√≠vel</div>
            <select id="nivel">
              <option value="">Selecione</option>
              <option>Iniciante</option>
              <option>Intermedi√°rio</option>
              <option>Avan√ßado</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="label">Condi√ß√£o</div>
            <select id="condicao">
              <option value="">Selecione</option>
              <option>Saud√°vel</option>
              <option>Hipertens√£o</option>
              <option>Diabetes</option>
              <option>Les√£o / Dor</option>
            </select>
          </div>
          <div class="col">
            <div class="label">Restri√ß√£o</div>
            <select id="restricao">
              <option value="">Selecione</option>
              <option>Nenhuma</option>
              <option>Sem lactose</option>
              <option>Sem gl√∫ten</option>
              <option>Vegetariano</option>
              <option>Vegano</option>
            </select>
          </div>
        </div>

        <div class="label">Esportes (pode marcar v√°rios)</div>
        <div id="chipsEsportes" class="chips"></div>

        <div style="margin-top:10px">
          <label style="display:flex; gap:10px; align-items:center; font-weight:900; color:rgba(234,242,255,.9)">
            <input id="termo" type="checkbox" style="width:22px; height:22px"/>
            Aceito o termo (conte√∫do informativo)
          </label>
          <div class="hint" style="margin-top:6px">As sugest√µes s√£o informativas e n√£o substituem profissional.</div>
        </div>

        <button class="btn" type="button" onclick="salvarCadastro()">SALVAR / ATUALIZAR</button>
        <button class="btnSecondary" type="button" onclick="limparCadastro()">LIMPAR</button>

        <div id="outCadastro" class="status" style="display:none"></div>
      </div>

      <!-- PRATO + IA DEMO -->
      <div class="card plateBox" style="margin-top:14px">
        <div class="label">An√°lise do prato (IA DEMO)</div>
        <div class="hint">
          Envia foto ‚Üí analisa ‚Üí voc√™ confirma. Anti-repeti√ß√£o ligado.
        </div>

        <div class="miniRow" style="margin-top:12px">
          <button class="miniBtn" type="button" id="btnCamera">Tirar foto</button>
          <button class="miniBtn" type="button" id="btnGaleria">Escolher da galeria</button>
        </div>

        <input id="fileCamera" type="file" accept="image/*" capture="environment" style="display:none">
        <input id="fileGaleria" type="file" accept="image/*" style="display:none">

        <div class="platePreview" id="platePreview" style="margin-top:12px; display:none">
          <img id="plateImg" alt="Prato"/>
        </div>

        <button class="btnSecondary" type="button" onclick="analisarPrato()">Analisar (demo)</button>
        <div id="plateResult" class="status" style="display:none"></div>

        <div id="plateConfirmBox" style="display:none; margin-top:10px">
          <div class="label">Confirma√ß√£o</div>
          <div class="hint">A sugest√£o √© uma estimativa. Se quiser, edite antes de confirmar:</div>
          <textarea id="plateEdit"></textarea>
          <button class="btn" type="button" onclick="confirmarPrato()">Confirmar</button>
          <button class="btnSecondary" type="button" onclick="refazerAnalise()">Refazer</button>
        </div>

        <div class="label" style="margin-top:14px">Hist√≥rico (local)</div>
        <div class="hint" id="plateHistoryTxt">‚Äî</div>
      </div>
    </section>

    <!-- DIETA -->
    <section id="viewDieta" class="screen">
      <div class="h1">DIETA</div>

      <div class="card">
        <div class="hint" id="dietaHint">
          Dieta variada (demo inteligente). Se n√£o gostar ou n√£o tiver alimento, clique em <b>Refazer</b>.
        </div>

        <button class="btn" type="button" onclick="gerarDieta()">GERAR DIETA</button>
        <button class="btnSecondary" type="button" onclick="refazerDieta()">REFAZER / TROCAR</button>

        <div id="dietaBox"></div>
      </div>
    </section>

    <!-- TREINO -->
    <section id="viewTreino" class="screen">
      <div class="h1">TREINO</div>

      <div class="card">
        <div class="hint" id="treinoHint">Treino semanal (auto + esportes). Cada exerc√≠cio tem bot√£o ‚ÄúYouTube‚Äù.</div>

        <div class="row" style="margin-top:10px">
          <div class="col">
            <div class="label">Tema</div>
            <select id="temaTreino"></select>
          </div>
          <div class="col">
            <div class="label">Intensidade</div>
            <select id="intTreino">
              <option>Leve</option>
              <option>Moderado</option>
              <option>Pesado</option>
            </select>
          </div>
        </div>

        <button class="btn" type="button" onclick="gerarTreino()">GERAR TREINO DA SEMANA</button>
        <button class="btnSecondary" type="button" onclick="limparTreino()">LIMPAR TREINO</button>

        <div id="outTreino" class="status" style="display:none"></div>
        <div id="treinoSemana"></div>
      </div>
    </section>

    <!-- PARCEIROS -->
    <section id="viewParceiros" class="screen">
      <div class="h1">PARCEIROS</div>

      <div class="card">
        <div class="hint">Sites oficiais (voc√™ troca pelos seus links depois).</div>

        <div class="partnerList">
          <div class="partnerRow">
            <div class="partnerName"><b>Growth Supplements</b><div class="muted">Whey, creatina e suplementos</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.gsuplementos.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Max Titanium</b><div class="muted">Nutri√ß√£o esportiva</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.maxtitanium.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Nike</b><div class="muted">T√™nis e roupas</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.nike.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Adidas</b><div class="muted">Performance e lifestyle</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.adidas.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Mercado Livre</b><div class="muted">Acess√≥rios e suplementos</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://www.mercadolivre.com.br')">Abrir</button>
          </div>
          <div class="partnerRow">
            <div class="partnerName"><b>Shopee</b><div class="muted">Produtos fitness acess√≠veis</div></div>
            <button class="btnSecondary" type="button" onclick="abrirLink('https://shopee.com.br')">Abrir</button>
          </div>
        </div>
      </div>
    </section>

    <!-- CONVITES (GAMIFICA√á√ÉO) -->
    <section id="viewConvites" class="screen">
      <div class="h1">CONVITES</div>

      <div class="card">
        <div class="hint">
          Convide amigos e some <b>pontos</b> (demo). A ideia aqui √© gamificar:
          <b>ranking</b>, <b>badges</b> e desafios.
        </div>

        <div style="margin-top:12px" class="card">
          <div class="label">Seu c√≥digo</div>
          <div id="myCode" style="font-weight:1000; font-size:18px">‚Äî</div>

          <div class="label" style="margin-top:12px">Seu link</div>
          <div id="myLink" class="muted" style="word-break:break-all">‚Äî</div>

          <div class="label" style="margin-top:12px">Pontos (demo)</div>
          <div id="balTxt" style="font-weight:1000; font-size:18px">0 pts</div>
          <div id="progressTxt" class="muted" style="margin-top:6px"></div>

          <div class="miniRow" style="margin-top:12px">
            <button class="miniBtn" type="button" onclick="copyInviteLink()">Copiar link</button>
            <button class="miniBtn" type="button" onclick="shareInvite()">Compartilhar</button>
          </div>

          <div class="miniRow" style="margin-top:10px">
            <button class="miniBtn" type="button" onclick="setBalance(getBalance()+10)">+10 pts (teste)</button>
            <button class="miniBtn" type="button" onclick="setBalance(0)">Zerar</button>
          </div>

          <button id="btnBonus" class="btnSecondary" type="button" onclick="resgatarBonus()">Resgatar badge (demo)</button>
          <div id="saqueMsg" class="status" style="display:none"></div>
        </div>
      </div>
    </section>

    <!-- SA√öDE -->
    <section id="viewSaude" class="screen">
      <div class="h1">SA√öDE</div>

      <div class="card">
        <div class="hint">
          Conte√∫do educativo. N√£o substitui m√©dico. Em caso de sintomas ou d√∫vidas, procure um profissional.
        </div>

        <div class="meal" style="margin-top:14px">
          <div>
            <div class="title">Anabolizantes: aten√ß√£o</div>
            <p>Podem causar efeitos no cora√ß√£o, press√£o, colesterol, f√≠gado, humor e horm√¥nios. N√£o use sem acompanhamento.</p>
          </div>
        </div>

        <div class="meal">
          <div>
            <div class="title">Sinais de alerta</div>
            <p>Dor no peito, falta de ar, palpita√ß√£o, desmaio, incha√ßo, pele/olhos amarelados, urina escura: pare e procure atendimento.</p>
          </div>
        </div>

        <div class="meal">
          <div>
            <div class="title">Cuidados gerais</div>
            <p>Sono 7‚Äì9h, √°gua, fibras, treino com progress√£o e descanso. O b√°sico bem feito muda tudo.</p>
          </div>
        </div>

        <button class="btnSecondary" type="button" onclick="abrirLink('https://bvsms.saude.gov.br/')">Ler mais (Fontes)</button>
      </div>
    </section>

    <!-- PERFIL -->
    <section id="viewPerfil" class="screen">
      <div class="h1">PERFIL</div>

      <div class="card">
        <div class="hint">Status da conta e dados locais.</div>
        <div id="perfilBox" class="status" style="margin-top:12px">‚Äî</div>

        <button class="btnSecondary" type="button" onclick="logoutFirebase()">Sair (se logado)</button>
        <button class="btnSecondary" type="button" onclick="sair()">Voltar ao in√≠cio</button>
      </div>
    </section>
  </div>

  <!-- NAV (SEM PREMIUM) -->
  <div class="nav" id="navBar">
    <div class="navInner">
      <button class="navBtn" data-view="viewProgresso" type="button">PROGRESSO</button>
      <button class="navBtn active" data-view="viewCadastro" type="button">CADASTRO</button>
      <button class="navBtn" data-view="viewDieta" type="button">DIETA</button>
      <button class="navBtn" data-view="viewTreino" type="button">TREINO</button>
      <button class="navBtn" data-view="viewParceiros" type="button">PARCEIROS</button>
      <button class="navBtn" data-view="viewConvites" type="button">CONVITES</button>
      <button class="navBtn" data-view="viewSaude" type="button">SA√öDE</button>
      <button class="navBtn" data-view="viewPerfil" type="button">PERFIL</button>
    </div>
  </div>

  <button id="btnTop" onclick="scrollToTop()">‚Üë</button>

  <!-- MODAL LOGIN (Firebase opcional) -->
  <div id="authModalBack" class="modalBack">
    <div class="modal">
      <div class="closeRow">
        <h3>Entrar / Criar conta</h3>
        <button class="xBtn" type="button" onclick="closeAuthModal()">X</button>
      </div>

      <div class="hint" style="margin-top:8px">
        <b>Firebase √© opcional.</b> Se n√£o configurar agora, use <b>Convidado</b> e tudo funciona local.
      </div>

      <button class="btn" type="button" onclick="loginGoogle()">Entrar com Google</button>

      <div class="label">Email</div>
      <input id="authEmail" inputmode="email" placeholder="email@exemplo.com">

      <div class="label">Senha</div>
      <input id="authPass" type="password" placeholder="********">

      <div class="miniRow" style="margin-top:12px">
        <button class="miniBtn" type="button" onclick="loginEmail()">Entrar</button>
        <button class="miniBtn" type="button" onclick="criarContaEmail()">Criar conta</button>
      </div>

      <button class="btnSecondary" type="button" onclick="enterGuest()">Entrar como convidado</button>
      <div id="authMsg" class="status" style="display:none"></div>
    </div>
  </div>

  <!-- Firebase CDN (compat) - opcional -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    /***********************
     * 0) PWA
     ***********************/
    if ("serviceWorker" in navigator){
      navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    }

    /***********************
     * 1) Helpers
     ***********************/
    const $ = (id)=>document.getElementById(id);

    function abrirLink(url){
      const w = window.open(url, "_blank", "noopener,noreferrer");
      if (w) w.opener = null;
    }
    window.abrirLink = abrirLink;

    function escapeHtml(s){
      return String(s).replace(/[&<>"]/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m]));
    }

    function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    /***********************
     * 2) Storage Keys
     ***********************/
    const KEY_PROFILE = "cp_profile_v2";
    const KEY_AVATAR  = "cp_avatar_v1";
    const KEY_GUEST   = "cp_guest_v1";

    const KEY_PLATE_LAST = "cp_plate_last_v1";
    const KEY_PLATE_HASH = "cp_plate_hash_v1";
    const KEY_PLATE_HISTORY = "cp_plate_history_v1";

    const KEY_DIETA   = "cp_dieta_v2";
    const KEY_TREINO  = "cp_treino_v2";

    const KEY_INV_CODE = "cp_inv_code_v1";
    const KEY_BAL = "cp_inv_points_v1";

    const KEY_DASH = "cp_dash_v1"; // kcal, km, done, goal, weekStart

    function safeJSON(key){
      try{ return JSON.parse(localStorage.getItem(key) || "null"); }catch{ return null; }
    }

    /***********************
     * 3) Firebase (OPCIONAL)
     ***********************/
    const FIREBASE_CONFIG = {
      // Cole aqui seu firebaseConfig se quiser:
      // apiKey: "....",
      // authDomain: "....firebaseapp.com",
      // projectId: "....",
      // storageBucket: "....appspot.com",
      // messagingSenderId: "....",
      // appId: "...."
    };

    let firebaseEnabled = false;
    let auth = null;
    let db = null;
    let currentUser = null;

    function setAuthBadge(txt){
      const el = $("authTxt");
      if(el) el.textContent = txt;
      const mode = $("proMode");
      if(mode) mode.textContent = txt.includes("Logado") ? "Logado" : "Local";
    }

    function initFirebaseIfPossible(){
      try{
        const hasKeys = FIREBASE_CONFIG && FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.projectId;
        if(!hasKeys) return;

        firebase.initializeApp(FIREBASE_CONFIG);
        auth = firebase.auth();
        db = firebase.firestore();
        firebaseEnabled = true;

        auth.onAuthStateChanged(async (user)=>{
          currentUser = user || null;
          if(currentUser){
            localStorage.removeItem(KEY_GUEST);
            setAuthBadge(`Logado`);
            closeAuthModal();
            showNav(true);
            showOnly("viewCadastro");
            await syncFromCloud();
            refreshAllUI();
          }else{
            if(!localStorage.getItem(KEY_GUEST)){
              setAuthBadge("Modo: Local");
              showNav(false);
              showOnly("viewWelcome");
            }
          }
        });
      }catch(e){
        console.log("Firebase init error:", e);
      }
    }

    async function syncFromCloud(){
      if(!firebaseEnabled || !db || !currentUser) return;
      try{
        const ref = db.collection("users").doc(currentUser.uid);
        const snap = await ref.get();
        if(snap.exists){
          const data = snap.data() || {};
          if(data.profile) localStorage.setItem(KEY_PROFILE, JSON.stringify(data.profile));
          if(data.avatar) localStorage.setItem(KEY_AVATAR, String(data.avatar));
          if(data.dash) localStorage.setItem(KEY_DASH, JSON.stringify(data.dash));
          if(data.dieta) localStorage.setItem(KEY_DIETA, JSON.stringify(data.dieta));
          if(data.treino) localStorage.setItem(KEY_TREINO, JSON.stringify(data.treino));
        }else{
          await ref.set({ createdAt: Date.now() }, { merge:true });
        }
      }catch(e){
        console.log("syncFromCloud error:", e);
      }
    }

    async function pushToCloud(){
      if(!firebaseEnabled || !db || !currentUser) return;
      try{
        const ref = db.collection("users").doc(currentUser.uid);
        const payload = {
          updatedAt: Date.now(),
          profile: safeJSON(KEY_PROFILE),
          avatar: localStorage.getItem(KEY_AVATAR) || "",
          dash: safeJSON(KEY_DASH),
          dieta: safeJSON(KEY_DIETA),
          treino: safeJSON(KEY_TREINO),
        };
        await ref.set(payload, { merge:true });
      }catch(e){
        console.log("pushToCloud error:", e);
      }
    }

    /***********************
     * 4) Auth UI
     ***********************/
    function openAuthModal(){
      $("authModalBack").style.display = "block";
      const msg = $("authMsg");
      if(msg) msg.style.display="none";
    }
    window.openAuthModal = openAuthModal;

    function closeAuthModal(){
      $("authModalBack").style.display = "none";
    }
    window.closeAuthModal = closeAuthModal;

    function setAuthMsg(txt){
      const el = $("authMsg");
      if(!el) return;
      el.textContent = txt;
      el.style.display = "block";
    }

    function enterGuest(){
      localStorage.setItem(KEY_GUEST, "1");
      setAuthBadge("Modo: Local");
      closeAuthModal();
      showNav(true);
      showOnly("viewCadastro");
      refreshAllUI();
    }
    window.enterGuest = enterGuest;

    async function loginGoogle(){
      if(!firebaseEnabled || !auth){
        openAuthModal();
        setAuthMsg("Firebase n√£o est√° configurado. Use Convidado por enquanto.");
        return;
      }
      try{
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithRedirect(provider);
      }catch(e){
        setAuthMsg("Erro no Google: " + (e?.message || e));
      }
    }
    window.loginGoogle = loginGoogle;

    async function loginEmail(){
      if(!firebaseEnabled || !auth){
        openAuthModal();
        setAuthMsg("Firebase n√£o est√° configurado. Use Convidado por enquanto.");
        return;
      }
      const email = ($("authEmail").value || "").trim();
      const pass  = ($("authPass").value || "").trim();
      try{
        await auth.signInWithEmailAndPassword(email, pass);
      }catch(e){
        setAuthMsg("Erro: " + (e?.message || e));
      }
    }
    window.loginEmail = loginEmail;

    async function criarContaEmail(){
      if(!firebaseEnabled || !auth){
        openAuthModal();
        setAuthMsg("Firebase n√£o est√° configurado. Use Convidado por enquanto.");
        return;
      }
      const email = ($("authEmail").value || "").trim();
      const pass  = ($("authPass").value || "").trim();
      try{
        await auth.createUserWithEmailAndPassword(email, pass);
      }catch(e){
        setAuthMsg("Erro: " + (e?.message || e));
      }
    }
    window.criarContaEmail = criarContaEmail;

    async function logoutFirebase(){
      try{
        if(firebaseEnabled && auth) await auth.signOut();
        localStorage.removeItem(KEY_GUEST);
        setAuthBadge("Modo: Local");
        showNav(false);
        showOnly("viewWelcome");
        refreshAllUI();
      }catch(e){
        console.log(e);
      }
    }
    window.logoutFirebase = logoutFirebase;

    function sair(){
      showNav(false);
      showOnly("viewWelcome");
    }
    window.sair = sair;

    /***********************
     * 5) Navega√ß√£o
     ***********************/
    function showOnly(viewId){
      document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
      const el = document.getElementById(viewId);
      if(el) el.classList.add("active");
      updateNavActive(viewId);
      updateTopBtn();
    }

    function showNav(on){
      const nav = $("navBar");
      if(!nav) return;
      nav.style.display = on ? "block" : "none";
    }

    function updateNavActive(viewId){
      document.querySelectorAll(".navBtn").forEach(b=>b.classList.remove("active"));
      const btn = document.querySelector(`.navBtn[data-view="${viewId}"]`);
      if(btn) btn.classList.add("active");
    }

    function wireNav(){
      document.querySelectorAll(".navBtn").forEach(btn=>{
        btn.addEventListener("click", ()=> showOnly(btn.dataset.view));
      });
    }

    function scrollToTop(){
      window.scrollTo({ top:0, behavior:"smooth" });
    }
    window.scrollToTop = scrollToTop;

    function updateTopBtn(){
      const btn = $("btnTop");
      if(!btn) return;
      btn.style.display = (window.scrollY > 200) ? "block" : "none";
    }
    window.addEventListener("scroll", updateTopBtn, { passive:true });

    /***********************
     * 6) Cadastro + Avatar
     ***********************/
    const ESPORTES = [
      "Muscula√ß√£o","Calistenia","Funcional","HIIT",
      "Corrida","Caminhada","Ciclismo","Nata√ß√£o",
      "Yoga","Pilates","Alongamento/Mobilidade",
      "Futebol","Basquete","V√¥lei","Handebol",
      "Boxe","Muay Thai","Jiu-jitsu",
      "Crossfit","T√™nis","Beach Tennis",
      "Skate","Trilha","Escalada"
    ];
    let selectedSports = new Set();

    function buildSportsChips(){
      const box = $("chipsEsportes");
      if(!box) return;
      box.innerHTML = "";
      ESPORTES.forEach(name=>{
        const div = document.createElement("div");
        div.className = "chip";
        div.textContent = name;
        div.addEventListener("click", ()=>{
          if(selectedSports.has(name)) selectedSports.delete(name);
          else selectedSports.add(name);
          div.classList.toggle("on");
          syncTemaTreinoOptions(); // reflete no treino
        });
        box.appendChild(div);
      });

      const p = safeJSON(KEY_PROFILE);
      if(p && Array.isArray(p.esportes)){
        selectedSports = new Set(p.esportes);
        [...box.querySelectorAll(".chip")].forEach(ch=>{
          if(selectedSports.has(ch.textContent)) ch.classList.add("on");
        });
      }
    }

    function applyProfileToUI(){
      const p = safeJSON(KEY_PROFILE);
      if(!p) return;
      if($("nome")) $("nome").value = p.nome || "";
      if($("emailPerfil")) $("emailPerfil").value = p.email || "";
      if($("peso")) $("peso").value = p.peso || "";
      if($("altura")) $("altura").value = p.altura || "";
      if($("objetivo")) $("objetivo").value = p.objetivo || "";
      if($("nivel")) $("nivel").value = p.nivel || "";
      if($("condicao")) $("condicao").value = p.condicao || "";
      if($("restricao")) $("restricao").value = p.restricao || "";
      if($("termo")) $("termo").checked = !!p.termoAceito; // ‚úÖ agora √© real, n√£o for√ßado
    }

    async function salvarCadastro(){
      const termoAceito = !!$("termo")?.checked;
      if(!termoAceito){
        alert("Marque 'Aceito o termo' para salvar.");
        return;
      }
      const perfil = {
        nome: ($("nome")?.value || "").trim(),
        email: ($("emailPerfil")?.value || "").trim(),
        peso: ($("peso")?.value || "").trim(),
        altura: ($("altura")?.value || "").trim(),
        objetivo: $("objetivo")?.value || "",
        nivel: $("nivel")?.value || "",
        condicao: $("condicao")?.value || "",
        restricao: $("restricao")?.value || "",
        esportes: Array.from(selectedSports),
        termoAceito,
        updatedAt: Date.now()
      };
      localStorage.setItem(KEY_PROFILE, JSON.stringify(perfil));

      const out = $("outCadastro");
      if(out){ out.style.display="block"; out.textContent="‚úÖ Cadastro salvo."; }

      updatePerfilBox();
      syncTemaTreinoOptions();
      await pushToCloud();
    }
    window.salvarCadastro = salvarCadastro;

    async function limparCadastro(){
      localStorage.removeItem(KEY_PROFILE);
      ["nome","emailPerfil","peso","altura"].forEach(id=>{ if($(id)) $(id).value=""; });
      ["objetivo","nivel","condicao","restricao"].forEach(id=>{ if($(id)) $(id).value=""; });
      if($("termo")) $("termo").checked = false;

      selectedSports = new Set();
      buildSportsChips();
      syncTemaTreinoOptions();

      const out = $("outCadastro");
      if(out){ out.style.display="block"; out.textContent="üßπ Cadastro limpo."; }

      updatePerfilBox();
      await pushToCloud();
    }
    window.limparCadastro = limparCadastro;

    function pickAvatar(){
      const f = $("avatarFile");
      if(f) f.click();
    }
    window.pickAvatar = pickAvatar;

    function applyAvatar(){
      const dataUrl = localStorage.getItem(KEY_AVATAR);
      const img = $("avatarImg");
      const fb = $("avatarFallback");
      if(img && fb){
        if(dataUrl){
          img.src = dataUrl;
          img.style.display = "block";
          fb.style.display = "none";
        }else{
          img.style.display = "none";
          fb.style.display = "flex";
        }
      }
    }

    function wireAvatarInput(){
      const f = $("avatarFile");
      if(!f) return;
      f.addEventListener("change", async ()=>{
        const file = f.files?.[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async ()=>{
          const dataUrl = String(reader.result || "");
          localStorage.setItem(KEY_AVATAR, dataUrl);
          applyAvatar();
          await pushToCloud();
        };
        reader.readAsDataURL(file);
      });
    }

    /***********************
     * 7) Prato (demo) + anti repeti√ß√£o
     ***********************/
    function wirePlateInput(){
      const btnCam = $("btnCamera");
      const btnGal = $("btnGaleria");
      const fc = $("fileCamera");
      const fg = $("fileGaleria");
      if(btnCam && fc) btnCam.addEventListener("click", ()=> fc.click());
      if(btnGal && fg) btnGal.addEventListener("click", ()=> fg.click());

      async function onFile(file){
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async ()=>{
          const dataUrl = String(reader.result || "");
          localStorage.setItem(KEY_PLATE_LAST, dataUrl);
          showPlate(dataUrl);
          await renderHistory();
        };
        reader.readAsDataURL(file);
      }

      if(fc) fc.addEventListener("change", ()=> onFile(fc.files?.[0]));
      if(fg) fg.addEventListener("change", ()=> onFile(fg.files?.[0]));
    }

    function showPlate(dataUrl){
      const box = $("platePreview");
      const img = $("plateImg");
      if(!box || !img) return;
      img.src = dataUrl;
      box.style.display = "block";
    }

    function loadLastPlate(){
      const dataUrl = localStorage.getItem(KEY_PLATE_LAST);
      if(dataUrl) showPlate(dataUrl);
    }

    async function hashString(str){
      try{
        const enc = new TextEncoder().encode(str);
        const buf = await crypto.subtle.digest("SHA-256", enc);
        const arr = Array.from(new Uint8Array(buf)).slice(0, 12);
        return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
      }catch{
        return "h" + (str.length) + "_" + str.slice(0,24);
      }
    }

    function getHistory(){
      try{ return JSON.parse(localStorage.getItem(KEY_PLATE_HISTORY) || "[]"); }catch{ return []; }
    }
    function setHistory(arr){
      localStorage.setItem(KEY_PLATE_HISTORY, JSON.stringify(arr.slice(-30)));
    }

    async function renderHistory(){
      const h = getHistory();
      const el = $("plateHistoryTxt");
      if(!el) return;
      if(!h.length){
        el.textContent = "Sem hist√≥rico ainda.";
        return;
      }
      el.textContent = `√öltimos pratos analisados: ${h.length} (anti-repeti√ß√£o ativo).`;
    }

    function profileOrDefault(){
      return safeJSON(KEY_PROFILE) || {
        objetivo:"Manter", nivel:"Iniciante", restricao:"Nenhuma", esportes:[]
      };
    }

    async function analisarPrato(){
      const dataUrl = localStorage.getItem(KEY_PLATE_LAST);
      const out = $("plateResult");
      const confirmBox = $("plateConfirmBox");
      const edit = $("plateEdit");
      if(!out || !confirmBox || !edit) return;

      if(!dataUrl){
        out.style.display="block";
        out.textContent = "Envie uma foto primeiro.";
        return;
      }

      const h = await hashString(dataUrl);
      const lastHash = localStorage.getItem(KEY_PLATE_HASH);
      const history = getHistory();

      if(lastHash && h === lastHash){
        out.style.display="block";
        out.textContent = "‚ö†Ô∏è Parece a mesma foto de antes. Troque a foto para analisar novamente.";
        confirmBox.style.display="none";
        return;
      }
      if(history.includes(h)){
        out.style.display="block";
        out.textContent = "‚ö†Ô∏è Esse prato j√° foi analisado antes (anti-repeti√ß√£o). Se for outro dia, tire outra foto.";
        confirmBox.style.display="none";
        return;
      }

      const p = profileOrDefault();
      const obj = (p.objetivo || "Manter").toLowerCase();

      const intros = [
        "Beleza ‚Äî vou te dar uma estimativa r√°pida.",
        "Vamos no modo pr√°tico: estimativa + sugest√£o.",
        "Fechado. Vou analisar como se fosse um dia normal."
      ];
      const tones = pickRandom(intros);

      let desc = "Prato com arroz, feij√£o, prote√≠na e salada (estimativa).";
      let kcal = 650;

      if(obj.includes("emag")){ desc = "Prato mais leve: prote√≠na magra + salada + carbo controlado (estimativa)."; kcal = 520; }
      if(obj.includes("massa")){ desc = "Prato refor√ßado: carbo + prote√≠na + legumes (estimativa)."; kcal = 820; }
      if(obj.includes("perform")){ desc = "Prato de performance: carbo bom + prote√≠na + micronutrientes (estimativa)."; kcal = 720; }

      out.style.display="block";
      out.textContent = `‚úÖ ${tones} Sugest√£o (DEMO): ${desc} ~${kcal} kcal. Confirme abaixo.`;

      edit.value = `${desc}\n\nEstimativa: ~${kcal} kcal\nSugest√£o: se bater fome mais tarde, priorize prote√≠na + fruta.`;
      confirmBox.style.display="block";

      localStorage.setItem(KEY_PLATE_HASH, h);
    }
    window.analisarPrato = analisarPrato;

    async function confirmarPrato(){
      const txt = ($("plateEdit")?.value || "").trim();
      if(!txt){
        alert("Escreva/edite a descri√ß√£o antes de confirmar.");
        return;
      }
      const h = localStorage.getItem(KEY_PLATE_HASH);
      if(!h) return;

      const history = getHistory();
      history.push(h);
      setHistory(history);

      $("plateConfirmBox").style.display = "none";
      $("plateResult").style.display = "block";
      $("plateResult").textContent = "‚úÖ Confirmado e salvo no hist√≥rico (local).";

      await renderHistory();
    }
    window.confirmarPrato = confirmarPrato;

    function refazerAnalise(){
      $("plateConfirmBox").style.display = "none";
      $("plateResult").style.display = "block";
      $("plateResult").textContent = "Ok. Troque a foto ou clique em 'Analisar' novamente.";
    }
    window.refazerAnalise = refazerAnalise;

    /***********************
     * 8) DIETA (menos rob√≥tica + muita varia√ß√£o)
     ***********************/
    const DIETA_INTROS = [
      "Vamos montar uma dieta realista pra sua rotina.",
      "Nada de terrorismo alimentar ‚Äî foco no que d√° pra manter.",
      "A ideia aqui √© consist√™ncia, n√£o perfei√ß√£o.",
      "Fechado: vou te passar um plano simples e eficiente."
    ];
    const DIETA_OUTROS = [
      "Se algum alimento n√£o tiver, troca por outro da mesma categoria (carbo/prote√≠na/gordura).",
      "Se sentir fome, ajusta por√ß√µes e prioriza prote√≠na e fibras.",
      "Se tiver treino pesado, aumenta um pouco o carbo nas refei√ß√µes perto do treino.",
      "Bebe √°gua e dorme bem ‚Äî isso muda o jogo."
    ];

    const FOODS = {
      proteina: ["frango", "carne magra", "peixe", "ovos", "atum", "patinho mo√≠do", "tofu", "gr√£o-de-bico", "lentilha"],
      carbo: ["arroz", "arroz integral", "batata-doce", "mandioca", "aveia", "p√£o integral", "macarr√£o integral", "banana"],
      fibra: ["salada", "br√≥colis", "legumes", "couve", "espinafre", "cenoura", "feij√£o", "gr√£o-de-bico"],
      gordura: ["azeite", "castanhas", "amendoim", "abacate", "pasta de amendoim", "sementes (chia/linha√ßa)"],
      snack: ["iogurte", "fruta", "mix de castanhas", "barra de prote√≠na", "tapioca", "queijo", "whey", "crepioca"]
    };

    function applyRestriction(text, restricao){
      const r = (restricao || "Nenhuma").toLowerCase();
      let t = text;

      const swaps = [
        { from: /iogurte/gi, to: r.includes("lactose") ? "iogurte sem lactose" : "iogurte" },
        { from: /queijo/gi, to: r.includes("lactose") ? "queijo sem lactose" : "queijo" },
        { from: /p√£o integral/gi, to: r.includes("gl√∫ten") ? "p√£o sem gl√∫ten" : "p√£o integral" },
        { from: /macarr√£o integral/gi, to: r.includes("gl√∫ten") ? "macarr√£o sem gl√∫ten" : "macarr√£o integral" },
        { from: /frango|carne magra|peixe|atum|ovos|patinho mo√≠do/gi,
          to: (r.includes("vegano") ? "tofu" : (r.includes("vegetar") ? "ovos" : "$&")) }
      ];

      swaps.forEach(s=>{
        t = t.replace(s.from, s.to);
      });

      if(r.includes("vegano")){
        t = t.replace(/ovos/gi, "tofu");
        t = t.replace(/whey/gi, "prote√≠na vegetal");
        t = t.replace(/iogurte/gi, "iogurte vegetal");
        t = t.replace(/queijo/gi, "queijo vegetal");
        t = t.replace(/atum/gi, "gr√£o-de-bico");
      }

      return t;
    }

    function estimateKcal(objetivo, nivel){
      const obj = (objetivo||"Manter").toLowerCase();
      const nv = (nivel||"Iniciante").toLowerCase();

      let base = 2000;
      if(obj.includes("emag")) base = 1700;
      if(obj.includes("massa")) base = 2500;
      if(obj.includes("perform")) base = 2200;

      if(nv.includes("inic")) base -= 100;
      if(nv.includes("avan√ß")) base += 150;

      return clamp(base, 1400, 3200);
    }

    function buildMealPlan(p){
      const obj = p.objetivo || "Manter";
      const niv = p.nivel || "Iniciante";
      const restr = p.restricao || "Nenhuma";

      const kcalDia = estimateKcal(obj, niv);

      // Estrat√©gias por objetivo (sem ‚Äúrob√¥‚Äù):
      const style = obj.toLowerCase().includes("emag")
        ? { meals: 4, proteinBoost: 1, carbBoost: 0 }
        : obj.toLowerCase().includes("massa")
          ? { meals: 5, proteinBoost: 2, carbBoost: 2 }
          : obj.toLowerCase().includes("perform")
            ? { meals: 5, proteinBoost: 2, carbBoost: 1 }
            : { meals: 4, proteinBoost: 1, carbBoost: 1 };

      const mealNamesByCount = style.meals === 5
        ? ["Caf√© da manh√£","Lanche","Almo√ßo","Lanche","Jantar"]
        : ["Caf√© da manh√£","Almo√ßo","Lanche","Jantar"];

      const mk = (t, d, k)=>({ t, d, k });

      // Monta refei√ß√µes com pools e varia√ß√£o:
      const pickP = ()=>pickRandom(FOODS.proteina);
      const pickC = ()=>pickRandom(FOODS.carbo);
      const pickF = ()=>pickRandom(FOODS.fibra);
      const pickG = ()=>pickRandom(FOODS.gordura);
      const pickS = ()=>pickRandom(FOODS.snack);

      const meals = [];

      for(let i=0;i<mealNamesByCount.length;i++){
        const name = mealNamesByCount[i];
        let desc = "";
        if(name === "Caf√© da manh√£"){
          desc = `${pickS()} + ${pickC()} + ${pickP()}`;
          if(style.carbBoost>0 && Math.random()<0.5) desc += ` + ${pickC()}`;
        } else if(name === "Almo√ßo"){
          desc = `${pickP()} + ${pickC()} + ${pickF()}`;
          if(style.proteinBoost>1 && Math.random()<0.45) desc += ` + ${pickP()}`;
        } else if(name === "Jantar"){
          desc = `${pickP()} + ${pickF()}`;
          if(style.carbBoost>0 && Math.random()<0.45) desc += ` + ${pickC()}`;
        } else { // lanches
          desc = `${pickS()} + ${pickG()}`;
          if(style.proteinBoost>1 && Math.random()<0.4) desc += ` + ${pickP()}`;
        }

        desc = applyRestriction(desc, restr);

        // kcal por refei√ß√£o (simples, mas consistente)
        const kcal = Math.round(kcalDia / mealNamesByCount.length * (0.9 + Math.random()*0.25));
        meals.push(mk(name, desc, kcal));
      }

      // Ajuste final para bater mais perto do total
      const sum = meals.reduce((a,m)=>a+m.k,0);
      const diff = kcalDia - sum;
      if(meals.length){
        meals[meals.length-1].k = Math.max(120, meals[meals.length-1].k + diff);
      }

      return { meals, kcalDia, note: pickRandom(DIETA_OUTROS), intro: pickRandom(DIETA_INTROS) };
    }

    function renderDieta(plan){
      const box = $("dietaBox");
      if(!box) return;
      box.innerHTML = "";
      if(!plan){
        const s = document.createElement("div");
        s.className="status";
        s.textContent="Gere uma dieta para aparecer aqui.";
        box.appendChild(s);
        return;
      }

      const p = profileOrDefault();
      const head = document.createElement("div");
      head.className = "status";
      head.innerHTML = `<b>${escapeHtml(plan.intro)}</b><br>
        Objetivo: <b>${escapeHtml(p.objetivo||"‚Äî")}</b> ‚Ä¢ N√≠vel: <b>${escapeHtml(p.nivel||"‚Äî")}</b> ‚Ä¢ Restri√ß√£o: <b>${escapeHtml(p.restricao||"Nenhuma")}</b><br>
        Meta do dia (estimativa): <b>${plan.kcalDia} kcal</b><br>
        <span class="muted">${escapeHtml(plan.note)}</span>`;
      box.appendChild(head);

      plan.meals.forEach(m=>{
        const div = document.createElement("div");
        div.className="meal";
        div.innerHTML = `
          <div>
            <div class="title">${escapeHtml(m.t)}</div>
            <p>${escapeHtml(m.d)}</p>
          </div>
          <div class="kcal">${Number(m.k||0)}<br/>kcal</div>
        `;
        box.appendChild(div);
      });
    }

    function gerarDieta(){
      const p = profileOrDefault();
      const plan = buildMealPlan(p);
      localStorage.setItem(KEY_DIETA, JSON.stringify(plan));
      renderDieta(plan);
      pushToCloud();
    }
    window.gerarDieta = gerarDieta;

    function refazerDieta(){ gerarDieta(); }
    window.refazerDieta = refazerDieta;

    /***********************
     * 9) TREINO (muitos esportes + auto)
     ***********************/
    const THEMES = [
      "Auto (meus esportes)",
      "Muscula√ß√£o (Full body)",
      "Muscula√ß√£o (ABC)",
      "Calistenia",
      "Funcional",
      "HIIT",
      "Corrida",
      "Ciclismo",
      "Nata√ß√£o",
      "Yoga",
      "Pilates",
      "Boxe",
      "Muay Thai",
      "Jiu-jitsu",
      "Futebol",
      "Basquete",
      "V√¥lei",
      "Alongamento/Mobilidade"
    ];

    function syncTemaTreinoOptions(){
      const sel = $("temaTreino");
      if(!sel) return;
      const current = sel.value || "Auto (meus esportes)";
      sel.innerHTML = "";
      THEMES.forEach(t=>{
        const opt = document.createElement("option");
        opt.textContent = t;
        sel.appendChild(opt);
      });

      // Se usu√°rio marcou esportes, adiciona um ‚Äúpreferidos‚Äù r√°pido:
      const pref = Array.from(selectedSports);
      if(pref.length){
        const opt = document.createElement("option");
        opt.textContent = "Preferidos (" + pref.slice(0,3).join(", ") + (pref.length>3 ? "‚Ä¶" : "") + ")";
        sel.insertBefore(opt, sel.children[1]);
      }

      // tenta manter sele√ß√£o
      const exists = Array.from(sel.options).some(o=>o.value===current);
      sel.value = exists ? current : "Auto (meus esportes)";
    }

    function getLevel(){
      const p = profileOrDefault();
      const n = (p.nivel||"Iniciante").toLowerCase();
      if(n.includes("avan√ß")) return "Avan√ßado";
      if(n.includes("inter")) return "Intermedi√°rio";
      return "Iniciante";
    }

    function scheme(intensidade, level){
      const i = (intensidade||"Moderado").toLowerCase();
      const l = (level||"Iniciante").toLowerCase();

      if(i.includes("leve")){
        return l.includes("avan√ß") ? "3 s√©ries ‚Ä¢ 10‚Äì12 reps ‚Ä¢ descanso 60‚Äì90s" : "2‚Äì3 s√©ries ‚Ä¢ 10‚Äì12 reps ‚Ä¢ descanso 60‚Äì90s";
      }
      if(i.includes("pesado")){
        return l.includes("inic") ? "3 s√©ries ‚Ä¢ 8‚Äì10 reps ‚Ä¢ descanso 90s" : "4 s√©ries ‚Ä¢ 6‚Äì10 reps ‚Ä¢ descanso 90‚Äì120s";
      }
      return l.includes("avan√ß") ? "4 s√©ries ‚Ä¢ 8‚Äì12 reps ‚Ä¢ descanso 60‚Äì90s" : "3 s√©ries ‚Ä¢ 8‚Äì12 reps ‚Ä¢ descanso 60‚Äì90s";
    }

    function makeYouTube(ex){
      return `https://www.youtube.com/results?search_query=${encodeURIComponent(ex+" como fazer")}`;
    }

    function buildStrengthPlan(type, intensidade, level){
      const sch = scheme(intensidade, level);

      const full = [
        ["Segunda", ["Agachamento", "Supino reto", "Remada", "Desenvolvimento (ombro)", "Abdominal prancha"]],
        ["Quarta", ["Levantamento terra (leve)", "Puxada na barra/lat", "Afundo", "Tr√≠ceps", "Rosca b√≠ceps"]],
        ["Sexta", ["Leg press", "Supino inclinado", "Remada unilateral", "Eleva√ß√£o lateral", "Panturrilha"]]
      ];

      const abc = [
        ["Segunda (A)", ["Peito", "Supino reto", "Supino inclinado", "Crucifixo", "Tr√≠ceps", "Tr√≠ceps corda"]],
        ["Quarta (B)", ["Costas", "Puxada", "Remada", "Pulldown", "B√≠ceps", "Rosca direta"]],
        ["Sexta (C)", ["Pernas", "Agachamento", "Leg press", "Stiff", "Panturrilha", "Abd√¥men"]]
      ];

      const dias = (type.includes("ABC") ? abc : full).map(d=>[d[0], d[1].map(ex=>`${ex} ‚Ä¢ ${sch}`)]);
      return { tema: type, intensidade, level, dias };
    }

    function buildCardioPlan(tema, intensidade, level){
      const i = (intensidade||"Moderado").toLowerCase();
      const l = (level||"Iniciante").toLowerCase();

      const baseTime =
        i.includes("leve") ? 25 :
        i.includes("pesado") ? 45 : 35;

      const extra = l.includes("avan√ß") ? 10 : l.includes("inter") ? 5 : 0;

      const t = baseTime + extra;

      const dias = [
        ["Segunda", [`${tema} leve ${t-10} min ‚Ä¢ respira√ß√£o controlada`]],
        ["Quarta", [i.includes("pesado") ? `${tema} intervalado ${t} min ‚Ä¢ 1 min forte / 1 min leve` : `${tema} moderado ${t} min ‚Ä¢ ritmo constante`]],
        ["Sexta", [`${tema} progressivo ${t} min ‚Ä¢ come√ßa leve e termina moderado`]],
        ["S√°bado", [`Mobilidade + alongamento 15 min ‚Ä¢ recupera√ß√£o`]]
      ];

      return { tema, intensidade, level, dias };
    }

    function buildLutaPlan(tema, intensidade, level){
      const i = (intensidade||"Moderado").toLowerCase();
      const l = (level||"Iniciante").toLowerCase();

      const rounds =
        i.includes("leve") ? 6 :
        i.includes("pesado") ? 10 : 8;

      const r = l.includes("avan√ß") ? rounds+2 : rounds;

      const dias = [
        ["Ter√ßa", [`Sombra 10 min ‚Ä¢ base`, `T√©cnica 25 min ‚Ä¢ combina√ß√µes`, `Rounds ${r}x2min ‚Ä¢ leve/moderado`]],
        ["Quinta", [`Aquecimento 10 min`, `T√©cnica 30 min`, `Condicionamento 12 min (core + explos√£o)`]],
        ["S√°bado", [`T√©cnica 20 min`, `Sparring leve (opcional)`, `Alongamento 10 min`]]
      ];
      return { tema, intensidade, level, dias };
    }

    function buildEsportePlan(tema, intensidade, level){
      const i = (intensidade||"Moderado").toLowerCase();
      const drill =
        tema === "Futebol" ? ["Passe e dom√≠nio", "Finaliza√ß√£o", "Arranque/Agilidade"] :
        tema === "Basquete" ? ["Drible", "Arremessos", "Defesa lateral"] :
        tema === "V√¥lei" ? ["Saque", "Recep√ß√£o", "Bloqueio"] :
        ["T√©cnica", "Agilidade", "Condicionamento"];

      const days = [
        ["Segunda", [`${drill[0]} 25 min`, `${drill[1]} 20 min`, `Condicionamento 12 min`]],
        ["Quarta", [`${drill[2]} 20 min`, `Jogo reduzido 20‚Äì30 min`]],
        ["Sexta", [i.includes("pesado") ? "Jogo/treino forte 45‚Äì60 min" : "Jogo/treino moderado 35‚Äì50 min"]],
        ["S√°bado", ["Alongamento/Mobilidade 15 min ‚Ä¢ recupera√ß√£o"]]
      ];
      return { tema, intensidade, level, dias: days };
    }

    function buildMindBodyPlan(tema, intensidade, level){
      const i = (intensidade||"Moderado").toLowerCase();
      const minutes =
        i.includes("leve") ? 20 :
        i.includes("pesado") ? 45 : 30;

      const days = [
        ["Segunda", [`${tema} ${minutes} min ‚Ä¢ foco em respira√ß√£o e postura`]],
        ["Quarta", [`${tema} ${minutes+5} min ‚Ä¢ mobilidade + core`]],
        ["Sexta", [`${tema} ${minutes} min ‚Ä¢ alongamento profundo`]],
        ["Domingo", ["Caminhada leve 20‚Äì30 min (opcional)"]]
      ];
      return { tema, intensidade, level, dias: days };
    }

    function renderTreino(plan){
      const box = $("treinoSemana");
      if(!box) return;
      box.innerHTML = "";

      if(!plan){
        const s = document.createElement("div");
        s.className="status";
        s.textContent="Gere um treino para aparecer aqui.";
        box.appendChild(s);
        return;
      }

      const head = document.createElement("div");
      head.className="status";
      head.innerHTML = `<b>Treino pronto.</b> Tema: <b>${escapeHtml(plan.tema)}</b> ‚Ä¢ Intensidade: <b>${escapeHtml(plan.intensidade)}</b> ‚Ä¢ N√≠vel: <b>${escapeHtml(plan.level)}</b>
      <br><span class="muted">Dica: se doer ‚Äúerrado‚Äù, ajuste e procure um profissional.</span>`;
      box.appendChild(head);

      plan.dias.forEach(d=>{
        const day = document.createElement("div");
        day.className="dayCard";
        day.innerHTML = `<div class="dayTitle"><span>${escapeHtml(d[0])}</span><span class="muted">${escapeHtml(plan.tema)}</span></div>`;
        (d[1]||[]).forEach(ex=>{
          const row = document.createElement("div");
          row.className="exercise";

          const left = document.createElement("div");
          left.innerHTML = `<b>${escapeHtml(ex)}</b>`;

          const btn = document.createElement("button");
          btn.className="ytBtn";
          btn.textContent="Ver t√©cnica";
          btn.addEventListener("click", ()=> abrirLink(makeYouTube(ex)));

          row.appendChild(left);
          row.appendChild(btn);
          day.appendChild(row);
        });
        box.appendChild(day);
      });
    }

    function decideTheme(rawTheme){
      const p = profileOrDefault();
      const marked = (Array.isArray(p.esportes) ? p.esportes : []);
      const theme = rawTheme || "Auto (meus esportes)";

      if(theme.startsWith("Preferidos") && marked.length) return pickRandom(marked);
      if(theme === "Auto (meus esportes)"){
        return marked.length ? pickRandom(marked) : "Muscula√ß√£o (Full body)";
      }
      return theme;
    }

    function gerarTreino(){
      const p = profileOrDefault();
      const raw = $("temaTreino")?.value || "Auto (meus esportes)";
      const tema = decideTheme(raw);
      const intensidade = $("intTreino")?.value || "Moderado";
      const level = getLevel();

      let plan;
      if(tema.startsWith("Muscula√ß√£o")){
        plan = buildStrengthPlan(tema, intensidade, level);
      } else if(["Corrida","Ciclismo","Nata√ß√£o","Caminhada"].includes(tema)){
        plan = buildCardioPlan(tema, intensidade, level);
      } else if(["Boxe","Muay Thai","Jiu-jitsu"].includes(tema)){
        plan = buildLutaPlan(tema, intensidade, level);
      } else if(["Futebol","Basquete","V√¥lei","Handebol","T√™nis","Beach Tennis"].includes(tema)){
        plan = buildEsportePlan(tema, intensidade, level);
      } else if(["Yoga","Pilates","Alongamento/Mobilidade"].includes(tema)){
        plan = buildMindBodyPlan(tema, intensidade, level);
      } else if(["Calistenia","Funcional","HIIT","Crossfit"].includes(tema)){
        // h√≠brido
        const days = [
          ["Segunda", ["Agachamento (peso do corpo) ‚Ä¢ 3x10", "Flex√£o ‚Ä¢ 3x8‚Äì12", "Remada/invertida ‚Ä¢ 3x8‚Äì12", "Prancha ‚Ä¢ 3x30‚Äì45s"]],
          ["Quarta", ["Circuito 20 min ‚Ä¢ 40s on / 20s off", "Burpee (adaptado) ‚Ä¢ 3x8‚Äì12", "Afundo ‚Ä¢ 3x10", "Abdominal ‚Ä¢ 3x12"]],
          ["Sexta", ["Pliometria leve ‚Ä¢ 10 min", "Flex√£o inclinada ‚Ä¢ 3x10", "Agachamento ‚Ä¢ 3x12", "Alongamento ‚Ä¢ 10 min"]],
          ["S√°bado", ["Caminhada leve 20‚Äì30 min (opcional)"]]
        ];
        plan = { tema, intensidade, level, dias };
      } else {
        // fallback
        plan = buildMindBodyPlan("Alongamento/Mobilidade", intensidade, level);
      }

      localStorage.setItem(KEY_TREINO, JSON.stringify(plan));
      renderTreino(plan);

      const out = $("outTreino");
      if(out){ out.style.display="block"; out.textContent = `‚úÖ Treino salvo: ${plan.tema} (${plan.intensidade}).`; }
      pushToCloud();
    }
    window.gerarTreino = gerarTreino;

    function limparTreino(){
      localStorage.removeItem(KEY_TREINO);
      if($("treinoSemana")) $("treinoSemana").innerHTML = "";
      const out = $("outTreino");
      if(out){ out.style.display="block"; out.textContent="üßπ Treino removido."; }
      pushToCloud();
    }
    window.limparTreino = limparTreino;

    /***********************
     * 10) Convites (pontos)
     ***********************/
    function getOrCreateInviteCode(){
      let code = localStorage.getItem(KEY_INV_CODE);
      if(code) return code;
      code = "ELITE-" + Math.random().toString(16).slice(2,8).toUpperCase();
      localStorage.setItem(KEY_INV_CODE, code);
      return code;
    }
    function getMyInviteLink(){
      const code = getOrCreateInviteCode();
      const url = new URL(location.href);
      url.searchParams.set("ref", code);
      return url.toString();
    }
    function getBalance(){ return Number(localStorage.getItem(KEY_BAL) || "0"); }
    function setBalance(v){
      localStorage.setItem(KEY_BAL, String(v));
      renderInviteUI();
    }
    window.getBalance = getBalance;
    window.setBalance = setBalance;

    async function copyInviteLink(){
      const link = getMyInviteLink();
      try{
        await navigator.clipboard.writeText(link);
        alert("‚úÖ Link copiado!");
      }catch{
        prompt("Copie o link:", link);
      }
    }
    window.copyInviteLink = copyInviteLink;

    function shareInvite(){
      const link = getMyInviteLink();
      const text = `Testa o CheckPrato Elite (gr√°tis): ${link}`;
      if(navigator.share){
        navigator.share({ title:"CheckPrato Elite", text, url: link }).catch(()=>{});
      }else{
        copyInviteLink();
      }
    }
    window.shareInvite = shareInvite;

    function renderInviteUI(){
      const code = getOrCreateInviteCode();
      const link = getMyInviteLink();
      const pts = getBalance();
      const falta = Math.max(0, 100 - pts);

      if($("myCode")) $("myCode").textContent = code;
      if($("myLink")) $("myLink").textContent = link;
      if($("balTxt")) $("balTxt").textContent = `${pts} pts`;

      if($("progressTxt")){
        $("progressTxt").textContent = pts >= 100
          ? "‚úÖ Voc√™ atingiu 100 pts! Pode resgatar uma badge (demo)."
          : `Faltam ${falta} pts para resgatar uma badge.`;
      }

      const btn = $("btnBonus");
      if(btn){
        btn.disabled = pts < 100;
        btn.style.opacity = pts < 100 ? .55 : 1;
      }
    }

    function resgatarBonus(){
      const pts = getBalance();
      const msg = $("saqueMsg");
      if(!msg) return;

      if(pts < 100){
        msg.style.display="block";
        msg.textContent = "Ainda n√£o atingiu 100 pts.";
        return;
      }

      setBalance(pts - 100);
      msg.style.display="block";
      msg.textContent = "üèÖ Badge resgatada (DEMO)! Depois a gente liga isso em um sistema real.";
    }
    window.resgatarBonus = resgatarBonus;

    /***********************
     * 11) Dashboard
     ***********************/
    function getWeekStart(){
      const now = new Date();
      const start = new Date(now);
      start.setHours(0,0,0,0);
      start.setDate(now.getDate() - ((now.getDay()+6)%7)); // segunda
      return start.getTime();
    }

    function getDash(){
      const d = safeJSON(KEY_DASH);
      const ws = getWeekStart();
      if(d && typeof d === "object"){
        // ‚úÖ reset autom√°tico quando muda a semana
        if(d.weekStart !== ws){
          return { kcal:0, km:0, done:0, goal: d.goal || 7, weekStart: ws };
        }
        return d;
      }
      return { kcal:0, km:0, done:0, goal:7, weekStart: ws };
    }
    function setDash(d){
      localStorage.setItem(KEY_DASH, JSON.stringify(d));
      renderDash();
      pushToCloud();
    }

    function weekLabel(ts){
      const dt = new Date(ts);
      const dd = String(dt.getDate()).padStart(2,"0");
      const mm = String(dt.getMonth()+1).padStart(2,"0");
      return `Semana ‚Ä¢ ${dd}/${mm}`;
    }

    function setProgressoUI({ kcal, km, doneDays, goalDays, weekStart }){
      $("proKcal").textContent = String(Math.round(kcal));
      $("proKm").textContent = String(Math.round(km));
      $("proDone").textContent = String(doneDays);
      $("proGoal").textContent = String(goalDays);
      $("proDays").textContent = String(doneDays);
      $("proDaysGoal").textContent = String(goalDays);
      $("proWeek").textContent = weekLabel(weekStart);

      const pct = goalDays > 0 ? Math.max(0, Math.min(100, Math.round((doneDays / goalDays) * 100))) : 0;
      $("proPct").textContent = pct + "%";

      const C = 301.59;
      const offset = C - (C * pct / 100);
      const ring = $("ringProg");
      ring.style.strokeDasharray = String(C);
      ring.style.strokeDashoffset = String(offset);

      const resumo = $("proResumo");
      if(resumo){
        resumo.innerHTML = `Voc√™ fez <b>${doneDays}</b> dias de treino, <b>${Math.round(km)} km</b> e <b>${Math.round(kcal)} kcal</b> na semana.`;
      }
    }

    function renderDash(){
      const d = getDash();
      setProgressoUI({ kcal:d.kcal, km:d.km, doneDays:d.done, goalDays:d.goal, weekStart:d.weekStart });
      updatePerfilBox();
    }

    function addKcal(){
      const d = getDash();
      d.kcal += 500;
      setDash(d);
    }
    window.addKcal = addKcal;

    function addKm(){
      const d = getDash();
      d.km += 2;
      setDash(d);
    }
    window.addKm = addKm;

    function addTreinoDone(){
      const d = getDash();
      d.done = Math.min(d.goal, d.done + 1);
      setDash(d);
    }
    window.addTreinoDone = addTreinoDone;

    function resetProgresso(){
      const d = getDash();
      d.kcal = 0; d.km = 0; d.done = 0;
      d.weekStart = getWeekStart();
      setDash(d);
    }
    window.resetProgresso = resetProgresso;

    function setGoalDaysPrompt(){
      const d = getDash();
      const v = prompt("Meta de dias de treino na semana (ex: 5, 6, 7):", String(d.goal));
      if(v === null) return;
      const n = clamp(parseInt(v,10) || d.goal, 1, 14);
      d.goal = n;
      if(d.done > d.goal) d.done = d.goal;
      setDash(d);
    }
    window.setGoalDaysPrompt = setGoalDaysPrompt;

    /***********************
     * 12) Perfil
     ***********************/
    function updatePerfilBox(){
      const p = safeJSON(KEY_PROFILE) || {};
      const dash = getDash();
      const mode = localStorage.getItem(KEY_GUEST) ? "Convidado (Local)" : (currentUser ? "Logado" : "Local");
      const sports = Array.isArray(p.esportes) && p.esportes.length ? p.esportes.join(", ") : "‚Äî";
      const termo = p.termoAceito ? "Aceito" : "N√£o aceito";
      const html = `
        <div><b>Modo:</b> ${escapeHtml(mode)}</div>
        <div><b>Nome:</b> ${escapeHtml(p.nome || "‚Äî")}</div>
        <div><b>Objetivo:</b> ${escapeHtml(p.objetivo || "‚Äî")}</div>
        <div><b>N√≠vel:</b> ${escapeHtml(p.nivel || "‚Äî")}</div>
        <div><b>Restri√ß√£o:</b> ${escapeHtml(p.restricao || "Nenhuma")}</div>
        <div><b>Esportes:</b> ${escapeHtml(sports)}</div>
        <div><b>Termo:</b> ${escapeHtml(termo)}</div>
        <div style="margin-top:8px"><b>Semana:</b> ${escapeHtml(weekLabel(dash.weekStart))}</div>
        <div><b>Calorias:</b> ${Math.round(dash.kcal)} | <b>KM:</b> ${Math.round(dash.km)} | <b>Dias:</b> ${dash.done}/${dash.goal}</div>
      `;
      if($("perfilBox")) $("perfilBox").innerHTML = html;
    }

    /***********************
     * 13) Init
     ***********************/
    function refreshAllUI(){
      applyProfileToUI();
      buildSportsChips();
      syncTemaTreinoOptions();
      applyAvatar();
      loadLastPlate();
      renderHistory();

      // dieta e treino salvos
      const savedDieta = safeJSON(KEY_DIETA);
      if(savedDieta) renderDieta(savedDieta);

      const savedTreino = safeJSON(KEY_TREINO);
      if(savedTreino) renderTreino(savedTreino);

      // convites
      renderInviteUI();

      // dash
      renderDash();

      updatePerfilBox();
    }

    function init(){
      wireNav();
      wireAvatarInput();
      wirePlateInput();

      if($("welcomeStatus")){
        $("welcomeStatus").textContent = "‚úÖ Dica: se algo n√£o atualizar, limpe o cache do site e recarregue.";
      }

      const isGuest = !!localStorage.getItem(KEY_GUEST);
      if(isGuest){
        setAuthBadge("Modo: Local");
        showNav(true);
        showOnly("viewCadastro");
      }else{
        showNav(false);
        showOnly("viewWelcome");
      }

      initFirebaseIfPossible();
      refreshAllUI();
    }

    init();
  </script>
</body>
</html>
